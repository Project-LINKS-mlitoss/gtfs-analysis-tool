{% load static %}
<link rel="shortcut icon" type="image/png" href="{% static 'favicon.png' %}" />
<script>
    const open_key = "{{ oid }}";
    const pref = "{{ pref }}";
    const selData = {{selData|safe}};

    let basic2theme = 1;
    let basic2year = 2020;

    let basic3radio = "総数";

    let basic4mode = 2;
    let basic4maxwd = 300;
    let basic4hour = 5;
    let basic4minute = 0;
    let da_setting = 1;
    let basic4timemode = 0;

    let cl2pl_flag = false;
    let layerAccordionMap = new Map();
    let layer小地域年齢Map = new Map();
    let isochronemode = false;
    let history = new Set();

    let printPaperSize = "A4";

    let csvLoaded_advance1 = false;
    let csvLoaded_advance2 = false;
    let csvName_advance1 = "";
    let csvName_advance2 = "";

    let selected_service_id = "";
    let initial_service_id = "";
    let basic1ChartResizeObserver;
    let advance2_start_stopname = "";
    let advance2_start_val = 0;
    const tooltipOptions200 = {
        customClass: "from-opt",
    };
</script>
<svg class="d-none" xmlns="http://www.w3.org/2000/svg" id="filters">
    <filter id="grayscale-alpha">
        <feColorMatrix
            type="matrix"
            values="0.2126 0.7152 0.0722 0 0
                                         0.2126 0.7152 0.0722 0 0
                                         0.2126 0.7152 0.0722 0 0
                                         0      0      0      0.5 0"
        />
    </filter>
</svg>
<div id="dummy_graph_basic1"></div>
<div id="dummy_graph_advance1a"></div>
<div id="dummy_graph_advance1b"></div>
<div id="top_row" class="row align-items-bottom">
    <div class="col-auto">
        <img id="title_img" src="/static/app/img/logo20241031.png" width="199px" height="55px" style="margin-left: 10px" alt="公共交通分析ツール" />
    </div>
    <div class="col-auto d-flex align-items-bottom flex-grow-1">
        <nav class="navbar navbar-expand-xl navbar-light p-0">
            <div class="container-fluid p-0">
                <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#main-menu" aria-controls="main-menu" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon" onclick=""></span>
                </button>
                <div class="offcanvas offcanvas-start" id="main-menu">
                    <div class="offcanvas-header">
                        <h6 class="offcanvas-title" id="offcanvasNavbarLabel">Menu</h6>
                        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                    </div>
                    <div class="offcanvas-body">
                        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                            <li class="nav-item flex-shrink-0">
                                <a
                                    class="nav-link"
                                    id="gtfs-button"
                                    data-bs-title="GTFSデータを本ツールに読み込みます。<br />GTFSデータは、公共交通機関の運行情報を標準化したフォーマットで提供されます。"
                                    data-bs-html="true"
                                    data-bs-toggle="tooltip"
                                    data-bs-placement="bottom"
                                    >GTFSデータの読み込み</a
                                >
                            </li>
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="menu_basic_analysis" role="button" data-bs-toggle="dropdown" aria-expanded="false"> 基本的な分析 </a>
                                <ul class="dropdown-menu" aria-labelledby="menu_basic_analysis">
                                    <li>
                                        <a
                                            class="dropdown-item"
                                            href="#"
                                            id="basic1"
                                            data-bs-title="鉄道及びバスの運行頻度を地図上に表示します。"
                                            data-bs-html="true"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="right"
                                            >運行頻度図の可視化</a
                                        >
                                    </li>
                                    <li>
                                        <a
                                            class="dropdown-item"
                                            href="#"
                                            id="basic3"
                                            data-bs-title="国勢調査より居住地別の利用交通手段をメッシュで地図上に表示します。"
                                            data-bs-html="true"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="right"
                                            >交通分担の可視化</a
                                        >
                                    </li>
                                    <li>
                                        <a
                                            class="dropdown-item"
                                            href="#"
                                            id="basic4a"
                                            data-bs-title="選択した地点から到達する範囲をバッファで地図上に表示します。"
                                            data-bs-html="true"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="right"
                                            >到達圏域分析（バッファ）の可視化</a
                                        >
                                    </li>
                                    <li>
                                        <a
                                            class="dropdown-item"
                                            href="#"
                                            id="basic4b"
                                            data-bs-title="選択した地点から、道路ネットワークを用いてバスと徒歩を組み合わせた到達圏域を導出します"
                                            data-bs-html="true"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="right"
                                            >到達圏域分析（ネットワーク）の可視化</a
                                        >
                                    </li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="menu_advance_analysis1" role="button" data-bs-toggle="dropdown" aria-expanded="false"> 乗降実績の可視化 </a>
                                <ul class="dropdown-menu" aria-labelledby="menu_advance_analysis1">
                                    <li>
                                        <a
                                            class="dropdown-item"
                                            href="#"
                                            id="advance1"
                                            data-bs-title="バスや鉄道の乗降実績データ（utf-8 CSV形式）を読み込みます。<br />読み込むデータのカラムは下記です。<br />date, agency_id, route_id, trip_id, stop_id, stop_sequence, count_geton, count_getoff"
                                            data-bs-html="true"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="right"
                                            >乗降実績データの読み込み</a
                                        >
                                    </li>
                                    <li>
                                        <a
                                            class="dropdown-item"
                                            href="#"
                                            id="advance1a"
                                            data-bs-title="乗降実績データより、停留所別乗降実績（乗車数・降車数・乗車中人数）を可視化します。<br />なお、この分析を使用するためには乗降実績データの読み込みが必要になります。"
                                            data-bs-html="true"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="right"
                                            >停留所別乗降実績の可視化</a
                                        >
                                    </li>
                                    <li>
                                        <a
                                            class="dropdown-item"
                                            href="#"
                                            id="advance1b"
                                            data-bs-title="バスの乗客の時間帯別乗降実績（乗車数・降車数・乗車中人数）を可視化します。<br />なお、この分析を利用するには乗降実績データの読み込みが必要になります。"
                                            data-bs-html="true"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="right"
                                            >時間帯別乗降実績の可視化</a
                                        >
                                    </li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="menu_advance_analysis2" role="button" data-bs-toggle="dropdown" aria-expanded="false"> ODデータの可視化 </a>
                                <ul class="dropdown-menu" aria-labelledby="menu_advance_analysis2">
                                    <li>
                                        <a
                                            class="dropdown-item"
                                            href="#"
                                            id="advance2_r"
                                            data-bs-title="起点と終点の移動ODデータ（utf-8 CSV形式）を読み込みます。<br />読み込むデータのカラムは下記です。<br />date, agency_id, route_id, stopid_geton, stopid_getoff, count"
                                            data-bs-html="true"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="right"
                                            >ODデータの読み込み</a
                                        >
                                    </li>
                                    <li>
                                        <a
                                            class="dropdown-item"
                                            href="#"
                                            id="advance2_3"
                                            data-bs-title="ODデータより、利用者の分布を地図上に表示します。<br />なお、この分析を利用するにはODデータの読み込みが必要になります。"
                                            data-bs-html="true"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="right"
                                            >OD利用者分布の可視化</a
                                        >
                                    </li>
                                    <li>
                                        <a
                                            class="dropdown-item"
                                            href="#"
                                            id="advance2"
                                            data-bs-title="ODデータより、特定の起点や終点停留所からの移動数を地図上に表示します。<br />なお、この分析を利用するにはODデータの読み込みが必要になります。"
                                            data-bs-html="true"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="right"
                                            >起点/終点からのOD流動図の可視化</a
                                        >
                                    </li>
                                    <li>
                                        <a
                                            class="dropdown-item"
                                            href="#"
                                            id="advance2_2"
                                            data-bs-title="ODデータより、停留所間の移動データを地図上に表示します。<br />なお、この分析を利用するにはODデータの読み込みが必要になります。"
                                            data-bs-html="true"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="right"
                                            >バス停間ODの可視化</a
                                        >
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>
        <div id="mode_exit" class="border border-dark ms-2 d-flex flex-column justify-content-center align-items-center d-none">
            <label id="mode_info" style="font-weight: bold; font-size: 0.8em" class="text-center">表示中：運行頻度図の可視化</label>
            <button id="mode_exit_button" style="font-size: 0.9em; background-color: #1a9086; color: #ffffff; border: none; user-select: none; padding: 2px; width: 190px" class="">
                分析結果クリア
            </button>
        </div>
    </div>
    <div class="col-auto d-flex justify-content-end align-items-center">
        <div class="btn-group">
            <div
                class="rightmenu-right text-nowrap d-flex align-self-end align-items-center pl-1 pr-1"
                id="linklabel_about"
                data-bs-title="読み込み済データの情報を表示します。"
                data-bs-html="true"
                data-bs-toggle="tooltip"
                data-bs-placement="bottom"
            >
                読み込み済データ
            </div>
            <div
                class="rightmenu-right text-nowrap d-flex align-self-end align-items-center"
                id="linklabel_export"
                data-bs-title="図形データをGeoJSON形式ファイル、統計データをCSV形式ファイルで出力します。"
                data-bs-html="true"
                data-bs-toggle="tooltip"
                data-bs-placement="bottom"
            >
                エクスポート
            </div>
            <div
                class="rightmenu-right text-nowrap d-flex align-self-end align-items-center"
                id="linklabel_print"
                data-bs-title="印刷用のPDF形式ファイルを出力します。"
                data-bs-html="true"
                data-bs-toggle="tooltip"
                data-bs-placement="bottom"
            >
                プリント
            </div>
            <div
                class="rightmenu text-nowrap d-flex align-self-end align-items-center"
                id="linklabel_help"
                data-bs-title="ヘルプを表示します。"
                data-bs-html="true"
                data-bs-toggle="tooltip"
                data-bs-placement="bottom"
            >
                ヘルプ
            </div>
        </div>
    </div>
</div>
<div id="content-wrapper" style="position: relative">
    <div id="middle_row" class="row">
        <div id="left_panel" class="col-3">
            <div id="layer-switcher-div"></div>
        </div>
        <div id="map_panel" class="col-6" name="rrow" style="background-color: #ffffff">
            <div id="map_overlay" data-bs-toggle="tooltip" data-bs-title=" " data-bs-placement="right"></div>
            <div id="map"><div id="info"></div></div>
            <div
                class="ui-resizable-handle ui-resizable-e"
                id="egrip"
                data-bs-title="ドラッグでリサイズできます（画面の25％より幅を狭めることはできません）"
                data-bs-toggle="tooltip"
                data-bs-placement="left"
            ></div>
        </div>
        <div id="bottom_row" class="col-3">
            <div id="legendTitle">凡例</div>

            <div id="legend-accordion"></div>
            <div id="legendCtl" data-bs-title="凡例を折り畳みます" data-bs-toggle="tooltip" data-bs-placement="left"><img id="legend_ctl_img" src="/static/app/img/legend_fold.png" /></div>

            <div id="click_info" class="scroll-div" style="margin-top: 7px"></div>
        </div>
    </div>

    <div id="overlay_panel" class="overlay_panel">
        <div id="overlay_outer" class="outer_div">
            <div class="row">
                <div class="col-3">
                </div>
                <div class="col-9 p-0">
                    <div id="overlay_inner" class="container-fluid d-flex flex-column p-0">
                        <div class="row h-auto">
                            <div class="col-12 p-1">
                                <h5 id="inner_title"></h5>
                                <h6 id="inner_title2"></h6>
                            </div>
                        </div>

                        <div id="inner_content_container" class="row flex-grow-1 overflow-y-scroll">
                            <div id="inner_content" class="col-12"></div>
                        </div>

                        <div class="row align-items-center" style="height: 60px">
                            <div class="col-12 text-end">
                                <button id="overlay_inner_button1" class="btn btn-primary">出力</button>
                                <button id="overlay_inner_button2" class="btn btn-light">戻る</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="popup" class="ol-popup">
    <a href="#" id="popup-closer" class="ol-popup-closer"></a>
    <div id="popup-content" class="ol-popup-content"></div>
</div>

<form id="gtfs-download-form" method="post" action="/api/gtfs_download">{% csrf_token %}</form>

<div id="load_overlay">
    <div class="loader"></div>
</div>

<div class="layer_settings_panel"></div>

<link rel="stylesheet" href="{% static 'node_modules/bootstrap/dist/css/bootstrap.css' %}" />
<link rel="stylesheet" href="{% static 'node_modules/ol/ol.css' %}" />
<link rel="stylesheet" href="{% static 'node_modules/ol-ext/dist/ol-ext.min.css' %}" />
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" />
<script src="{% static 'node_modules/jquery/dist/jquery.min.js' %}"></script>

<script
    src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.10.2/umd/popper.min.js"
    integrity="sha512-nnzkI2u2Dy6HMnzMIkh7CPd1KX445z38XIu4jG1jGw7x5tSL3VBjE44dY4ihMU1ijAQV930SPM12cCFrB18sVw=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
></script>

<script src="{% static 'node_modules/bootstrap/dist/js/bootstrap.js' %}"></script>
<script src="{% static 'node_modules/datatables.net/js/dataTables.min.js' %}"></script>
<script src="{% static 'node_modules/ol/dist/ol.js' %}"></script>
<script src="{% static 'node_modules/ol-ext/dist/ol-ext.js' %}"></script>
<script src="{% static 'node_modules/@turf/turf/turf.min.js' %}"></script>

<script src="{% static 'node_modules/chart.js/dist/chart.umd.js' %}"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
<link rel="stylesheet" href="{% static 'app/site.css' %}" />
<script>
    function setContentWrapperHeight() {
        const topRow = document.getElementById("top_row");
        const middleRow = document.getElementById("middle_row");
        const bottomRow = document.getElementById("bottom_row");
        const contentWrapper = document.getElementById("content-wrapper");
        const map_div = document.getElementById("map");
        const layer = document.getElementById("layer-switcher-div");
        const overlay_outer = document.getElementById("overlay_outer");
        const overlay_inner = document.getElementById("overlay_inner");
        const mapPanel = document.getElementById("map_panel");
        const mapOvl = document.getElementById("map_overlay");
        const eGrip = document.getElementById("egrip");

        const borderBuffer = 1;

        if (topRow && middleRow && bottomRow && contentWrapper) {
            contentWrapper.style.height = `${window.innerHeight - topRow.offsetHeight}px`;
            map_div.style.height = `${window.innerHeight - topRow.offsetHeight}px`;
            layer.style.height = `${window.innerHeight - topRow.offsetHeight}px`;
        }
        mapPanel.style.height = `${window.innerHeight - topRow.offsetHeight}px`;
        mapOvl.style.height = `${window.innerHeight - topRow.offsetHeight}px`;
        eGrip.style.height = `${window.innerHeight - topRow.offsetHeight}px`;

        computeBottomRowWidth();
        computeClickInfoHeight();

        if (overlay_inner) {
            const divStyles = window.getComputedStyle(overlay_outer);
            if (divStyles) {
                overlay_inner.style.height = `${contentWrapper.offsetHeight - parseFloat(divStyles.top) - parseFloat(divStyles.bottom) - parseFloat(divStyles.paddingTop) * 2 - borderBuffer}px`;
            }
        }
    }
    const computeBottomRowWidth = () => {
        const paddings = remToPixels(1.5) * 2;
        const limit = window.innerWidth * 0.25;

        $("#map_panel").width(window.innerWidth - $("#left_panel").innerWidth() - $("#bottom_row").innerWidth());

        if (window.innerWidth - $("#map_panel").innerWidth() - $("#left_panel").innerWidth() <= limit) {
            $("#map_panel").width(window.innerWidth - $("#left_panel").innerWidth() - limit);
        }
        let newWidth = window.innerWidth - $("#map_panel").innerWidth() - $("#left_panel").innerWidth();

        $("#bottom_row").width(newWidth - paddings);
        $("#click_info").css("width", $("#bottom_row").width());
    };
    const computeClickInfoHeight = () => {
        const topRow = document.getElementById("top_row");
        const middleRow = document.getElementById("middle_row");
        const bottomRow = document.getElementById("bottom_row");
        const click_info = document.getElementById("click_info");
        const legend_div = document.getElementById("legend-accordion");
        const legendTitle = document.getElementById("legendTitle");
        const legendCtl = document.getElementById("legendCtl");
        const paddings = remToPixels(1.5);

        $("#legend-accordion").css("maxHeight", bottomRow.offsetHeight * 0.45);
        $("#click_info").css("width", $("#bottom_row").width());
        const borderBuffer = 10;
        if (click_info) {
            click_info.style.height = `${window.innerHeight - topRow.offsetHeight - legend_div.offsetHeight - borderBuffer - legendTitle.offsetHeight - legendCtl.offsetHeight}px`;
        }
    };

    window.addEventListener("resize", setContentWrapperHeight);
    window.addEventListener("load", setContentWrapperHeight);

    let menu_mode = "";

    const container = document.getElementById("popup");
    const closer = document.getElementById("popup-closer");

    const info_closer = document.getElementById("info-closer");
    const info_route_container = document.getElementById("info-route-content");
    const info_route_closer = document.getElementById("info-route-closer");

    const overlay = new ol.Overlay({
        element: container,
        autoPan: {
            animation: {
                duration: 250,
            },
        },
    });
    closer.onclick = () => {
        overlay.setPosition(undefined);
        closer.blur();
        return false;
    };

    const offcanvasNavbar = document.getElementById("main-menu");
    const offcanvas = new bootstrap.Offcanvas(offcanvasNavbar);

    const basic1 = document.getElementById("basic1");
    const basic3 = document.getElementById("basic3");
    const advance1 = document.getElementById("advance1");
    const advance1a = document.getElementById("advance1a");
    const advance1b = document.getElementById("advance1b");
    const advance2_r = document.getElementById("advance2_r");
    const advance2 = document.getElementById("advance2");
    const advance2_2 = document.getElementById("advance2_2");
    const advance2_3 = document.getElementById("advance2_3");
    const basic4a = document.getElementById("basic4a");
    const basic4b = document.getElementById("basic4b");
    const externalexport = document.getElementById("linklabel_export");
    const menu_basic_analysis = document.getElementById("menu_basic_analysis");
    const menu_advance_analysis1 = document.getElementById("menu_advance_analysis1");
    const menu_advance_analysis2 = document.getElementById("menu_advance_analysis2");

    const mode_exit = document.getElementById("mode_exit");
    const mode_exit_button = document.getElementById("mode_exit_button");
    const mode_info = document.getElementById("mode_info");

    const overlay_panel = document.getElementById("overlay_panel");
    const top_row = document.getElementById("top_row");

    const layerToggle = document.getElementById("layer-toggle-btn");
    const menu_print = document.getElementById("linklabel_print");

    const dgbasic1 = document.getElementById("dummy_graph_basic1");
    const dgadvance1a = document.getElementById("dummy_graph_advance1a");
    const dgadvance1b = document.getElementById("dummy_graph_advance1b");

    const collapseElement = document.getElementById("main-menu");
    collapseElement.addEventListener("shown.bs.collapse", () => {
        setContentWrapperHeight();
    });
    collapseElement.addEventListener("hidden.bs.collapse", () => {
        setContentWrapperHeight();
    });
    menu_basic_analysis.addEventListener("shown.bs.dropdown", (event) => {
        onbasic();
        setContentWrapperHeight();
    });
    menu_basic_analysis.addEventListener("hidden.bs.dropdown", (event) => {
        setContentWrapperHeight();
    });
    menu_advance_analysis1.addEventListener("shown.bs.dropdown", (event) => {
        onadvance1();
        setContentWrapperHeight();
    });
    menu_advance_analysis1.addEventListener("hidden.bs.dropdown", (event) => {
        setContentWrapperHeight();
    });
    menu_advance_analysis2.addEventListener("shown.bs.dropdown", (event) => {
        onadvance2();
        setContentWrapperHeight();
    });
    menu_advance_analysis2.addEventListener("hidden.bs.dropdown", (event) => {
        setContentWrapperHeight();
    });
    const onbasic = () => {
        menu_basic_analysis.classList.add("cp_active");
        menu_advance_analysis1.classList.remove("cp_active");
        menu_advance_analysis2.classList.remove("cp_active");

        if (isochronemode) isochronemode = false;
        overlay_panel.style.display = "none";
        return false;
    };
    const onadvance1 = () => {
        menu_basic_analysis.classList.remove("cp_active");
        menu_advance_analysis1.classList.add("cp_active");
        menu_advance_analysis2.classList.remove("cp_active");

        if (isochronemode) isochronemode = false;
        overlay_panel.style.display = "none";
        return false;
    };

    const onadvance2 = () => {
        menu_basic_analysis.classList.remove("cp_active");
        menu_advance_analysis1.classList.remove("cp_active");
        menu_advance_analysis2.classList.add("cp_active");

        if (isochronemode) isochronemode = false;
        overlay_panel.style.display = "none";
        return false;
    };
    basic1.onclick = () => {
        onbasic();
        offcanvas.hide();
        clearOnMenuClick();

        menu_mode = "basic1";

        overlay.setPosition(undefined);
        map.removeLayer(到達圏域LayerGroup);
        map.getLayers().forEach((lyr) => {
            clearLayerVisible(lyr);
        });
        if (basic2theme == 1) {
            layer_鉄道輸送密度B.setVisible(true);
        } else {
            layer_鉄道輸送密度A.setVisible(true);
        }
        運行頻度図LayerGroup.setVisible(true);

        aggregator_routesLayerGroup.setVisible(true);
        aggregator_routesLayerTexts.setVisible(true);
        aggregator_routesLayerLines.setVisible(true);
        layer_rail_運行本数合計.setVisible(true);
        railroadLayerGroup2.setVisible(false);
        人口総数Layer.setVisible(true);
        populatedLayerGroup5.setVisible(true);
        人口総数Layer5.setVisible(true);
        layer_aggregator_stops.setVisible(true);
        busLayerGroup_setVisible(true);
        地理院Layer.setVisible(true);
        baseLayerGroup.setVisible(true);

        $("#mode_exit").removeClass("d-none");
        $("#mode_info").text("表示中：運行頻度図の可視化");
        $("#mode_exit_button").text("分析結果クリア");
        history.add("運行頻度図");
        isochronemode = false;

        set_operation_frequency();

        return false;
    };
    basic3.onclick = () => {
        onbasic();
        offcanvas.hide();
        clearOnMenuClick();

        menu_mode = "basic3";

        const arg =
            "<fieldset class='fs-border'>" +
            "    <legend class='col-form-label fs-border'>利用交通手段</legend>" +
            "    <input type='radio' id='rb交通分担率01' name='basic3radio' value='総数' style='margin-top:12px;' " +
            (basic3radio == "総数" ? " checked" : "") +
            ">" +
            "    <label for='rb交通分担率01' style='margin-left:4px;'>総数</label>" +
            "    <br />" +
            "    <input type='radio' id='rb交通分担率02' name='basic3radio' value='徒歩のみ'" +
            (basic3radio == "徒歩のみ" ? " checked" : "") +
            ">" +
            "    <label for='rb交通分担率02' style='margin-left:4px;'>徒歩のみ</label>" +
            "    <br />" +
            "    <input type='radio' id='rb交通分担率03' name='basic3radio' value='鉄道_電車'" +
            (basic3radio == "鉄道_電車" ? " checked" : "") +
            ">" +
            "    <label for='rb交通分担率03' style='margin-left:4px;'>鉄道・電車</label>" +
            "    <br />" +
            "    <input type='radio' id='rb交通分担率04' name='basic3radio' value='乗合バス'" +
            (basic3radio == "乗合バス" ? " checked" : "") +
            ">" +
            "    <label for='rb交通分担率04' style='margin-left:4px;'>乗合バス</label>" +
            "    <br />" +
            "    <input type='radio' id='rb交通分担率05' name='basic3radio' value='勤め先_学校のバス'" +
            (basic3radio == "勤め先_学校のバス" ? " checked" : "") +
            ">" +
            "    <label for='rb交通分担率05' style='margin-left:4px;'>勤め先・学校のバス</label>" +
            "    <br />" +
            "    <input type='radio' id='rb交通分担率06' name='basic3radio' value='自家用車'" +
            (basic3radio == "自家用車" ? " checked" : "") +
            ">" +
            "    <label for='rb交通分担率06' style='margin-left:4px;'>自家用車</label>" +
            "    <br />" +
            "    <input type='radio' id='rb交通分担率07' name='basic3radio' value='ハイヤー_タクシー'" +
            (basic3radio == "ハイヤー_タクシー" ? " checked" : "") +
            ">" +
            "    <label for='rb交通分担率07' style='margin-left:4px;'>ハイヤー・タクシー</label>" +
            "    <br />" +
            "    <input type='radio' id='rb交通分担率08' name='basic3radio' value='オートバイ'" +
            (basic3radio == "オートバイ" ? " checked" : "") +
            ">" +
            "    <label for='rb交通分担率08' style='margin-left:4px;'>オートバイ</label>" +
            "    <br />" +
            "    <input type='radio' id='rb交通分担率09' name='basic3radio' value='自転車'" +
            (basic3radio == "自転車" ? " checked" : "") +
            ">" +
            "    <label for='rb交通分担率09' style='margin-left:4px;'>自転車</label>" +
            "    <br />" +
            "    <input type='radio' id='rb交通分担率10' name='basic3radio' value='その他'" +
            (basic3radio == "その他" ? " checked" : "") +
            ">" +
            "    <label for='rb交通分担率10' style='margin-left:4px;'>その他</label>" +
            "    <br />" +
            "    <input type='radio' id='rb交通分担率11' name='basic3radio' value='利用交通手段不詳'" +
            (basic3radio == "利用交通手段不詳" ? " checked" : "") +
            ">" +
            "    <label for='rb交通分担率11' style='margin-left:4px;'>利用交通手段不詳</label>" +
            "</fieldset>";

        setPanelInfo("交通分担の可視化", "表示するデータを指定してください", arg);
        $("#overlay_inner_button1").off("click");
        $("#overlay_inner_button1").click((e) => {
            basic3radio = $("input[name='basic3radio']:checked").val();

            運行頻度図LayerGroup.setVisible(false);

            overlay.setPosition(undefined);
            map.removeLayer(到達圏域LayerGroup);
            到達圏域python.setVisible(false);
            到達圏域otp.setVisible(false);
            markerLayer.setVisible(false);

            layer_stops.setVisible(false);
            layer_aggregator_stops.setVisible(true);
            routesLayerGroup.setVisible(false);
            routesLayerGroup
                .getLayers()
                .getArray()
                .forEach((lyr) => {
                    lyr.setVisible(false);
                });
            busLayerGroup_setVisible(true);

            aggregator_routesLayerGroup.setVisible(false);
            facilityLayerGroup.setVisible(false);
            railroadLayerGroup.setVisible(true);

            railroadLayerGroup2.setVisible(false);
            railroadLayerGroup3.setVisible(false);
            odLayerGroup.setVisible(false);
            populatedLayerGroup.setVisible(false);
            populatedLayerGroup5.setVisible(false);
            小地域年齢LayerGroup.setVisible(false);
            layer_rail_routes_name.setVisible(false);
            layer_rail_stops_name.setVisible(false);
            利用交通手段LayerGroup.getLayers().forEach(function (layer, i) {
                layer.setVisible(false);
            });
            switch (basic3radio) {
                case "総数":
                    利用交通手段_総数Layer.setVisible(true);
                    break;
                case "徒歩のみ":
                    利用交通手段_徒歩のみLayer.setVisible(true);
                    break;
                case "鉄道_電車":
                    利用交通手段_鉄道電車Layer.setVisible(true);
                    break;
                case "乗合バス":
                    利用交通手段_乗合バスLayer.setVisible(true);
                    break;
                case "勤め先_学校のバス":
                    利用交通手段_勤め先学Layer.setVisible(true);
                    break;
                case "自家用車":
                    利用交通手段_自家用車Layer.setVisible(true);
                    break;
                case "ハイヤー_タクシー":
                    利用交通手段_ハイヤーLayer.setVisible(true);
                    break;
                case "オートバイ":
                    利用交通手段_オートバイLayer.setVisible(true);
                    break;
                case "自転車":
                    利用交通手段_自転車Layer.setVisible(true);
                    break;
                case "その他":
                    利用交通手段_その他Layer.setVisible(true);
                    break;
                case "利用交通手段不詳":
                    利用交通手段_不詳Layer.setVisible(true);
                    break;
            }

            利用交通手段LayerGroup.setVisible(true);

            baseLayerGroup.getLayers().forEach(function (layer, i) {
                layer.setVisible(false);
            });
            地理院Layer.setVisible(true);
            baseLayerGroup.setVisible(true);

            overlay_panel.style.display = "none";

            $("#mode_exit").removeClass("d-none");
            $("#mode_info").text("表示中：交通分担の可視化");
            $("#mode_exit_button").text("分析結果クリア");
            history.add("交通分担");
        });
        return false;
    };

    advance1.onclick = () => {
        onadvance1();
        offcanvas.hide();
        menu_mode = "advance1";

        const arg =
            "<div class='' style='background-color:white;margin:30px;padding:10px;height:180px;text-align:center;'>" +
            "    <br />" +
            "    <h6>データをアップロードしてください</h6>" +
            "    <div class='input-group'>" +
            "      <input type='file' class='form-control' id='fileInput_advance1' accept='.csv'>" +
            "    </div>" +
            "    <div class='mt-3'>" +
            "        <button id='csv1-upload-ok' class='csv-upload-OK'>OK</button>" +
            "        <button id='csv1-upload-cancel' class='csv-upload-Cancel'>キャンセル</button>" +
            "    </div>" +
            "</div>";

        setCSVPanelInfo("実績データ読み込み", "アップロードする実績データを指定してください", arg);
        $("#csv1-upload-ok").off("click");
        $("#csv1-upload-ok").click(async (e) => {
            const file = $("#fileInput_advance1")[0].files[0];
            if (!file) {
                alert("ファイルが選択されていません。");
                return;
            }
            csvName_advance1 = file.name;

            $("#load_overlay").show();
            const formData = new FormData();
            formData.append("file", file);

            try {
                const response = await fetch(`/api/jisseki_csv_upload/${open_key}`, {
                    method: "POST",
                    body: formData,
                    headers: {
                        "X-CSRFToken": getCookie("csrftoken"),
                    },
                    credentials: "include",
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.message != "OK") {
                    csvLoaded_advance1 = false;
                    alert(result.message);
                    $("#load_overlay").hide();
                    return;
                }

                csvLoaded_advance1 = true;
                alert("CSVデータのアップロードが完了しました。");

                overlay.setPosition(undefined);
                map.removeLayer(到達圏域LayerGroup);
                map.getLayers().forEach((lyr) => {
                    clearLayerVisible(lyr);
                });
                if (basic2theme == 1) {
                    layer_鉄道輸送密度B.setVisible(true);
                } else {
                    layer_鉄道輸送密度A.setVisible(true);
                }
                railroadLayerGroup2.setVisible(false);
                routesLayerGroup.getLayers().forEach((lyr) => {
                    lyr.setVisible(true);
                });
                busLayerGroup_setVisible(true);

                layer_aggregator_stops.setVisible(true);
                地理院Layer.setVisible(true);
                baseLayerGroup.setVisible(true);

                $("#click_info").empty();

                history.add("実績データ読み込み");
                isochronemode = false;

                $("#overlay_inner_button2").click();
            } catch (error) {
                console.error("Upload failed:", error);
                alert("アップロードに失敗しました。もう一度お試しください。");
            }
            $("#load_overlay").hide();
        });

        $("#csv1-upload-cancel").off("click");
        $("#csv1-upload-cancel").click((e) => {
            $("#overlay_inner_button2").click();
        });

        return false;
    };

    const formatDateToYYYYMMDD = (dateInput) => {
        const days = ["日", "月", "火", "水", "木", "金", "土"];
        let daystr = `${dateInput.slice(0, 4)}/${dateInput.slice(4, 6)}/${dateInput.slice(6, 8)}`;
        let date = new Date(daystr);
        return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()} (${days[date.getDay()]})`;
    };

    advance1a.onclick = async () => {
        overlay.setPosition(undefined);
        if (csvLoaded_advance1 == false) {
            alert("実績データの読み込みを行ってください。");
            return;
        }
        onadvance1();
        offcanvas.hide();
        clearOnMenuClick();

        menu_mode = "advance1a";

        overlay.setPosition(undefined);
        map.removeLayer(到達圏域LayerGroup);
        map.getLayers().forEach((lyr) => {
            clearLayerVisible(lyr);
        });
        if (basic2theme == 1) {
            layer_鉄道輸送密度B.setVisible(true);
        } else {
            layer_鉄道輸送密度A.setVisible(true);
        }
        layer_aggregator_stops.setVisible(true);
        railroadLayerGroup2.setVisible(false);
        routesLayerGroup.setVisible(true);
        routesLayerGroup.getLayers().forEach(function (layer, i) {
            layer.setVisible(true);
        });
        busLayerGroup_setVisible(true);
        地理院Layer.setVisible(true);
        baseLayerGroup.setVisible(true);
        実績数表示Layer.setVisible(true);

        $("#click_info").empty();

        let days_url = `/api/get_jisseki_days/${open_key}`;
        const days_response = await fetch(days_url);
        if (!days_response.ok) throw new Error(`Network response was not ok [${open_key}]`);
        let days_res = await days_response.json();

        let days_select = '<select name="advance1a_days" class="form-select form-select-sm">';
        for (let i = 0; i < days_res.days.length; i++) {
            days_select += `<option value="${days_res.days[i]}">${days_res.days_f[i]}</option>`;
        }
        days_select += "</select>";

        let routes_url = `/api/get_jisseki_routes2/${open_key}/${days_res.days[0]}`;
        const routes_response = await fetch(routes_url);
        if (!routes_response.ok) throw new Error(`Network response was not ok [${open_key}]`);
        let routes_res = await routes_response.json();

        let routes_select = '<select name="advance1a_routes" class="form-select form-select-sm">';
        for (let i = 0; i < routes_res.routes.length; i++) {
            let short_name = routes_res.routes[i].route_short_name;
            let long_name = routes_res.routes[i].route_long_name;
            if (long_name == "nan") long_name = "";
            if (short_name == "nan") short_name = "";
            if (long_name == "") long_name = short_name;
            routes_select += `<option value="${routes_res.routes[i].route_id}">[${routes_res.routes[i].route_id}] ${long_name}</option>`;
        }
        routes_select += "</select>";

        let directions_url = `/api/get_jisseki_directions/${open_key}`;
        const directions_response = await fetch(directions_url);
        if (!directions_response.ok) throw new Error(`Network response was not ok [${open_key}]`);
        let directions_res = await directions_response.json();

        let directions_list = `
            <tr id='directions_tr'>
                <td>方向</td>
                <td>
                    <label>
                        <input type="radio" name="advance1a_direction" value="0" checked />
                        往路
                    </label>
                    <label>
                        <input type="radio" name="advance1a_direction" value="1" />
                        復路
                    </label>
                </td>
            </tr>
        `;
        if (directions_res.directions.length == 1) {
            directions_list = "<input type='hidden' name='advance1a_direction' value='0' />";
        }

        let time_range_select = '<select name="advance1a_time_range" class="" disabled>';
        for (let i = 5; i < 23; i++) {
            time_range_select += `<option value="${i}" ${i == 7 ? "selected" : ""}>${i}時</option>`;
        }
        time_range_select += "</select>";

        let panel_info = `
            <div id='advance1a_legend'></div>
            <div id='advance1a_stops_panel' style="border: 1px #999 solid; padding: 5px">
                <label>　<input type="radio" name="stops_jisseki_onoff" value="-1" checked>乗車中人数</label><br />
                <label>　<input type="radio" name="stops_jisseki_onoff" value="0">乗車人数</label><br />
                <label>　<input type="radio" name="stops_jisseki_onoff" value="1">降車人数</label>
            </div>
            <div class='advance1a_menu'>
                <div class='direction_div'>
                    <table>
                        <tr>
                            <td>日にち</td>
                            <td>${days_select}</td>
                        </tr>
                        <tr>
                            <td>タイムレンジ</td>
                            <td>
                                <label>
                                    <input type="radio" name="advance1a_time" value="0" checked>
                                    全日
                                </label>
                                <label>
                                    <input type="radio" name="advance1a_time" value="1">
                                    時間帯別
                                </label>
                                ${time_range_select}
                                <label>
                                    <input type="radio" name="advance1a_time" value="2">
                                    便別
                                </label>
                            </td>
                        </tr>
                        <tr>
                            <td>ルート</td>
                            <td>${routes_select}</td>
                        </tr>
                        ${directions_list}
                    </table>
            </div>
            <div id='advance1a_graph'></div>
            `;
        $("#click_info").append(panel_info);

        $(document).off("change", "[name=advance1a_days]");
        $(document).on("change", "[name=advance1a_days]", async (e) => {
            let days = $("[name=advance1a_days]").val();
            let routes_url = `/api/get_jisseki_routes2/${open_key}/${days}`;
            const routes_response = await fetch(routes_url);
            if (!routes_response.ok) throw new Error(`Network response was not ok [${open_key}]`);
            let routes_res = await routes_response.json();

            let routes_select = $("<select/>", {
                name: "advance1a_routes",
                class: "form-select form-select-sm",
            });
            let bk = $('select[name="advance1a_routes"]').val();
            $.each(routes_res.routes, function (i, route) {
                let short_name = route.route_short_name;
                let long_name = route.route_long_name;
                if (long_name == "nan") long_name = "";
                if (short_name == "nan") short_name = "";
                if (long_name == "") long_name = short_name;

                $("<option/>", {
                    value: route.route_id,
                    text: `[${route.route_id}] ${long_name}`,
                }).appendTo(routes_select);
            });
            $('select[name="advance1a_routes"]').empty().append(routes_select.children());
            $('select[name="advance1a_routes"]').val(bk);
            advance1a_graph();
        });
        $(document).off("change", "[name=advance1a_time]");
        $(document).on("change", "[name=advance1a_time]", (e) => {
            if ($("[name=advance1a_time]:checked").val() == "1") {
                $("[name=advance1a_time_range]").prop("disabled", false);
            } else {
                $("[name=advance1a_time_range]").prop("disabled", true);
            }
            advance1a_graph();
        });
        $(document).off("change", "[name=advance1a_time_range]");
        $(document).on("change", "[name=advance1a_time_range]", (e) => {
            advance1a_graph();
        });
        $(document).off("change", "[name=advance1a_routes]");
        $(document).on("change", "[name=advance1a_routes]", (e) => {
            advance1a_graph();
        });
        $(document).off("change", "[name=advance1a_direction]");
        $(document).on("change", "[name=advance1a_direction]", (e) => {
            advance1a_graph();
        });
        $(document).off("change", "[name=stops_jisseki_onoff]");
        $(document).on("change", "[name=stops_jisseki_onoff]", (e) => {
            advance1a_graph();
        });
        advance1a_graph();

        $("#mode_exit").removeClass("d-none");
        $("#mode_info").text("表示中：停留所別乗降実績");
        $("#mode_exit_button").text("分析結果クリア");
        history.add("停留所別乗降実績");
        isochronemode = false;

        return false;
    };

    const show_route_info_list = async (route_names) => {
        let routes_list = "";

        $("#load_overlay").show();
        try {
            for (const route of route_names) {
                let route_url = `/api/get_route_ids/${open_key}/${route}`;
                let route_response = await fetch(route_url);
                if (!route_response.ok) throw new Error(`Network response was not ok [${open_key}]`);
                let route_res = await route_response.json();
                for (const r of route_res) {
                    let stops_url = `/api/get_route_to_stop_ids/${open_key}/${r.route_id}`;
                    let stops_response = await fetch(stops_url);
                    if (!stops_response.ok) throw new Error(`Network response was not ok [${open_key}]`);
                    let stops_res = await stops_response.json();

                    routes_list += `<h6>route_id: ${r.route_id}</h6>`;
                    routes_list += "<span>この路線の停留所一覧</span>";
                    routes_list += "<table class='table table-sm table-striped table-bordered'>";
                    routes_list += "<tr><th>stop_id</th><th>stop_name</th></tr>";
                    for (const stop of stops_res) {
                        routes_list += `<tr><td>${stop.stop_id}</td><td class="stop-name" data-stop-id="${stop.stop_id}">${stop.stop_name}</td></tr>`;
                    }
                    routes_list += "</table>";
                }
            }
        } catch (error) {
            console.error(error);
        }
        $("#click_info").html(routes_list);
        $("#load_overlay").hide();
        $(document).off("click", ".stop-name");
        $(document).on("click", ".stop-name", function (e) {
            const stopId = $(this).data("stop-id");
            zoomToAggregatorStop(stopId);
        });
    };
    const zoomToAggregatorStop = (stopId) => {
        fetch(`/api/get_aggr_stop_id_from_stop_id/${open_key}/${stopId}`)
            .then((response) => response.json())
            .then((data) => {
                if (data.error) {
                    console.error(data.error);
                } else {
                    const wkt = data.wkt;
                    const format = new ol.format.WKT();
                    const feature = format.readFeature(wkt);
                    const geometry = feature.getGeometry();
                    const center = ol.extent.getCenter(geometry.transform("EPSG:4326", "EPSG:3857").getExtent());
                    map.getView().setCenter(center);
                    map.getView().setZoom(18);
                }
            });
    };
    const zoomToAggregatorStop2 = (stopName) => {
        fetch(`/api/get_aggr_stop_id_from_stop_name/${open_key}/${stopName}`)
            .then((response) => response.json())
            .then((data) => {
                if (data.error) {
                    console.error(data.error);
                } else {
                    if (menu_mode == "advance2_2" && layer_aggregator_stops.getVisible() == false) layer_aggregator_stops.setVisible(true);
                    const wkt = data.wkt;
                    const format = new ol.format.WKT();
                    const feature = format.readFeature(wkt);
                    const geometry = feature.getGeometry();
                    const center = ol.extent.getCenter(geometry.transform("EPSG:4326", "EPSG:3857").getExtent());
                    map.getView().setCenter(center);
                    map.getView().setZoom(18);
                }
            });
    };
    const zoomToStop = (stopId) => {
        const features = layer_stops.getSource().getFeatures();
        let targetFeature = null;
        features.forEach((feature) => {
            if (feature.get("stop_id") === stopId) {
                targetFeature = feature;
            }
        });

        if (targetFeature) {
            const geometry = targetFeature.getGeometry();
            const extent = geometry.getExtent();
            map.getView().fit(extent, {
                padding: [50, 50, 50, 50],
                duration: 500,
                maxZoom: 18,
            });
        } else {
            console.error("stop_id not found:", stopId);
        }
    };
    const zoomTo_advance2Stop = (stopName) => {
        const features = odLayerUpload.getSource().getFeatures();
        let targetFeature = null;
        features.forEach((feature) => {
            if (feature.get("stopname") === stopName) {
                targetFeature = feature;
            }
        });

        if (targetFeature) {
            const geometry = targetFeature.getGeometry();
            const extent = geometry.getExtent();
            map.getView().fit(extent, {
                padding: [50, 50, 50, 50],
                maxZoom: 18,
            });
        } else {
            console.error("stop_name not found:", stopName);
        }
    };
    const advance1a_popup = async (stop) => {
        if (stop.length == 0) {
            overlay.setPosition(undefined);
            return;
        }
        let days = $("[name=advance1a_days]").val();
        let time = $("[name=advance1a_time]:checked").val();
        let time_range = $("[name=advance1a_time_range]").val();
        let routes = $("[name=advance1a_routes]").val();
        let direction = $("[name=advance1a_direction]:checked").val() || $("[name=advance1a_direction]").val();

        let url = `/api/get_jisseki_graph/${open_key}/${days}/${time}/${time_range}/${routes}/${direction}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Network response was not ok [${open_key}]`);
        let r = await response.json();

        if (r.data == undefined) {
            let advance1a_pn_text = `<code>停留所名 : ${stop[0].stopname}</code><br />`;
            advance1a_pn_text += "データなし";
            $("#popup-content").html(advance1a_pn_text);
            return;
        }

        let stop_ids = await aggr_stop_id_to_stop_ids(stop[0].stopid);
        const uniqueStopIds = [...new Set(stop_ids.map((item) => item.stop_id))];

        let sorted_data = r.data.sort((a, b) => {
            if (a.trip_id < b.trip_id) return -1;
            if (a.trip_id > b.trip_id) return 1;
            return a.stop_sequence - b.stop_sequence;
        });

        let current_trip_id = "";
        let current_during_ride = 0;
        sorted_data.forEach((item) => {
            if (current_trip_id != item.trip_id) {
                current_trip_id = item.trip_id;
                current_during_ride = 0;
            }
            current_during_ride += item.count_geton - item.count_getoff;
            item.during_ride = current_during_ride;
        });

        let filted_rdata = sorted_data.filter((item) => uniqueStopIds.some((stop_id) => stop_id === item.stop_id));

        let latlon_grouped = sorted_data.reduce((grouped, item) => {
            const key = `${item.stop_sequence}`;
            if (!grouped[key]) {
                grouped[key] = {
                    items: [],
                    stop_id: "",
                    stop_name: "",
                    total_count_geton: 0,
                    total_count_getoff: 0,
                    total_during_ride: 0,
                };
            }
            grouped[key].items.push(item);
            grouped[key].stop_id = item.stop_id;
            grouped[key].stop_name = item.stop_name;
            grouped[key].total_count_geton += item.count_geton || 0;
            grouped[key].total_count_getoff += item.count_getoff || 0;
            grouped[key].total_during_ride += item.during_ride || 0;
            return grouped;
        }, {});

        let entries = Object.entries(latlon_grouped);

        let during_ride = 0;
        entries.forEach(([key, group]) => {
            during_ride += group.total_count_geton - group.total_count_getoff;
            group.total_during_ride = during_ride;
        });
        filted_entries = entries.filter(([key, group]) => uniqueStopIds.some((item) => item === group.stop_id));
        let onoff_mode = $("[name=stops_jisseki_onoff]:checked").val();
        let advance1a_pn_text = `<code>停留所名 : ${stop[0].stopname}</code><br />`;
        let trip_by_total = 0;
        if (onoff_mode == "-1") {
            if (filted_entries.length > 0) {
                advance1a_pn_text += "この停留所で乗車中のtrip_id一覧<br />";
                filted_entries.forEach((item) => {
                    item[1].items.forEach((item2) => {
                        if (item2.during_ride > 0) {
                            advance1a_pn_text += `${item2.trip_id} : ${item2.during_ride} 人<br />`;
                            trip_by_total += item2.during_ride;
                        }
                    });
                });
            } else {
                advance1a_pn_text += "データなし";
            }
        }
        if (onoff_mode == "0") {
            if (filted_rdata.length > 0) {
                advance1a_pn_text += "この停留所で乗車するtrip_id一覧<br />";
                filted_rdata.forEach((item) => {
                    if (item.count_geton > 0) advance1a_pn_text += `${item.trip_id} : ${item.count_geton} 人<br />`;
                });
            } else {
                advance1a_pn_text += "データなし";
            }
        }
        if (onoff_mode == "1") {
            if (filted_rdata.length > 0) {
                advance1a_pn_text += "この停留所で降車するtrip_id一覧<br />";
                filted_rdata.forEach((item) => {
                    if (item.count_getoff > 0) advance1a_pn_text += `${item.trip_id} : ${item.count_getoff} 人<br />`;
                });
            } else {
                advance1a_pn_text += "データなし";
            }
        }

        if (entries.length > 0) {
            entries.forEach(([key, group]) => {
                if (!uniqueStopIds.some((item) => item === group.stop_id)) return;

                if (onoff_mode == "-1") advance1a_pn_text += `<br />乗車中の合計人数 : ${trip_by_total} 人`;
                if (onoff_mode == "0") advance1a_pn_text += `<br />合計乗車人数 : ${group.total_count_geton} 人`;
                if (onoff_mode == "1") advance1a_pn_text += `<br />合計降車人数 : ${group.total_count_getoff} 人`;
            });
        }
        $("#popup-content").html(advance1a_pn_text);
        if (advance1a_pn_text == "") overlay.setPosition(undefined);
    };

    const advance1a_graph = async () => {
        overlay.setPosition(undefined);
        let days = $("[name=advance1a_days]").val();
        let time = $("[name=advance1a_time]:checked").val();
        let time_range = $("[name=advance1a_time_range]").val();
        let routes = $("[name=advance1a_routes]").val();
        let direction = $("[name=advance1a_direction]:checked").val() || $("[name=advance1a_direction]").val();

        let url = `/api/get_jisseki_graph/${open_key}/${days}/${time}/${time_range}/${routes}/${direction}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Network response was not ok [${open_key}]`);
        let r = await response.json();

        if (r.data == undefined) {
            let 実績数表示LayerSource = new ol.source.Vector();
            実績Icon表示Layer.setSource(実績数表示LayerSource);
            実績Icon表示Layer.getSource().clear();
            実績数表示Layer.setSource(実績数表示LayerSource);
            実績数表示LayerSource.clear();
            $("#advance1a_graph").html("<div><p style='padding:10px;'>データなし</p></div>");
            $("#advance1a_legend").html("");

            layer_aggregator_stops
                .getSource()
                .getFeatures()
                .forEach((f) => {
                    f.set("selected", false);
                    f.set("advance1a_mode", false);
                    f.set("advance1b_mode", false);
                    f.setStyle(
                        new ol.style.Style({
                            image: new ol.style.RegularShape({
                                fill: new ol.style.Fill({
                                    color: "rgba(255, 94, 91, 1.0)",
                                }),
                                stroke: new ol.style.Stroke({
                                    color: "#ffffff",
                                    width: 1,
                                }),
                                points: 4,
                                radius: 4,
                                angle: 0,
                            }),
                        })
                    );
                });
            return;
        }

        let trip_grouped = r.data.reduce((grouped, item) => {
            (grouped[item.trip_id] = grouped[item.trip_id] || []).push(item);
            return grouped;
        }, {});

        const advance1a_graph_div = document.getElementById("advance1a_graph");
        advance1a_graph_div.innerHTML = "<img id='trip_filter' src='/static/app/img/trip_filter.png' style='width: 25px; float:right; cursor:pointer;' /><h5>停留所別乗降実績</h5>";

        let trip_filter =
            "<div id='advance1a_filter_div' style='display: none;'><table style='width: 100%;'>" +
            "<tr><td style='width:auto;'>" +
            "<datalist id='trip_filter_select' name='trip_filter_select' class='form-select form-select-sm' style='display: none;'>";

        trip_filter += `<option value="全て">全て</option>`;
        Object.keys(trip_grouped).forEach((key) => {
            if (key == "nan") return;
            trip_filter += `<option value="${key}">${key}</option>`;
        });
        trip_filter += "</datalist>";
        trip_filter += '<input list="trip_filter_select" id="trip_filter_select_input" name="trip_filter_select_input" autocomplete="off" class="form-select form-select-sm">';
        trip_filter += '</td><td style="width:85px;"><button id="advance1a-filter-btn" class="fltr-button-a1a">絞り込み</button></td></tr></table></div>';
        advance1a_graph_div.innerHTML += trip_filter;
        advance1a_graph_div.innerHTML += "<div id='advance1a_panel'></div>";

        $(document).off("change", "#trip_filter");
        $("#trip_filter").click((e) => {
            $("#advance1a_filter_div").toggle();
            computeClickInfoHeight();
        });
        $(document).off("change", "#advance1a-filter-btn");
        $("#advance1a-filter-btn").click((e) => {
            advance1a_graph_sub(r);
        });
        advance1a_graph_sub(r);
    };

    const advance1a_graph_sub = async (r) => {
        let routes = $("[name=advance1a_routes]").val();
        const advance1a_graph_div = document.getElementById("advance1a_panel");
        advance1a_graph_div.innerHTML = "";

        r.data.sort((a, b) => {
            if (a.trip_id < b.trip_id) return -1;
            if (a.trip_id > b.trip_id) return 1;
            return a.stop_sequence - b.stop_sequence;
        });

        let trip_grouped = r.data.reduce((grouped, item) => {
            (grouped[item.trip_id] = grouped[item.trip_id] || []).push(item);
            return grouped;
        }, {});

        let time = $("[name=advance1a_time]:checked").val();
        let hour = parseInt($("[name=advance1a_time_range]").val()) * 10000;
        Object.entries(trip_grouped).forEach(([key, item]) => {
            item.sort((a, b) => {
                if (a.trip_id < b.trip_id) return -1;
                if (a.trip_id > b.trip_id) return 1;
                return a.stop_sequence - b.stop_sequence;
            });

            let last_trip_id = "";
            let during_ride = 0;
            item.forEach((entry) => {
                if (last_trip_id != entry.trip_id) {
                    last_trip_id = entry.trip_id;
                    during_ride = 0;
                }
                var t = "" + entry.departure_time;
                if (t.includes(":")) entry.departure_time = parseInt(entry.departure_time.replaceAll(":", ""));
                during_ride += entry.count_geton - entry.count_getoff;
                entry.during_ride = during_ride;
            });

            if (time == "1") {
                trip_grouped[key] = item.filter((entry) => {
                    return hour <= entry.departure_time && entry.departure_time < hour + 10000;
                });
            }
        });

        let e_sum = Object.values(trip_grouped)
            .flat()
            .reduce((acc, curr) => {
                if (!acc[curr.stop_id]) {
                    acc[curr.stop_id] = {
                        trip_id: "全て",
                        similar_stop_id: curr.similar_stop_id,
                        stop_id: curr.stop_id,
                        stop_name: curr.stop_name,
                        latitude: curr.latitude,
                        longitude: curr.longitude,
                        stop_sequence: curr.stop_sequence,
                        count_geton: 0,
                        count_getoff: 0,
                        during_ride: 0,
                    };
                }
                acc[curr.stop_id].count_geton += curr.count_geton || 0;
                acc[curr.stop_id].count_getoff += curr.count_getoff || 0;
                acc[curr.stop_id].during_ride += curr.during_ride || 0;
                return acc;
            }, {});
        trip_grouped["全て"] = Object.values(e_sum);

        let trip_filter = $("[name=trip_filter_select_input]").val();
        if (trip_filter == "") trip_filter = "全て";

        if (time == "0") {
            let tmp = {};
            tmp[trip_filter] = trip_grouped[trip_filter];
            trip_grouped = tmp;
        }
        if (time == "1" && trip_filter != "全て") {
            let tmp = {};
            tmp[trip_filter] = trip_grouped[trip_filter];
            trip_grouped = tmp;
        }


        dgadvance1a.innerHTML = "";
        let id_suffix = 1;
        for (const [key, item] of Object.entries(trip_grouped)) {
            if (time == "2" && key == "全て") continue;
            if (!item) continue;
            if (item.length == 0) continue;

            item.sort((a, b) => {
                if (a.trip_id < b.trip_id) return -1;
                if (a.trip_id > b.trip_id) return 1;
                return a.stop_sequence - b.stop_sequence;
            });

            let labels = item.map((entry) => entry.stop_name);
            let 乗車数 = item.map((entry) => entry.count_geton);
            let 降車数 = item.map((entry) => entry.count_getoff);
            let 乗車中人数 = item.map((entry) => entry.during_ride);

            let firstStopId = "";
            let firstStopName = "";
            let lastStopId = "";
            let lastStopName = "";
            let route_short_name = "";
            let route_long_name = "";

            let get_startend_url = "/api/get_route_start_end_jisseki/" + open_key + "/" + initial_service_id + "/" + routes + "/" + (key == "全て" ? "-1" : key);

            const startend_response = await fetch(get_startend_url);
            if (!startend_response.ok) throw new Error(`Network response was not ok [${open_key}]`);
            let startend_res = await startend_response.json();
            firstStopId = startend_res.first_stop.stop_id;
            firstStopName = startend_res.first_stop.stop_name;
            lastStopId = startend_res.last_stop.stop_id;
            lastStopName = startend_res.last_stop.stop_name;
            route_short_name = startend_res.route_short_name;
            route_long_name = startend_res.route_long_name;
            const graph_div = document.createElement("div");
            graph_div.innerHTML =
                `<span>Trip_id: ${key}</span><br />` +
                `<span>route_id: ${routes}</span><br />` +
                `<span>route_short_name: ${route_short_name}</span><br />` +
                `<span>route_long_name: ${route_long_name}</span><br />` +
                `<span>始点のstop_name: ${firstStopName}</span><br />` +
                `<span>終点のstop_name: ${lastStopName}</span><br />` +
                `<button class='map-button-a1a' name='trip_filter_btn' id='trip_filter_btn${id_suffix} ' trip_key='${key}'>このルートを地図上で表示</button>`;
            id_suffix += 1;

            advance1a_graph_div.appendChild(graph_div);
            const canvas = document.createElement("canvas");
            graph_div.appendChild(canvas);
            const ctx = canvas.getContext("2d");
            new Chart(ctx, {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [
                        { label: "乗車数", data: 乗車数 },
                        { label: "降車数", data: 降車数 },
                        { label: "乗車中人数", data: 乗車中人数, type: "line" },
                    ],
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: false,
                                text: "バス停",
                            },
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: "人数",
                            },
                            ticks: {
                                stepSize: 1,
                            },
                        },
                    },
                },
            });

            const hiddenCanvas = document.createElement("canvas");
            hiddenCanvas.style.display = "none";
            hiddenCanvas.width = 1900;
            hiddenCanvas.height = 540;
            hiddenCanvas.classList.add("hidden-chart");
            dgadvance1a.appendChild(hiddenCanvas);
            const hiddenCtx = hiddenCanvas.getContext("2d");
            new Chart(hiddenCtx, {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [
                        { label: "乗車数", data: 乗車数 },
                        { label: "降車数", data: 降車数 },
                        { label: "乗車中人数", data: 乗車中人数, type: "line" },
                    ],
                },
                options: {
                    animation: false,
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: false,
                                text: "バス停",
                            },
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: "人数",
                            },
                            ticks: {
                                stepSize: 1,
                            },
                        },
                    },
                },
            });

            let 乗車数sum = 乗車数.reduce((a, b) => a + b, 0);
            let 乗車数max = Math.max(...乗車数);
            let 乗車数avg = 乗車数sum / 乗車数.length;

            let 降車数sum = 降車数.reduce((a, b) => a + b, 0);
            let 降車数max = Math.max(...降車数);
            let 降車数avg = 降車数sum / 降車数.length;

            let 乗車中人数sum = 乗車中人数.reduce((a, b) => a + b, 0);
            let 乗車中人数max = Math.max(...乗車中人数);
            let 乗車中人数avg = 乗車中人数sum / 乗車中人数.length;

            const table_div = document.createElement("div");
            let table_str = "<table class='table table-sm table-bordered'>";
            table_str += "<tr style='font-size: 0.8rem;'><th></th><th>乗車人数</th><th>降車人数</th><th>乗車中人数</th></tr>";
            table_str += "<tr><td>平均</td><td>" + Math.round(乗車数avg) + "</td><td>" + Math.round(降車数avg) + "</td><td>" + Math.round(乗車中人数avg) + "</td></tr>";
            table_str += "<tr><td>最大</td><td id='max_geton'>" + 乗車数max + "</td><td id='max_getoff'>" + 降車数max + "</td><td id='max_getsum'>" + 乗車中人数max + "</td></tr>";
            table_str += "<tr><td>合計</td><td>" + 乗車数sum + "</td><td>" + 降車数sum + "</td><td>－</td></tr>";
            table_str += "</table>";
            table_div.innerHTML = table_str;
            graph_div.appendChild(table_div);
        }

        let max_during_ride = Math.max(
            ...Object.values(trip_grouped)
                .flat()
                .map((g) => g.during_ride)
        );
        let max_geton = Math.max(
            ...Object.values(trip_grouped)
                .flat()
                .map((g) => g.count_geton)
        );
        let max_getoff = Math.max(
            ...Object.values(trip_grouped)
                .flat()
                .map((g) => g.count_getoff)
        );

        let legend_table = "<table class='table table-sm table-bordered'>";
        legend_table += "<tr><th colspan='2'>乗車中人数</th><th colspan='2'>乗車人数</th><th colspan='2'>降車人数</th></tr>";
        let during95 = Math.round(max_during_ride * 0.95);
        let geton95 = Math.round(max_geton * 0.95);
        let getoff95 = Math.round(max_getoff * 0.95);
        legend_table += "<tr>";
        legend_table += "<td>" + (isFinite(during95) ? during95 : "-") + "以上</td><td style='background-color:#FF9600;'></td>";
        legend_table += "<td>" + (isFinite(geton95) ? geton95 : "-") + "以上</td><td style='background-color:#1761EB;'></td>";
        legend_table += "<td>" + (isFinite(getoff95) ? getoff95 : "-") + "以上</td><td style='background-color:#F20000;'></td>";
        legend_table += "</tr>";
        let during85 = Math.round(max_during_ride * 0.85);
        let geton85 = Math.round(max_geton * 0.85);
        let getoff85 = Math.round(max_getoff * 0.85);
        legend_table += "<tr>";
        legend_table += "<td>" + (isFinite(during85) ? during85 : "-") + "</td><td style='background-color:#FFAA33;'></td>";
        legend_table += "<td>" + (isFinite(geton85) ? geton85 : "-") + "</td><td style='background-color:#3875EA;'></td>";
        legend_table += "<td>" + (isFinite(getoff85) ? getoff85 : "-") + "</td><td style='background-color:#EA2B2B;'></td>";
        legend_table += "</tr>";
        let during70 = Math.round(max_during_ride * 0.7);
        let geton70 = Math.round(max_geton * 0.7);
        let getoff70 = Math.round(max_getoff * 0.7);
        legend_table += "<tr>";
        legend_table += "<td>" + (isFinite(during70) ? during70 : "-") + "</td><td style='background-color:#FFBC61;'></td>";
        legend_table += "<td>" + (isFinite(geton70) ? geton70 : "-") + "</td><td style='background-color:#608EEA;'></td>";
        legend_table += "<td>" + (isFinite(getoff70) ? getoff70 : "-") + "</td><td style='background-color:#F25757;'></td>";
        legend_table += "</tr>";
        let during50 = Math.round(max_during_ride * 0.5);
        let geton50 = Math.round(max_geton * 0.5);
        let getoff50 = Math.round(max_getoff * 0.5);
        legend_table += "<tr>";
        legend_table += "<td>" + (isFinite(during50) ? during50 : "-") + "</td><td style='background-color:#FFCE8A;'></td>";
        legend_table += "<td>" + (isFinite(geton50) ? geton50 : "-") + "</td><td style='background-color:#89ABEB;'></td>";
        legend_table += "<td>" + (isFinite(getoff50) ? getoff50 : "-") + "</td><td style='background-color:#EA7B7E;'></td>";
        legend_table += "</tr>";
        legend_table += "<tr>";
        legend_table += "<td>0</td><td style='background-color:#FFDEB3;'></td>";
        legend_table += "<td>0</td><td style='background-color:#80C1EA;'></td>";
        legend_table += "<td>0</td><td style='background-color:#E9A5A8;'></td>";
        legend_table += "</tr>";
        legend_table += "</table>";
        $("#advance1a_legend").html(legend_table);

        const entries = Object.entries(trip_grouped);

        if (entries.length == 0) {
            $("#advance1a_graph").html("<div><p style='padding:10px;'>データなし</p></div>");
            $("#advance1a_legend").html("");
            実績Icon表示Layer.getSource().clear();
            overlay.setPosition(undefined);
            layer_aggregator_stops
                .getSource()
                .getFeatures()
                .forEach((f) => {
                    f.set("selected", false);
                    f.set("advance1a_mode", false);
                    f.set("advance1b_mode", false);
                });
            return;
        }

        let 実績数表示LayerSource = new ol.source.Vector();
        実績数表示Layer.setSource(実績数表示LayerSource);
        実績数表示LayerSource.clear();

        if (time == "2" && trip_filter != "全て") {
            let tmp = {};
            tmp[trip_filter] = trip_grouped[trip_filter];
            trip_grouped = tmp;
        }
        実績Icon表示Layer.getSource().clear();
        layer_aggregator_stops
            .getSource()
            .getFeatures()
            .forEach((f) => {
                f.setStyle(
                    new ol.style.Style({
                        image: new ol.style.RegularShape({
                            fill: new ol.style.Fill({
                                color: "rgba(255, 94, 91, 1.0)",
                            }),
                            stroke: new ol.style.Stroke({
                                color: "#ffffff",
                                width: 1,
                            }),
                            points: 4,
                            radius: 4,
                            angle: 0,
                        }),
                    })
                );

                let pick_item = Object.values(trip_grouped)
                    .flat()
                    .find((item) => item.similar_stop_id == f.get("similar_stop_id"));
                if (pick_item) {
                    let c1_lonlat = ol.proj.fromLonLat([pick_item.longitude, pick_item.latitude]);
                    if ($("[name=stops_jisseki_onoff]:checked").val() == "-1") {
                        let next_item = Object.values(trip_grouped)
                            .flat()
                            .find((item) => item.stop_sequence == pick_item.stop_sequence + 1);
                        if (next_item) {
                            c1_lonlat = ol.proj.fromLonLat([(pick_item.longitude + next_item.longitude) / 2, (pick_item.latitude + next_item.latitude) / 2]);
                        }
                    }
                    実績数表示LayerSource.addFeature(
                        new ol.Feature({
                            geometry: new ol.geom.Point(c1_lonlat),
                            properties: {
                                count_geton: pick_item.count_geton,
                                count_getoff: pick_item.count_getoff,
                                during_ride: pick_item.during_ride,
                            },
                        })
                    );

                    let max_target = max_during_ride;
                    let during_ride = pick_item.during_ride;

                    if ($("[name=stops_jisseki_onoff]:checked").val() == "0") {
                        max_target = max_geton;
                        during_ride = pick_item.count_geton;
                    }
                    if ($("[name=stops_jisseki_onoff]:checked").val() == "1") {
                        max_target = max_getoff;
                        during_ride = pick_item.count_getoff;
                    }
                    let point_color = "255";
                    if ($("[name=stops_jisseki_onoff]:checked").val() == "-1") {
                        point_color = "#FF9600";
                        if ((during_ride / max_target) * 100 < 95) point_color = "#FFAA33";
                        if ((during_ride / max_target) * 100 < 85) point_color = "#FFBC61";
                        if ((during_ride / max_target) * 100 < 70) point_color = "#FFCE8A";
                        if ((during_ride / max_target) * 100 < 50) point_color = "#FFDEB3";
                    }
                    if ($("[name=stops_jisseki_onoff]:checked").val() == "0") {
                        point_color = "#1761EB";
                        if ((during_ride / max_target) * 100 < 95) point_color = "#3875EA";
                        if ((during_ride / max_target) * 100 < 85) point_color = "#608EEA";
                        if ((during_ride / max_target) * 100 < 70) point_color = "#89ABEB";
                        if ((during_ride / max_target) * 100 < 50) point_color = "#80C1EA";
                    }
                    if ($("[name=stops_jisseki_onoff]:checked").val() == "1") {
                        point_color = "#F20000";
                        if ((during_ride / max_target) * 100 < 95) point_color = "#EA2B2B";
                        if ((during_ride / max_target) * 100 < 85) point_color = "#F25757";
                        if ((during_ride / max_target) * 100 < 70) point_color = "#EA7B7E";
                        if ((during_ride / max_target) * 100 < 50) point_color = "#E9A5A8";
                    }
                    f.set("advance1a_mode", true);
                    f.setStyle(
                        new ol.style.Style({
                            image: new ol.style.RegularShape({
                                fill: new ol.style.Fill({
                                    color: point_color,
                                }),
                                stroke: new ol.style.Stroke({
                                    color: "#ffffff",
                                    width: 2,
                                }),
                                points: 4,
                                radius: 7,
                                angle: 0,
                            }),
                        })
                    );
                    実績Icon表示Layer.getSource().addFeature(f);
                }
            });
        実績数表示Layer.setVisible(true);
        実績Icon表示Layer.setVisible(true);

        $("button[name='trip_filter_btn']").click((e) => {
            $("#trip_filter_select_input").val($(e.target).attr("trip_key"));
            $("#advance1a-filter-btn").click();
            if (実績数表示LayerSource.getFeatures().length > 0) {
                map.getView().fit(実績数表示Layer.getSource().getExtent());
                if (map.getView().getZoom() > 18) {
                    map.getView().setZoom(18);
                }
            }
        });
        if ($("#trip_filter_btn1")) $("#trip_filter_btn1").click();
    };

    advance1b.onclick = async () => {
        overlay.setPosition(undefined);
        if (csvLoaded_advance1 == false) {
            alert("実績データの読み込みを行ってください。");
            return;
        }
        onadvance1();
        offcanvas.hide();
        clearOnMenuClick();

        menu_mode = "advance1b";

        overlay.setPosition(undefined);
        map.removeLayer(到達圏域LayerGroup);
        map.getLayers().forEach((lyr) => {
            clearLayerVisible(lyr);
        });
        if (basic2theme == 1) {
            layer_鉄道輸送密度B.setVisible(true);
        } else {
            layer_鉄道輸送密度A.setVisible(true);
        }
        layer_aggregator_stops.setVisible(true);
        地理院Layer.setVisible(true);
        baseLayerGroup.setVisible(true);

        $("#click_info").empty();

        let days_url = `/api/get_jisseki_days/${open_key}`;
        const days_response = await fetch(days_url);
        if (!days_response.ok) throw new Error(`Network response was not ok [${open_key}]`);
        let days_res = await days_response.json();

        let days_select = '<select name="advance1b_days" class="form-select form-select-sm">';
        for (let i = 0; i < days_res.days.length; i++) {
            days_select += `<option value="${days_res.days[i]}">${days_res.days_f[i]}</option>`;
        }
        days_select += "</select>";

        let panel_info = `
            <div id='advance1b_legend'></div>
            <div class='advance1a_menu'>
                <div class='direction_div'>
                    <table class='table table-sm'>
                        <tr>
                            <td style='vertical-align: middle;'>日にち</td>
                            <td>${days_select}</td>
                        </tr>
                    </table>
                </div>
            </div>
            <div id='advance1b_stops_panel' style="border: 1px #999 solid; padding: 5px">
                <label>　<input type="radio" name="stops_jisseki_onoff" value="-1" checked>乗車中人数</label><br />
                <label>　<input type="radio" name="stops_jisseki_onoff" value="0">乗車人数</label><br />
                <label>　<input type="radio" name="stops_jisseki_onoff" value="1">降車人数</label>
            </div>
            <div id='advance1b_graph'></div>
            `;
        $("#click_info").append(panel_info);

        $(document).off("change", "[name=stops_jisseki_onoff]");
        $(document).on("change", "[name=stops_jisseki_onoff]", (e) => {
            overlay.setPosition(undefined);
            update_agg_route_source_time();
            if ($("[name=stops_jisseki_onoff]:checked").val() == "-1") {
                advance1b_graph([]);
            } else {
                advance1b_graph_point([]);
            }
        });
        $(document).off("change", "[name=advance1b_days]");
        $(document).on("change", "[name=advance1b_days]", (e) => {
            overlay.setPosition(undefined);
            update_agg_route_source_time();
            if ($("[name=stops_jisseki_onoff]:checked").val() == "-1") {
                advance1b_graph([]);
            } else {
                advance1b_graph_point([]);
            }
        });
        overlay.setPosition(undefined);
        update_agg_route_source_time();
        if ($("[name=stops_jisseki_onoff]:checked").val() == "-1") {
            advance1b_graph([]);
        } else {
            advance1b_graph_point([]);
        }

        $("#mode_exit").removeClass("d-none");
        $("#mode_info").text("表示中：時間帯別乗降実績");
        $("#mode_exit_button").text("分析結果クリア");
        history.add("時間帯別乗降実績");
        isochronemode = false;

        return false;
    };
    const get_datefilter_service_ids = async () => {
        let days = $("[name=advance1b_days]").val();
        let url = `/api/get_datefilter_service_ids/${open_key}/${days}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Network response was not ok [${open_key}]`);
        let r = await response.json();
        return r.service_ids;
    };
    const update_agg_route_source_time = async () => {
        let service_ids = await get_datefilter_service_ids();
        let time = -1;
        aggregator_routesLayerTexts.setVisible(false);
        aggregator_routesLayerLines.setSource(
            new ol.source.Vector({
                format: new ol.format.GeoJSON(),
                url: (extent) => {
                    let url =
                        "/geoserver/traffic_info/wfs?" +
                        "service=WFS&" +
                        "version=1.1.0&" +
                        "request=GetFeature&" +
                        "typename=traffic_info:app_aggregator_routes&" +
                        "outputFormat=application/json&" +
                        "srsname=EPSG:3857&" +
                        `CQL_FILTER=file_name='${open_key}' and hour='-1'`;
                    return url;
                },
                strategy: ol.loadingstrategy.bbox,
            })
        );
        運行頻度図LayerGroup.setVisible(true);
        aggregator_routesLayerGroup.setVisible(true);
        aggregator_routesLayerLines.setVisible(true);
        railroadLayerGroup2.setVisible(false);
        updateSpecialLegend("運行頻度図（バス）", false);
    };

    const advance1b_graph_point = async (stop_names) => {
        $("#advance1b_graph").empty();
        let days = $("[name=advance1b_days]").val();

        let advance1b_graph_div = document.getElementById("advance1b_graph");
        if (!advance1b_graph_div) return;
        advance1b_graph_div.innerHTML = "<img id='trip_filter' src='/static/app/img/trip_filter.png' style='width: 25px; float:right; cursor:pointer;' /><h5 class='mt-1'>時間帯別乗降実績</h5>";

        let time = -1;
        let time_range = -1;
        let routes = "all";
        let direction = -1;
        let url = `/api/get_jisseki_graph/${open_key}/${days}/${time}/${time_range}/${routes}/${direction}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Network response was not ok [${open_key}]`);
        let r = await response.json();
        let filter_data = r.data;

        if (stop_names.length > 0) {
            filter_data = filter_data.filter((item) => item.similar_stop_id == stop_names[0][0]);
        }
        let route_grouped = filter_data.reduce((grouped, item) => {
            (grouped[item.route_id] = grouped[item.route_id] || []).push(item);
            return grouped;
        }, {});

        let trip_filter = '<div name="filter_panel" class="btn-group" style="width: 100%; display: none;">';
        trip_filter += "<datalist id='trip_filter_select_2b' name='trip_filter_select_2b' class='form-select form-select-sm' style='display: none;'>";
        trip_filter += `<option value="全て">全て</option>`;
        Object.keys(route_grouped).forEach((key) => {
            if (key == "nan") return;
            trip_filter += `<option value="${key}">${key}</option>`;
        });
        trip_filter += "</datalist>";
        trip_filter += '<input list="trip_filter_select_2b" id="trip_filter_select_input" name="trip_filter_select_input" autocomplete="off" class="form-control form-control-sm">';
        trip_filter += "<button id='advance1b-filter-btn' class='fltr-button-a1a' style='min-width: 80px;'>絞り込み</button>";
        trip_filter += "</div>";
        advance1b_graph_div.innerHTML += trip_filter;
        advance1b_graph_div.innerHTML += "<div id='advance1b_graph_panel'></div>";

        let sortedArray = r.data.sort((a, b) => {
            if (a.trip_id < b.trip_id) return -1;
            if (a.trip_id > b.trip_id) return 1;
            return a.stop_sequence - b.stop_sequence;
        });

        const getLeftOffsetCoordinate = (lon1, lat1, lon2, lat2, offset_distance = 0.0001) => {
            let zoom = map.getView().getZoom();
            offset_distance = offset_distance / Math.pow(2, zoom - 5);

            let p1 = ol.proj.fromLonLat([lon1, lat1]);
            let p2 = ol.proj.fromLonLat([lon2, lat2]);

            let dx = p2[0] - p1[0];
            let dy = p2[1] - p1[1];

            let length = Math.sqrt(dx * dx + dy * dy);
            if (length === 0) return [lon1, lat1];

            let nx = -dy / length;
            let ny = dx / length;

            let new_x = p1[0] - nx * offset_distance;
            let new_y = p1[1] - ny * offset_distance;

            return ol.proj.toLonLat([new_x, new_y]);
        };

        let 実績数Features = [];
        let 乗車中人数 = 0;
        for (let i = 0; i < sortedArray.length - 1; i++) {
            let prev = sortedArray[i];
            let next = sortedArray[i + 1];
            if (prev.trip_id != next.trip_id) {
                乗車中人数 = 0;
                continue;
            }

            let c1_lonlat = ol.proj.fromLonLat(getLeftOffsetCoordinate(prev.centroid_longitude, prev.centroid_latitude, next.centroid_longitude, next.centroid_latitude, 120));
            let c2_lonlat = ol.proj.fromLonLat([next.centroid_longitude, next.centroid_latitude]);

            if ($("[name=stops_jisseki_onoff]:checked").val() == "-1") {
                c1_lonlat = [(c1_lonlat[0] + c2_lonlat[0]) / 2, (c1_lonlat[1] + c2_lonlat[1]) / 2];

                let org_lonlat = ol.proj.fromLonLat([prev.centroid_longitude, prev.centroid_latitude]);
                c1_lonlat = [(c1_lonlat[0] * 5 + org_lonlat[0]) / 6, (c1_lonlat[1] * 5 + org_lonlat[1]) / 6];
            }
            乗車中人数 += prev.count_geton - prev.count_getoff;
            実績数Features.push({
                prev_id: prev.similar_stop_id,
                next_id: next.similar_stop_id,
                prev_org_id: prev.stop_id,
                next_org_id: next.stop_id,
                trip_id: prev.trip_id,
                stop_sequence: prev.stop_sequence,
                longitude: c1_lonlat[0],
                latitude: c1_lonlat[1],
                count_geton: prev.count_geton,
                count_getoff: prev.count_getoff,
                during_ride: 乗車中人数,
            });
        }
        let latlon_grouped = 実績数Features.reduce((grouped, item) => {
            const key = `latlon_${item.prev_id}_${item.next_id}_${item.latitude}_${item.longitude}`;
            if (!grouped[key]) {
                grouped[key] = {
                    prev_id: item.prev_id,
                    next_id: item.next_id,
                    latitude: item.latitude,
                    longitude: item.longitude,
                    count_geton: 0,
                    count_getoff: 0,
                    during_ride: 0,
                };
            }
            grouped[key].prev_id = item.prev_id;
            grouped[key].next_id = item.next_id;
            grouped[key].latitude = item.latitude;
            grouped[key].longitude = item.longitude;
            grouped[key].count_geton += item.count_geton || 0;
            grouped[key].count_getoff += item.count_getoff || 0;
            grouped[key].during_ride += item.during_ride || 0;
            return grouped;
        }, {});

        let 実績数表示LayerSource = new ol.source.Vector();
        Object.values(latlon_grouped).forEach((item) => {
            実績数表示LayerSource.addFeature(
                new ol.Feature({
                    geometry: new ol.geom.Point([item.longitude, item.latitude]),
                    properties: {
                        prev_id: item.prev_id,
                        next_id: item.next_id,
                        count_geton: item.count_geton,
                        count_getoff: item.count_getoff,
                        during_ride: item.during_ride,
                    },
                })
            );
        });
        実績数表示Layer.setSource(実績数表示LayerSource);

        let max_during_ride = Math.max(
            ...実績数表示Layer
                .getSource()
                .getFeatures()
                .map((feature) => feature.get("properties").during_ride)
        );
        let max_geton = Math.max(
            ...実績数表示Layer
                .getSource()
                .getFeatures()
                .map((feature) => feature.get("properties").count_geton)
        );
        let max_getoff = Math.max(
            ...実績数表示Layer
                .getSource()
                .getFeatures()
                .map((feature) => feature.get("properties").count_getoff)
        );

        let legend_table = "<table class='table table-sm table-bordered'>";
        legend_table += "<tr><th colspan='2'>乗車人数</th><th colspan='2'>降車人数</th></tr>";
        let during95 = Math.round(max_during_ride * 0.95);
        let geton95 = Math.round(max_geton * 0.95);
        let getoff95 = Math.round(max_getoff * 0.95);
        legend_table += "<tr>";
        legend_table += "<td>" + (isFinite(geton95) ? geton95 : "-") + " 以上</td><td style='background-color:#1761EB;'></td>";
        legend_table += "<td>" + (isFinite(getoff95) ? getoff95 : "-") + " 以上</td><td style='background-color:#F20000;'></td>";
        legend_table += "</tr>";
        let during85 = Math.round(max_during_ride * 0.85);
        let geton85 = Math.round(max_geton * 0.85);
        let getoff85 = Math.round(max_getoff * 0.85);
        legend_table += "<tr>";
        legend_table += "<td>" + (isFinite(geton85) ? geton85 : "-") + " 以上</td><td style='background-color:#3875EA;'></td>";
        legend_table += "<td>" + (isFinite(getoff85) ? getoff85 : "-") + " 以上</td><td style='background-color:#EA2B2B;'></td>";
        legend_table += "</tr>";
        let during70 = Math.round(max_during_ride * 0.7);
        let geton70 = Math.round(max_geton * 0.7);
        let getoff70 = Math.round(max_getoff * 0.7);
        legend_table += "<tr>";
        legend_table += "<td>" + (isFinite(geton70) ? geton70 : "-") + " 以上</td><td style='background-color:#608EEA;'></td>";
        legend_table += "<td>" + (isFinite(getoff70) ? getoff70 : "-") + " 以上</td><td style='background-color:#F25757;'></td>";
        legend_table += "</tr>";
        let during50 = Math.round(max_during_ride * 0.5);
        let geton50 = Math.round(max_geton * 0.5);
        let getoff50 = Math.round(max_getoff * 0.5);
        legend_table += "<tr>";
        legend_table += "<td>" + (isFinite(geton50) ? geton50 : "-") + " 以上</td><td style='background-color:#89ABEB;'></td>";
        legend_table += "<td>" + (isFinite(getoff50) ? getoff50 : "-") + " 以上</td><td style='background-color:#EA7B7E;'></td>";
        legend_table += "</tr>";
        legend_table += "<tr>";
        legend_table += "<td>0 以上</td><td style='background-color:#80C1EA;'></td>";
        legend_table += "<td>0 以上</td><td style='background-color:#E9A5A8;'></td>";
        legend_table += "</tr>";
        legend_table += "</table>";
        $("#advance1b_legend").empty();
        $("#advance1b_legend").html(legend_table);

        実績数表示Layer
            .getSource()
            .getFeatures()
            .forEach((f) => {
                let prop = f.getProperties().properties;
                let d_line = aggregator_routesLayerLines
                    .getSource()
                    .getFeatures()
                    .filter((item) => {
                        return item.get("prev_stop_id") == prop.prev_id && item.get("next_stop_id") == prop.next_id;
                    });
                d_line.forEach((line) => {
                    line.set("during95", during95);
                    line.set("geton95", geton95);
                    line.set("getoff95", getoff95);

                    line.set("during85", during85);
                    line.set("geton85", geton85);
                    line.set("getoff85", getoff85);

                    line.set("during70", during70);
                    line.set("geton70", geton70);
                    line.set("getoff70", getoff70);

                    line.set("during50", during50);
                    line.set("geton50", geton50);
                    line.set("getoff50", getoff50);

                    line.set("count_geton", prop.count_geton);
                    line.set("count_getoff", prop.count_getoff);
                    line.set("during_ride", prop.during_ride);
                });
            });

        layer_aggregator_stops
            .getSource()
            .getFeatures()
            .forEach((f) => {
                let pick_item = Object.values(sortedArray).filter((item) => {
                    return f.get("similar_stop_id") == item.similar_stop_id;
                });
                if (pick_item.length == 0) {
                    let point_color = "#80C1EA";
                    if ($("[name=stops_jisseki_onoff]:checked").val() == "1") point_color = "#E9A5A8";
                    f.setStyle(
                        new ol.style.Style({
                            image: new ol.style.RegularShape({
                                fill: new ol.style.Fill({
                                    color: point_color,
                                }),
                                stroke: new ol.style.Stroke({
                                    color: "#ffffff",
                                    width: 1,
                                }),
                                points: 4,
                                radius: 1,
                                angle: 0,
                            }),
                        })
                    );
                    return;
                }

                let max_target = max_geton;
                let during_ride = Object.values(pick_item).reduce((sum, item) => {
                    return sum + item.count_geton;
                }, 0);
                if ($("[name=stops_jisseki_onoff]:checked").val() == "1") {
                    max_target = max_getoff;
                    during_ride = Object.values(pick_item).reduce((sum, item) => {
                        return sum + item.count_getoff;
                    }, 0);
                }

                let point_color = "#1761EB";
                if ((during_ride / max_target) * 100 < 95) point_color = "#3875EA";
                if ((during_ride / max_target) * 100 < 85) point_color = "#608EEA";
                if ((during_ride / max_target) * 100 < 70) point_color = "#89ABEB";
                if ((during_ride / max_target) * 100 < 50) point_color = "#80C1EA";
                if ($("[name=stops_jisseki_onoff]:checked").val() == "1") {
                    point_color = "#F20000";
                    if ((during_ride / max_target) * 100 < 95) point_color = "#EA2B2B";
                    if ((during_ride / max_target) * 100 < 85) point_color = "#F25757";
                    if ((during_ride / max_target) * 100 < 70) point_color = "#EA7B7E";
                    if ((during_ride / max_target) * 100 < 50) point_color = "#E9A5A8";
                }

                f.setStyle(
                    new ol.style.Style({
                        image: new ol.style.RegularShape({
                            fill: new ol.style.Fill({
                                color: point_color,
                            }),
                            stroke: new ol.style.Stroke({
                                color: "#ffffff",
                                width: 2,
                            }),
                            points: 4,
                            radius: stop_names[0] == f.get("similar_stop_id") ? 10 : 5,
                            angle: 0,
                        }),
                    })
                );
            });

        $(document).off("change", "#trip_filter");
        $("#trip_filter").click((e) => {
            $("[name=filter_panel]").toggle();
        });
        $(document).off("click", "#advance1b-filter-btn");
        $("#advance1b-filter-btn").click((e) => {
            advance1b_graph_sub_point(r, stop_names);
        });
        advance1b_graph_sub_point(r, stop_names);
    };
    const advance1b_graph_sub_point = async (r, stop_names) => {
        $("#advance1b_graph_panel").empty();

        if (stop_names.length < 1) {
            overlay.setPosition(undefined);
            $("#advance1b_graph_panel").append("<p>路線上の任意の停留所をクリックすると時間帯別乗降実績を確認できます</p>");
            return;
        }

        r.data.sort((a, b) => {
            if (a.trip_id < b.trip_id) return -1;
            if (a.trip_id > b.trip_id) return 1;
            return a.stop_sequence - b.stop_sequence;
        });

        let filter_item = $("[name=trip_filter_select_input]").val();
        if (filter_item == "") filter_item = "全て";
        let latlon_grouped = r.data.reduce((grouped, item) => {
            if (filter_item !== "全て" && item.route_id !== filter_item) return grouped;
            const key = `${item.stop_sequence}`;
            if (!grouped[key]) {
                grouped[key] = {
                    stop_id: "",
                    stop_sequence: 0,
                    stop_name: "",
                    trip_id: "",
                    route_id: "",
                    date: "",
                    agency_id: "",
                    latitude: -1,
                    longitude: -1,
                    total_count_geton: 0,
                    total_count_getoff: 0,
                    total_during_ride: 0,
                };
            }
            grouped[key].stop_id = item.similar_stop_id;
            grouped[key].stop_sequence = item.stop_sequence;
            grouped[key].stop_name = item.stop_name;
            grouped[key].trip_id = item.trip_id;
            grouped[key].route_id = item.route_id;
            grouped[key].date = item.date;
            grouped[key].agency_id = item.agency_id;
            grouped[key].latitude = item.latitude;
            grouped[key].longitude = item.longitude;
            grouped[key].total_count_geton += item.count_geton || 0;
            grouped[key].total_count_getoff += item.count_getoff || 0;
            grouped[key].total_during_ride += item.during_ride || 0;
            return grouped;
        }, {});

        $("#trip_filter_btn").click((e) => {
            if (実績数表示Layer.getSource().getFeatures().length > 0) map.getView().fit(実績数表示Layer.getSource().getExtent());
        });
        $("#trip_filter_btn").click();

        if (stop_names.length == 0) {
            $("#advance1b_graph_panel").html($("#advance1b_graph_panel").html() + "<p>地図上で停留所を選択してください</p>");
            return;
        }

        let filtered_data = [];
        filtered_data = r.data.filter((item) => item.similar_stop_id == stop_names[0][0]);

        const extractHourFromTripId = (trip_id) => {
            const parts = trip_id.split("_");
            if (parts.length > 1) {
                const match = parts[1].match(/\d{2}/);
                return match ? parseInt(match[0], 10) : null;
            }
            return null;
        };

        filtered_data = filtered_data.map((item) => {
            return {
                ...item,
                hour: extractHourFromTripId(item.trip_id),
            };
        });

        const groupedData = filtered_data.reduce((acc, item) => {
            if (!acc[item.hour]) {
                acc[item.hour] = { hour: item.hour, count_geton: 0, count_getoff: 0, during_ride: 0 };
            }
            acc[item.hour].count_geton += item.count_geton;
            acc[item.hour].count_getoff += item.count_getoff;
            acc[item.hour].during_ride += item.during_ride;
            return acc;
        }, {});

        const fullHours = Array.from({ length: 23 - 5 + 1 }, (_, i) => i + 5);
        const completedData = fullHours.map((hour) => {
            return groupedData[hour] || { hour, count_geton: 0, count_getoff: 0, during_ride: 0 };
        });

        const labels = completedData.map((item) => `${item.hour}時`);
        const 乗車人数 = completedData.map((item) => item.count_geton);
        const 降車人数 = completedData.map((item) => item.count_getoff);
        const 乗車中人数 = completedData.map((item) => item.during_ride);

        const graph_div = document.createElement("div");
        graph_div.innerHTML =
            `<span class="mb-2">選択した停留所のstop_name：${stop_names[0][1]}</span><br />` +
            "<span>●すべてのルート</span>" +
            '<button class="btn btn-sm btn-success map-button-a1a" name="route_data_btn" data-route="all">このルートを地図上で表示</button>';
        const canvas = document.createElement("canvas");
        graph_div.appendChild(canvas);
        $("#advance1b_graph_panel").append(graph_div);
        const ctx = canvas.getContext("2d");

        dgadvance1b.innerHTML = "";
        const hiddenCanvas = document.createElement("canvas");
        hiddenCanvas.style.display = "none";
        hiddenCanvas.width = 1900;
        hiddenCanvas.height = 540;
        hiddenCanvas.classList.add("hidden-chart");

        dgadvance1b.appendChild(hiddenCanvas);
        const hiddenCtx = hiddenCanvas.getContext("2d");

        let datasets = [
            { label: "乗車数", data: 乗車人数 },
            { label: "降車数", data: 降車人数 },
        ];
        new Chart(ctx, {
            type: "bar",
            data: {
                labels: labels,
                datasets: datasets,
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        title: {
                            display: false,
                            text: "時間",
                        },
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: "人数",
                        },
                        ticks: {
                            stepSize: 500,
                        },
                    },
                },
            },
        });

        new Chart(hiddenCtx, {
            type: "bar",
            data: {
                labels: labels,
                datasets: datasets,
            },
            options: {
                animation: false,
                responsive: true,
                scales: {
                    x: {
                        title: {
                            display: false,
                            text: "時間",
                        },
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: "人数",
                        },
                        ticks: {
                            stepSize: 500,
                        },
                    },
                },
            },
        });

        const table_div = document.createElement("div");
        let table_str = "<table class='table table-sm table-bordered'>";
        table_str += "<tr>";
        table_str += "<td></td>";
        table_str += "<td>乗車人数</td>";
        table_str += "<td>降車人数</td>";
        table_str += "</tr>";
        table_str += "<tr>";
        table_str += "<td>平均</td>";
        table_str += "<td>" + Math.round(乗車人数.reduce((a, b) => a + b, 0) / 乗車人数.length) + "</td>";
        table_str += "<td>" + Math.round(降車人数.reduce((a, b) => a + b, 0) / 降車人数.length) + "</td>";
        table_str += "</tr>";
        table_str += "<tr>";
        table_str += "<td>最大</td>";
        table_str += "<td>" + Math.max(...乗車人数) + "</td>";
        table_str += "<td>" + Math.max(...降車人数) + "</td>";
        table_str += "</tr>";
        table_str += "<tr>";
        table_str += "<td>合計</td>";
        table_str += "<td>" + 乗車人数.reduce((a, b) => a + b, 0) + "</td>";
        table_str += "<td>" + 降車人数.reduce((a, b) => a + b, 0) + "</td>";
        table_str += "</tr>";
        table_str += "</table>";
        table_div.innerHTML = table_str;
        graph_div.appendChild(table_div);

        $("[name=trip_filter_btn]").click((e) => {
            if (実績数表示Layer.getSource().getFeatures().length > 0) map.getView().fit(実績数表示Layer.getSource().getExtent());
        });

        const routeMap = {};
        r.data.forEach(({ trip_id, route_id }) => {
            if (route_id && route_id !== "nan") routeMap[trip_id] = route_id;
        });
        r.data = r.data.map((entry) => ({
            ...entry,
            route_id: entry.route_id === "" || entry.route_id === "nan" ? routeMap[entry.trip_id] : entry.route_id,
        }));

        let route_grouped = r.data.reduce((grouped, item) => {
            if (filter_item !== "全て" && item.route_id !== filter_item) return grouped;
            (grouped[item.route_id] = grouped[item.route_id] || []).push(item);
            return grouped;
        }, {});


        let popup_html = `<code>停留所名 : ${stop_names[0][1]}</code><br /><span class="mt-1 mb-2">この停留所を通過するルート</span>`;
        Object.keys(route_grouped).forEach(async (route) => {
            let route_div = document.createElement("div");
            let route_name = route;
            if (route_name == undefined) return;

            route_div.innerHTML =
                "<span>●" + route + "</span><button class='btn btn-sm btn-outline-success map-button-a1a' name='route_data_btn' data-route='" + route + "'>このルートを地図上で表示</button>";

            let rd = route_grouped[route];
            rd.sort((a, b) => {
                if (a.trip_id < b.trip_id) return -1;
                if (a.trip_id > b.trip_id) return 1;
                return a.stop_sequence - b.stop_sequence;
            });

            let rd_filtered_data = [];
            rd_filtered_data = rd.filter((item) => item.similar_stop_id == stop_names[0][0]);

            rd_filtered_data = rd_filtered_data.map((item) => {
                return {
                    ...item,
                    hour: extractHourFromTripId(item.trip_id),
                };
            });
            const rd_groupedData = rd_filtered_data.reduce((acc, item) => {
                if (!acc[item.hour]) {
                    acc[item.hour] = { hour: item.hour, count_geton: 0, count_getoff: 0, during_ride: 0 };
                }
                acc[item.hour].count_geton += item.count_geton;
                acc[item.hour].count_getoff += item.count_getoff;
                acc[item.hour].during_ride += item.during_ride;
                return acc;
            }, {});
            const rd_completedData = fullHours.map((hour) => {
                return rd_groupedData[hour] || { hour, count_geton: 0, count_getoff: 0, during_ride: 0 };
            });

            const rd_labels = rd_completedData.map((item) => `${item.hour}時`);
            const rd_乗車人数 = rd_completedData.map((item) => item.count_geton);
            const rd_降車人数 = rd_completedData.map((item) => item.count_getoff);
            const rd_乗車中人数 = rd_completedData.map((item) => item.during_ride);

            if (rd_乗車人数.reduce((a, b) => a + b, 0) == 0 && rd_降車人数.reduce((a, b) => a + b, 0) == 0 && rd_乗車中人数.reduce((a, b) => a + b, 0) == 0) return;

            popup_html += "<br />" + route;

            const rd_canvas = document.createElement("canvas");
            route_div.appendChild(rd_canvas);
            const ctx = rd_canvas.getContext("2d");

            const hidden_rd_Canvas = document.createElement("canvas");
            hidden_rd_Canvas.style.display = "none";
            hidden_rd_Canvas.width = 1900;
            hidden_rd_Canvas.height = 540;
            hidden_rd_Canvas.classList.add("hidden-chart");

            dgadvance1b.appendChild(hidden_rd_Canvas);
            const hidden_rd_Ctx = hidden_rd_Canvas.getContext("2d");

            let b_datasets = [
                { label: "乗車数", data: rd_乗車人数 },
                { label: "降車数", data: rd_降車人数 },
            ];
            new Chart(ctx, {
                type: "bar",
                data: {
                    labels: rd_labels,
                    datasets: b_datasets,
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: false,
                                text: "時間",
                            },
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: "人数",
                            },
                            ticks: {
                                stepSize: 500,
                            },
                        },
                    },
                },
            });

            new Chart(hidden_rd_Ctx, {
                type: "bar",
                data: {
                    labels: rd_labels,
                    datasets: b_datasets,
                },
                options: {
                    responsive: true,
                    animation: false,
                    scales: {
                        x: {
                            title: {
                                display: false,
                                text: "時間",
                            },
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: "人数",
                            },
                            ticks: {
                                stepSize: 500,
                            },
                        },
                    },
                },
            });

            $("#advance1b_graph_panel").append(route_div);

            const rd_table_div = document.createElement("div");
            let rd_table_str = "<table class='table table-sm table-bordered'>";
            rd_table_str += "<tr>";
            rd_table_str += "<td></td>";
            rd_table_str += "<td>乗車人数</td>";
            rd_table_str += "<td>降車人数</td>";
            rd_table_str += "</tr>";
            rd_table_str += "<tr>";
            rd_table_str += "<td>平均</td>";
            rd_table_str += "<td>" + Math.round(rd_乗車人数.reduce((a, b) => a + b, 0) / rd_乗車人数.length) + "</td>";
            rd_table_str += "<td>" + Math.round(rd_降車人数.reduce((a, b) => a + b, 0) / rd_降車人数.length) + "</td>";
            rd_table_str += "</tr>";
            rd_table_str += "<tr>";
            rd_table_str += "<td>最大</td>";
            rd_table_str += "<td>" + Math.max(...rd_乗車人数) + "</td>";
            rd_table_str += "<td>" + Math.max(...rd_降車人数) + "</td>";
            rd_table_str += "</tr>";
            rd_table_str += "<tr>";
            rd_table_str += "<td>合計</td>";
            rd_table_str += "<td>" + rd_乗車人数.reduce((a, b) => a + b, 0) + "</td>";
            rd_table_str += "<td>" + rd_降車人数.reduce((a, b) => a + b, 0) + "</td>";
            rd_table_str += "</tr>";
            rd_table_str += "</table>";
            rd_table_div.innerHTML = rd_table_str;
            route_div.appendChild(rd_table_div);

            $("[name=route_data_btn]")
                .off("click")
                .on("click", (e) => {
                    fit_to_route_id(rd, e.target.getAttribute("data-route"));
                });
        });
        $("#popup-content").html(popup_html);
        map.getViewport().dispatchEvent(new Event("pointermove"));
    };

    const advance1b_graph = async (aggr_routes) => {
        $("#advance1b_graph").empty();
        let days = $("[name=advance1b_days]").val();

        let advance1b_graph_div = document.getElementById("advance1b_graph");
        if (!advance1b_graph_div) return;
        advance1b_graph_div.innerHTML = "<img id='trip_filter' src='/static/app/img/trip_filter.png' style='width: 25px; float:right; cursor:pointer;' /><h5>時間帯別乗降実績</h5>";

        let time = -1;
        let time_range = -1;
        let routes = "all";
        let direction = -1;
        let url = `/api/get_jisseki_graph/${open_key}/${days}/${time}/${time_range}/${routes}/${direction}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Network response was not ok [${open_key}]`);
        let r = await response.json();
        let filter_data = r.data;

        if (aggr_routes.length > 0) {
            filter_data = filter_data.filter((item) => item.similar_stop_id == aggr_routes[0].get("prev_stop_id"));
        }
        let route_grouped = filter_data.reduce((grouped, item) => {
            (grouped[item.route_id] = grouped[item.route_id] || []).push(item);
            return grouped;
        }, {});

        let trip_filter = '<div name="filter_panel" class="btn-group" style="width: 100%; display: none;">';
        trip_filter += "<datalist id='trip_filter_select_2b' name='trip_filter_select_2b' class='form-select form-select-sm' style='display: none;'>";
        trip_filter += `<option value="全て">全て</option>`;
        Object.keys(route_grouped).forEach((key) => {
            if (key == "nan") return;
            trip_filter += `<option value="${key}">${key}</option>`;
        });
        trip_filter += "</datalist>";
        trip_filter += '<input list="trip_filter_select_2b" id="trip_filter_select_input" name="trip_filter_select_input" autocomplete="off" class="form-control form-control-sm">';
        trip_filter += "<button id='advance1b-filter-btn' class='fltr-button-a1a' style='min-width: 80px;'>絞り込み</button>";
        trip_filter += "</div>";
        advance1b_graph_div.innerHTML += trip_filter;
        advance1b_graph_div.innerHTML += "<div id='advance1b_graph_panel'></div>";

        let sortedArray = r.data.sort((a, b) => {
            if (a.trip_id < b.trip_id) return -1;
            if (a.trip_id > b.trip_id) return 1;
            return a.stop_sequence - b.stop_sequence;
        });

        const getLeftOffsetCoordinate = (lon1, lat1, lon2, lat2, offset_distance = 0.0001) => {
            let zoom = map.getView().getZoom();
            offset_distance = offset_distance / Math.pow(2, zoom - 5);

            let p1 = ol.proj.fromLonLat([lon1, lat1]);
            let p2 = ol.proj.fromLonLat([lon2, lat2]);

            let dx = p2[0] - p1[0];
            let dy = p2[1] - p1[1];

            let length = Math.sqrt(dx * dx + dy * dy);
            if (length === 0) return [lon1, lat1];

            let nx = -dy / length;
            let ny = dx / length;

            let new_x = p1[0] - nx * offset_distance;
            let new_y = p1[1] - ny * offset_distance;

            return ol.proj.toLonLat([new_x, new_y]);
        };

        let 実績数Features = [];
        let 乗車中人数 = 0;
        for (let i = 0; i < sortedArray.length - 1; i++) {
            let prev = sortedArray[i];
            let next = sortedArray[i + 1];
            if (prev.trip_id != next.trip_id) {
                乗車中人数 = 0;
                continue;
            }

            let c1_lonlat = ol.proj.fromLonLat(getLeftOffsetCoordinate(prev.centroid_longitude, prev.centroid_latitude, next.centroid_longitude, next.centroid_latitude, 120));
            let c2_lonlat = ol.proj.fromLonLat([next.centroid_longitude, next.centroid_latitude]);

            c1_lonlat = [(c1_lonlat[0] + c2_lonlat[0]) / 2, (c1_lonlat[1] + c2_lonlat[1]) / 2];

            let org_lonlat = ol.proj.fromLonLat([prev.centroid_longitude, prev.centroid_latitude]);
            c1_lonlat = [(c1_lonlat[0] * 5 + org_lonlat[0]) / 6, (c1_lonlat[1] * 5 + org_lonlat[1]) / 6];

            乗車中人数 += prev.count_geton - prev.count_getoff;
            実績数Features.push({
                prev_id: prev.similar_stop_id,
                next_id: next.similar_stop_id,
                prev_org_id: prev.stop_id,
                next_org_id: next.stop_id,
                trip_id: prev.trip_id,
                stop_sequence: prev.stop_sequence,
                longitude: c1_lonlat[0],
                latitude: c1_lonlat[1],
                count_geton: prev.count_geton,
                count_getoff: prev.count_getoff,
                during_ride: 乗車中人数,
            });
        }
        let latlon_grouped = 実績数Features.reduce((grouped, item) => {
            const key = `latlon_${item.prev_id}_${item.next_id}_${item.latitude}_${item.longitude}`;
            if (!grouped[key]) {
                grouped[key] = {
                    prev_id: item.prev_id,
                    next_id: item.next_id,
                    latitude: item.latitude,
                    longitude: item.longitude,
                    count_geton: 0,
                    count_getoff: 0,
                    during_ride: 0,
                };
            }
            grouped[key].prev_id = item.prev_id;
            grouped[key].next_id = item.next_id;
            grouped[key].latitude = item.latitude;
            grouped[key].longitude = item.longitude;
            grouped[key].count_geton += item.count_geton || 0;
            grouped[key].count_getoff += item.count_getoff || 0;
            grouped[key].during_ride += item.during_ride || 0;
            return grouped;
        }, {});

        let 実績数表示LayerSource = new ol.source.Vector();
        Object.values(latlon_grouped).forEach((item) => {
            実績数表示LayerSource.addFeature(
                new ol.Feature({
                    geometry: new ol.geom.Point([item.longitude, item.latitude]),
                    properties: {
                        prev_id: item.prev_id,
                        next_id: item.next_id,
                        count_geton: item.count_geton,
                        count_getoff: item.count_getoff,
                        during_ride: item.during_ride,
                    },
                })
            );
        });
        実績数表示Layer.setSource(実績数表示LayerSource);

        let max_during_ride = Math.max(
            ...実績数表示Layer
                .getSource()
                .getFeatures()
                .map((feature) => feature.get("properties").during_ride)
        );
        let max_geton = Math.max(
            ...実績数表示Layer
                .getSource()
                .getFeatures()
                .map((feature) => feature.get("properties").count_geton)
        );
        let max_getoff = Math.max(
            ...実績数表示Layer
                .getSource()
                .getFeatures()
                .map((feature) => feature.get("properties").count_getoff)
        );

        let legend_table = "<table class='table table-sm table-bordered'>";
        legend_table += "<tr><th colspan='2'>乗車中人数</th></tr>";
        let during95 = Math.round(max_during_ride * 0.95);
        let geton95 = Math.round(max_geton * 0.95);
        let getoff95 = Math.round(max_getoff * 0.95);
        legend_table += "<tr>";
        legend_table += "<td>" + (isFinite(during95) ? during95 : "-") + " 以上</td><td style='background-color:#FF9600;'></td>";
        legend_table += "</tr>";
        let during85 = Math.round(max_during_ride * 0.85);
        let geton85 = Math.round(max_geton * 0.85);
        let getoff85 = Math.round(max_getoff * 0.85);
        legend_table += "<tr>";
        legend_table += "<td>" + (isFinite(during85) ? during85 : "-") + " 以上</td><td style='background-color:#FFAA33;'></td>";
        legend_table += "</tr>";
        let during70 = Math.round(max_during_ride * 0.7);
        let geton70 = Math.round(max_geton * 0.7);
        let getoff70 = Math.round(max_getoff * 0.7);
        legend_table += "<tr>";
        legend_table += "<td>" + (isFinite(during70) ? during70 : "-") + " 以上</td><td style='background-color:#FFBC61;'></td>";
        legend_table += "</tr>";
        let during50 = Math.round(max_during_ride * 0.5);
        let geton50 = Math.round(max_geton * 0.5);
        let getoff50 = Math.round(max_getoff * 0.5);
        legend_table += "<tr>";
        legend_table += "<td>" + (isFinite(during50) ? during50 : "-") + " 以上</td><td style='background-color:#FFCE8A;'></td>";
        legend_table += "</tr>";
        legend_table += "<tr>";
        legend_table += "<td>0 以上</td><td style='background-color:#FFDEB3;'></td>";
        legend_table += "</tr>";
        legend_table += "</table>";
        $("#advance1b_legend").empty();
        $("#advance1b_legend").html(legend_table);

        実績数表示Layer
            .getSource()
            .getFeatures()
            .forEach((f) => {
                f.set("selected", false);
                let prop = f.getProperties().properties;
                let d_line = aggregator_routesLayerLines
                    .getSource()
                    .getFeatures()
                    .filter((item) => {
                        return item.get("prev_stop_id") == prop.prev_id && item.get("next_stop_id") == prop.next_id;
                    });
                d_line.forEach((line) => {
                    line.set("during95", during95);
                    line.set("geton95", geton95);
                    line.set("getoff95", getoff95);

                    line.set("during85", during85);
                    line.set("geton85", geton85);
                    line.set("getoff85", getoff85);

                    line.set("during70", during70);
                    line.set("geton70", geton70);
                    line.set("getoff70", getoff70);

                    line.set("during50", during50);
                    line.set("geton50", geton50);
                    line.set("getoff50", getoff50);

                    line.set("count_geton", prop.count_geton);
                    line.set("count_getoff", prop.count_getoff);
                    line.set("during_ride", prop.during_ride);
                });
            });

        layer_aggregator_stops
            .getSource()
            .getFeatures()
            .forEach((f) => {
                f.setStyle(
                    new ol.style.Style({
                        image: new ol.style.RegularShape({
                            fill: new ol.style.Fill({
                                color: "rgba(255, 94, 91, 1.0)",
                            }),
                            stroke: new ol.style.Stroke({
                                color: "#ffffff",
                                width: 2,
                            }),
                            points: 4,
                            radius: 4,
                            angle: 0,
                        }),
                    })
                );
            });

        $(document).off("change", "#trip_filter");
        $("#trip_filter").click((e) => {
            $("[name=filter_panel]").toggle();
        });
        $(document).off("click", "#advance1b-filter-btn");
        $("#advance1b-filter-btn").click((e) => {
            advance1b_graph_sub(r, aggr_routes);
        });
        advance1b_graph_sub(r, aggr_routes);
    };
    const advance1b_graph_sub = async (r, aggr_routes) => {
        $("#advance1b_graph_panel").empty();

        if (aggr_routes.length < 1) {
            $("#advance1b_graph_panel").append("<p>路線上の任意の区間をクリックすると時間帯別乗降実績を確認できます</p>");
            return;
        }

        r.data.sort((a, b) => {
            if (a.trip_id < b.trip_id) return -1;
            if (a.trip_id > b.trip_id) return 1;
            return a.stop_sequence - b.stop_sequence;
        });

        let filter_item = $("[name=trip_filter_select_input]").val();
        if (filter_item == "") filter_item = "全て";
        let latlon_grouped = r.data.reduce((grouped, item) => {
            if (filter_item !== "全て" && item.route_id !== filter_item) return grouped;
            const key = `${item.stop_sequence}`;
            if (!grouped[key]) {
                grouped[key] = {
                    stop_id: "",
                    stop_sequence: 0,
                    stop_name: "",
                    trip_id: "",
                    route_id: "",
                    date: "",
                    agency_id: "",
                    latitude: -1,
                    longitude: -1,
                    total_count_geton: 0,
                    total_count_getoff: 0,
                    total_during_ride: 0,
                };
            }
            grouped[key].stop_id = item.similar_stop_id;
            grouped[key].stop_sequence = item.stop_sequence;
            grouped[key].stop_name = item.stop_name;
            grouped[key].trip_id = item.trip_id;
            grouped[key].route_id = item.route_id;
            grouped[key].date = item.date;
            grouped[key].agency_id = item.agency_id;
            grouped[key].latitude = item.latitude;
            grouped[key].longitude = item.longitude;
            grouped[key].total_count_geton += item.count_geton || 0;
            grouped[key].total_count_getoff += item.count_getoff || 0;
            grouped[key].total_during_ride += item.during_ride || 0;
            return grouped;
        }, {});

        $("#trip_filter_btn").click((e) => {
            if (実績数表示Layer.getSource().getFeatures().length > 0) map.getView().fit(実績数表示Layer.getSource().getExtent());
        });
        $("#trip_filter_btn").click();

        if (aggr_routes.length == 0) {
            $("#advance1b_graph_panel").html($("#advance1b_graph_panel").html() + "<p>地図上で区間を選択してください</p>");
            return;
        }

        let filtered_data = [];
        aggr_routes.forEach((route) => {
            for (let i = 0; i < r.data.length - 1; i++) {
                let prev_data = r.data[i];
                let next_data = r.data[i + 1];
                if (prev_data.trip_id != next_data.trip_id) continue;

                if (prev_data.similar_stop_id == route.get("prev_stop_id") && next_data.similar_stop_id == route.get("next_stop_id")) {
                    let exists = filtered_data.some((item) => item.trip_id === prev_data.trip_id && item.stop_sequence === prev_data.stop_sequence);
                    if (!exists) filtered_data.push(prev_data);
                }
            }
            return;
        });

        const extractHourFromTripId = (trip_id) => {
            const parts = trip_id.split("_");
            if (parts.length > 1) {
                const match = parts[1].match(/\d{2}/);
                return match ? parseInt(match[0], 10) : null;
            }
            return null;
        };

        filtered_data = filtered_data.map((item) => {
            return {
                ...item,
                hour: extractHourFromTripId(item.trip_id),
            };
        });

        const groupedData = filtered_data.reduce((acc, item) => {
            if (!acc[item.hour]) {
                acc[item.hour] = { hour: item.hour, count_geton: 0, count_getoff: 0, during_ride: 0 };
            }
            acc[item.hour].count_geton += item.count_geton;
            acc[item.hour].count_getoff += item.count_getoff;
            acc[item.hour].during_ride += item.during_ride;
            return acc;
        }, {});

        const fullHours = Array.from({ length: 23 - 5 + 1 }, (_, i) => i + 5);
        const completedData = fullHours.map((hour) => {
            return groupedData[hour] || { hour, count_geton: 0, count_getoff: 0, during_ride: 0 };
        });

        const labels = completedData.map((item) => `${item.hour}時`);
        const 乗車人数 = completedData.map((item) => item.count_geton);
        const 降車人数 = completedData.map((item) => item.count_getoff);
        const 乗車中人数 = completedData.map((item) => item.during_ride);

        const graph_div = document.createElement("div");
        graph_div.innerHTML = "<span>●すべてのルート</span>" + '<button class="btn btn-sm btn-success map-button-a1a" name="route_data_btn" data-route="all">このルートを地図上で表示</button>';
        const canvas = document.createElement("canvas");
        graph_div.appendChild(canvas);
        $("#advance1b_graph_panel").append(graph_div);
        const ctx = canvas.getContext("2d");

        dgadvance1b.innerHTML = "";
        const hiddenCanvas = document.createElement("canvas");
        hiddenCanvas.style.display = "none";
        hiddenCanvas.width = 1900;
        hiddenCanvas.height = 540;
        hiddenCanvas.classList.add("hidden-chart");

        dgadvance1b.appendChild(hiddenCanvas);
        const hiddenCtx = hiddenCanvas.getContext("2d");

        let datasets = [{ label: "乗車中人数", data: 乗車中人数, type: "line", borderColor: "#FF9600" }];
        new Chart(ctx, {
            type: "bar",
            data: {
                labels: labels,
                datasets: datasets,
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        title: {
                            display: false,
                            text: "時間",
                        },
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: "人数",
                        },
                        ticks: {
                            stepSize: 500,
                        },
                    },
                },
            },
        });

        new Chart(hiddenCtx, {
            type: "bar",
            data: {
                labels: labels,
                datasets: datasets,
            },
            options: {
                animation: false,
                responsive: true,
                scales: {
                    x: {
                        title: {
                            display: false,
                            text: "時間",
                        },
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: "人数",
                        },
                        ticks: {
                            stepSize: 500,
                        },
                    },
                },
            },
        });

        const table_div = document.createElement("div");
        let table_str = "<table class='table table-sm table-bordered'>";
        table_str += "<tr>";
        table_str += "<td></td>";
        table_str += "<td>乗車中人数</td>";
        table_str += "</tr>";
        table_str += "<tr>";
        table_str += "<td>平均</td>";
        table_str += "<td>" + Math.round(乗車中人数.reduce((a, b) => a + b, 0) / 乗車中人数.length) + "</td>";
        table_str += "</tr>";
        table_str += "<tr>";
        table_str += "<td>最大</td>";
        table_str += "<td>" + Math.max(...乗車中人数) + "</td>";
        table_str += "</tr>";
        table_str += "<tr>";
        table_str += "<td>合計</td>";
        table_str += "<td>" + 乗車中人数.reduce((a, b) => a + b, 0) + "</td>";
        table_str += "</tr>";
        table_str += "</table>";
        table_div.innerHTML = table_str;
        graph_div.appendChild(table_div);

        $("[name=trip_filter_btn]").click((e) => {
            if (実績数表示Layer.getSource().getFeatures().length > 0) map.getView().fit(実績数表示Layer.getSource().getExtent());
        });

        const routeMap = {};
        r.data.forEach(({ trip_id, route_id }) => {
            if (route_id && route_id !== "nan") routeMap[trip_id] = route_id;
        });
        r.data = r.data.map((entry) => ({
            ...entry,
            route_id: entry.route_id === "" || entry.route_id === "nan" ? routeMap[entry.trip_id] : entry.route_id,
        }));

        let route_grouped = r.data.reduce((grouped, item) => {
            if (filter_item !== "全て" && item.route_id !== filter_item) return grouped;
            (grouped[item.route_id] = grouped[item.route_id] || []).push(item);
            return grouped;
        }, {});


        Object.keys(route_grouped).forEach(async (route) => {
            let route_div = document.createElement("div");
            let route_name = route;
            if (route_name == undefined) return;

            route_div.innerHTML =
                "<span>●" + route + "</span><button class='btn btn-sm btn-outline-success map-button-a1a' name='route_data_btn' data-route='" + route + "'>このルートを地図上で表示</button>";

            let rd = route_grouped[route];
            rd.sort((a, b) => {
                if (a.trip_id < b.trip_id) return -1;
                if (a.trip_id > b.trip_id) return 1;
                return a.stop_sequence - b.stop_sequence;
            });

            let rd_filtered_data = [];
            aggr_routes.forEach((route) => {
                for (let i = 0; i < rd.length - 1; i++) {
                    let prev_data = rd[i];
                    let next_data = rd[i + 1];
                    if (prev_data.trip_id != next_data.trip_id) continue;

                    if (prev_data.similar_stop_id == route.get("prev_stop_id") && next_data.similar_stop_id == route.get("next_stop_id")) {
                        let exists = rd_filtered_data.some((item) => item.trip_id === prev_data.trip_id && item.stop_sequence === prev_data.stop_sequence);
                        if (!exists) rd_filtered_data.push(prev_data);
                    }
                }
            });

            rd_filtered_data = rd_filtered_data.map((item) => {
                return {
                    ...item,
                    hour: extractHourFromTripId(item.trip_id),
                };
            });
            const rd_groupedData = rd_filtered_data.reduce((acc, item) => {
                if (!acc[item.hour]) {
                    acc[item.hour] = { hour: item.hour, count_geton: 0, count_getoff: 0, during_ride: 0 };
                }
                acc[item.hour].count_geton += item.count_geton;
                acc[item.hour].count_getoff += item.count_getoff;
                acc[item.hour].during_ride += item.during_ride;
                return acc;
            }, {});
            const rd_completedData = fullHours.map((hour) => {
                return rd_groupedData[hour] || { hour, count_geton: 0, count_getoff: 0, during_ride: 0 };
            });

            const rd_labels = rd_completedData.map((item) => `${item.hour}時`);
            const rd_乗車人数 = rd_completedData.map((item) => item.count_geton);
            const rd_降車人数 = rd_completedData.map((item) => item.count_getoff);
            const rd_乗車中人数 = rd_completedData.map((item) => item.during_ride);

            if (rd_乗車人数.reduce((a, b) => a + b, 0) == 0 && rd_降車人数.reduce((a, b) => a + b, 0) == 0 && rd_乗車中人数.reduce((a, b) => a + b, 0) == 0) return;

            const rd_canvas = document.createElement("canvas");
            route_div.appendChild(rd_canvas);
            const ctx = rd_canvas.getContext("2d");

            const hidden_rd_Canvas = document.createElement("canvas");
            hidden_rd_Canvas.style.display = "none";
            hidden_rd_Canvas.width = 1900;
            hidden_rd_Canvas.height = 540;
            hidden_rd_Canvas.classList.add("hidden-chart");

            dgadvance1b.appendChild(hidden_rd_Canvas);
            const hidden_rd_Ctx = hidden_rd_Canvas.getContext("2d");

            let b_datasets = [{ label: "乗車中人数", data: rd_乗車中人数, type: "line", borderColor: "#FF9600" }];
            new Chart(ctx, {
                type: "bar",
                data: {
                    labels: rd_labels,
                    datasets: b_datasets,
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: false,
                                text: "時間",
                            },
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: "人数",
                            },
                            ticks: {
                                stepSize: 500,
                            },
                        },
                    },
                },
            });

            new Chart(hidden_rd_Ctx, {
                type: "bar",
                data: {
                    labels: rd_labels,
                    datasets: b_datasets,
                },
                options: {
                    responsive: true,
                    animation: false,
                    scales: {
                        x: {
                            title: {
                                display: false,
                                text: "時間",
                            },
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: "人数",
                            },
                            ticks: {
                                stepSize: 500,
                            },
                        },
                    },
                },
            });

            $("#advance1b_graph_panel").append(route_div);

            const rd_table_div = document.createElement("div");
            let rd_table_str = "<table class='table table-sm table-bordered'>";
            rd_table_str += "<tr>";
            rd_table_str += "<td></td>";
            rd_table_str += "<td>乗車中人数</td>";
            rd_table_str += "</tr>";
            rd_table_str += "<tr>";
            rd_table_str += "<td>平均</td>";
            rd_table_str += "<td>" + Math.round(rd_乗車中人数.reduce((a, b) => a + b, 0) / rd_乗車中人数.length) + "</td>";
            rd_table_str += "</tr>";
            rd_table_str += "<tr>";
            rd_table_str += "<td>最大</td>";
            rd_table_str += "<td>" + Math.max(...rd_乗車中人数) + "</td>";
            rd_table_str += "</tr>";
            rd_table_str += "<tr>";
            rd_table_str += "<td>合計</td>";
            rd_table_str += "<td>" + rd_乗車中人数.reduce((a, b) => a + b, 0) + "</td>";
            rd_table_str += "</tr>";
            rd_table_str += "</table>";
            rd_table_div.innerHTML = rd_table_str;
            route_div.appendChild(rd_table_div);

            $("[name=route_data_btn]")
                .off("click")
                .on("click", (e) => {
                    fit_to_route_id(rd, e.target.getAttribute("data-route"));
                });
        });
    };
    const fit_to_route_id = (features, route_id) => {
        if (route_id == "all") {
            map.getView().fit(aggregator_routesLayerLines.getSource().getExtent());
            return;
        }
        const route_name = route_id.match(/^(.*)\(/)?.[1] || "";
        routesLayerGroup.getLayers().forEach((lyr) => {
            if (lyr.get("title").trim() == route_name.trim()) {
                map.getView().fit(lyr.getSource().getExtent());
                return;
            }
        });
    };
    const get_route_id_to_name = async (route_id) => {
        let url = `/api/get_route_id_to_name/${open_key}/${route_id}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Network response was not ok [${open_key}]`);
        let r = await response.json();
        return r.route_name;
    };

    const getCookie = (name) => {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            let cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                let cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === name + "=") {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    };

    const clearLayerVisible = (lyr) => {
        overlay.setPosition(undefined);
        if (lyr.get("baseLayer")) {
            return;
        }
        if (lyr instanceof ol.layer.Group) {
            lyr.getLayers().forEach((sublyr) => {
                clearLayerVisible(sublyr);
            });
        }
        lyr.setVisible(false);
    };
    const setLayerVisible = (lyr) => {
        overlay.setPosition(undefined);
        if (lyr.get("baseLayer")) {
            return;
        }
        if (lyr instanceof ol.layer.Group) {
            lyr.getLayers().forEach((sublyr) => {
                setLayerVisible(sublyr);
            });
        }
        lyr.setVisible(true);
    };
    advance2_r.onclick = () => {
        onadvance2();
        offcanvas.hide();
        menu_mode = "advance2_r";

        const arg =
            "<div class='' style='background-color:white;margin:30px;padding:10px;height:180px;text-align:center;'>" +
            "    <br />" +
            "    <h6>データをアップロードしてください</h6>" +
            "    <div class='input-group'>" +
            "      <input type='file' class='form-control' id='fileInput' accept='.csv'>" +
            "    </div>" +
            "    <div class='mt-3'>" +
            "        <button id='csv2-upload-ok' class='csv-upload-OK'>OK</button>" +
            "        <button id='csv2-upload-cancel' class='csv-upload-Cancel'>キャンセル</button>" +
            "    </div>" +
            "</div>";

        setCSVPanelInfo("ODデータ読み込み", "アップロードするODデータを指定してください", arg);
        $("#csv2-upload-ok").off("click");
        $("#csv2-upload-ok").click(async (e) => {
            const file = $("#fileInput")[0].files[0];
            if (!file) {
                alert("ファイルが選択されていません。");
                return;
            }
            csvName_advance2 = file.name;

            $("#load_overlay").show();
            const formData = new FormData();
            formData.append("file", file);

            try {
                const response = await fetch(`/api/upload_od_data/${open_key}`, {
                    method: "POST",
                    body: formData,
                    headers: {
                        "X-CSRFToken": getCookie("csrftoken"),
                    },
                    credentials: "include",
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();

                if (result.message != "OK") {
                    csvLoaded_advance1 = false;
                    alert(result.message);
                    $("#load_overlay").hide();
                    return;
                }

                csvLoaded_advance1 = true;
                alert("CSVデータのアップロードが完了しました。");

                csvLoaded_advance2 = true;

                $("#click_info").empty();

                history.add("ODデータ読み込み");
                isochronemode = false;

                $("#overlay_inner_button2").click();
            } catch (error) {
                console.error("Upload failed:", error);
                alert("アップロードに失敗しました。もう一度お試しください。");
            }
            $("#load_overlay").hide();
        });

        $("#csv2-upload-cancel").off("click");
        $("#csv2-upload-cancel").click((e) => {
            $("#overlay_inner_button2").click();
        });

        return false;
    };
    const get_advance2_data_init = async () => {
        let url = `/api/get_od_data_dateonly/${open_key}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Network response was not ok [${open_key}]`);
        let r = await response.json();

        let od_select = "<h5>起点/終点からのOD流動図</h5>";
        od_select += "<table class='table table-sm'>";
        od_select += "<tr>";
        od_select += "<td>クリックした停留所</td>";
        od_select += "<td>";
        od_select += "<label><input type='radio' name='od_val' value='0' checked>起点</label>";
        od_select += "<label><input type='radio' name='od_val' value='1'>終点</label>";
        od_select += "</td>";
        od_select += "</tr>";
        od_select += "<tr>";
        od_select += "<td style='vertical-align: middle;'>日にち</td>";
        od_select += "<td>";
        od_select += "<select name='od_date' class='form-select form-select-sm'>";
        for (let i = 0; i < r.dates.length; i++) {
            od_select += "<option value='" + r.dates[i] + "'>" + r.dates_f[i] + "</option>";
        }
        od_select += "<option value=''>全て</option>";
        od_select += "</select>";
        od_select += "</td>";
        od_select += "</tr>";
        od_select += "</table>";
        od_select +=
            "<div id='od_legend'><div style='height:50%;display:flex;align-items:center;justify-content:center;'><p style='padding:10px;'>基準となる停留所を地図上で選択してください</p></div></div>";

        $("#click_info").html(od_select);

        $("[name=od_val]")
            .off("change")
            .on("change", (e) => {
                od_cache = { loaded: false };
                get_advance2_data_line([]);
            });
        $("[name=od_date]")
            .off("change")
            .on("change", (e) => {
                od_cache = { loaded: false };
                overlay.setPosition(undefined);
                get_advance2_data_line([]);
            });
        $("#load_overlay").hide();
        $("[name=od_date]").change();
    };

    let od_cache = { loaded: false };
    const get_advance2_data_line = async (advance2_stops) => {
        overlay.setPosition(undefined);
        if (advance2_stops.length == 0) {
            advance2_start_stopname = "\t";
            advance2_start_val = 0;
            $("#od_legend").html("基準となる停留所を地図上で選択してください");
            $("#od_table").html("");
            $("#load_overlay").hide();
        }

        let od_val = $("[name=od_val]:checked").val();
        let od_date = $("[name=od_date]").val();
        if (od_date == "") od_date = "ALL";
        od_date = od_date.replaceAll("/", "-");

        odLayerUpload.getSource().clear();
        odLayerUploadLine.getSource().clear();

        let r_data = {};
        if (od_cache.loaded) {
            r_data = od_cache.data;
        } else {
            $("#od_legend").html("");
            $("#od_table").html("");
            $("#load_overlay").show();

            let url = `/api/get_od_data/${open_key}/${od_date}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Network response was not ok [${open_key}]`);
            let r = await response.json();

            r_data = r.data;
            od_cache.data = r_data;
            od_cache.loaded = true;
        }
        odLayerUpload.getSource().clear();
        odLayerUploadLine.getSource().clear();

        const uniqueStopNames = Array.from(new Set(r_data.flatMap((item) => [item.stopname_geton, item.stopname_getoff]))).map((stopname) => ({ stopname }));

        const layerStopNames = layer_aggregator_stops
            .getSource()
            .getFeatures()
            .map((feature) => feature.get("similar_stop_name"));
        const excludedStopNames = layerStopNames.filter((stopname) => !uniqueStopNames.includes(stopname));
        excludedStopNames.forEach((item) => {
            let ed_point = layer_aggregator_stops
                .getSource()
                .getFeatures()
                .filter((f) => f.get("similar_stop_name") == item)[0];
            if (!ed_point) return;
            let goff_coords = ed_point.getGeometry().getCoordinates();
            let point_feature = new ol.Feature({
                geometry: ed_point.getGeometry(),
                count: 0,
                stopname: item.stopname,
                stopid: ed_point.get("similar_stop_id"),
            });
            point_feature.setStyle(
                new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: 3,
                        fill: new ol.style.Fill({
                            color: "#999",
                        }),
                        stroke: new ol.style.Stroke({
                            color: "#ffffff",
                            width: 1,
                        }),
                    }),
                })
            );
            odLayerUpload.getSource().addFeature(point_feature);
        });

        uniqueStopNames.forEach((item) => {
            let ed_point = layer_aggregator_stops
                .getSource()
                .getFeatures()
                .filter((f) => f.get("similar_stop_name") == item.stopname)[0];
            if (!ed_point) return;
            let goff_coords = ed_point.getGeometry().getCoordinates();
            let point_feature = new ol.Feature({
                geometry: ed_point.getGeometry(),
                count: 0,
                stopname: item.stopname,
                stopid: ed_point.get("similar_stop_id"),
            });
            point_feature.setStyle(
                new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: 5,
                        fill: new ol.style.Fill({
                            color: od_val == "0" ? "#0000ff" : "#ff0000",
                        }),
                        stroke: new ol.style.Stroke({
                            color: "#ffffff",
                            width: 2,
                        }),
                    }),
                })
            );
            odLayerUpload.getSource().addFeature(point_feature);
        });

        odLayerUploadLine.setVisible(true);
        odLayerUpload.setVisible(true);

        if (advance2_stops.length == 0) {
            $("#od_legend").html("基準となる停留所を地図上で選択してください");
            $("#od_table").html("");
            $("#load_overlay").hide();
            return;
        }

        let oq_stopname = advance2_stops[0].stopname;
        getonoff_object = r_data.filter((item) => item.stopname_geton == oq_stopname);
        let reduce_name_object = getonoff_object.reduce((acc, item) => {
            if (!acc[item.stopname_getoff]) acc[item.stopname_getoff] = 0;
            acc[item.stopname_getoff] += item.count;
            return acc;
        }, {});
        if (od_val == "1") {
            getonoff_object = r_data.filter((item) => item.stopname_getoff == oq_stopname);
            reduce_name_object = getonoff_object.reduce((acc, item) => {
                if (!acc[item.stopname_geton]) acc[item.stopname_geton] = 0;
                acc[item.stopname_geton] += item.count;
                return acc;
            }, {});
        }
        if (Object.values(reduce_name_object).length == 0) {
            $("#od_legend").html("基準となる停留所を地図上で選択してください");
            $("#od_table").html("");
            $("#load_overlay").hide();
            return;
        }

        let maxValue = Math.max(...Object.values(reduce_name_object));
        let ranked_object = Object.fromEntries(
            Object.entries(reduce_name_object).map(([key, value]) => {
                const percentage = (value / maxValue) * 100;

                let category = 5;
                if (percentage >= 50) category = 4;
                if (percentage >= 75) category = 3;
                if (percentage >= 80) category = 2;
                if (percentage >= 95) category = 1;

                return [
                    key,
                    {
                        value: value,
                        category: category,
                    },
                ];
            })
        );

        let st_point = layer_aggregator_stops
            .getSource()
            .getFeatures()
            .filter((f) => f.get("similar_stop_name") == oq_stopname)[0];
        let gon_coords = st_point.getGeometry().getCoordinates();
        let od_color = "#ff0000";
        let legend_table =
            `<table class='table table-sm table-bordered'>` +
            `<tr>` +
            `<th style='padding:2px; text-align: center; vertical-align: middle;'>表記</th>` +
            `<th style='padding:2px; text-align: center; vertical-align: middle;'>利用者数</th>` +
            `</tr>`;
        if (Object.entries(ranked_object).filter((item) => item[1].category == 1).length > 0) {
            legend_table +=
                `<tr>` +
                `<td style='color:${od_val == "0" ? od_color : "#0000ff"}; font-size:20px; text-align: center; vertical-align: middle;'>●</td>` +
                `<td>${Math.round(maxValue * 0.95)} - ${Math.round(maxValue * 1.0)}</td>` +
                `</tr>`;
        }
        if (Object.entries(ranked_object).filter((item) => item[1].category == 2).length > 0) {
            legend_table +=
                `<tr>` +
                `<td style='color:${od_val == "0" ? od_color : "#0000ff"}; font-size:16px; text-align: center; vertical-align: middle;'>●</td>` +
                `<td>${Math.round(maxValue * 0.85)} - ${Math.round(maxValue * 0.95)}</td>` +
                `</tr>`;
        }
        if (Object.entries(ranked_object).filter((item) => item[1].category == 3).length > 0) {
            legend_table +=
                `<tr>` +
                `<td style='color:${od_val == "0" ? od_color : "#0000ff"}; font-size:12px; text-align: center; vertical-align: middle;'>●</td>` +
                `<td>${Math.round(maxValue * 0.7)} - ${Math.round(maxValue * 0.85)}</td>` +
                `</tr>`;
        }
        if (Object.entries(ranked_object).filter((item) => item[1].category == 4).length > 0) {
            legend_table +=
                `<tr>` +
                `<td style='color:${od_val == "0" ? od_color : "#0000ff"}; font-size:8px; text-align: center; vertical-align: middle;'>●</td>` +
                `<td>${Math.round(maxValue * 0.5)} - ${Math.round(maxValue * 0.7)}</td>` +
                `</tr>`;
        }
        if (Object.entries(ranked_object).filter((item) => item[1].category == 5).length > 0) {
            legend_table +=
                `<tr>` +
                `<td style='color:${od_val == "0" ? od_color : "#0000ff"}; font-size:6px; text-align: center; vertical-align: middle;'>●</td>` +
                `<td>1 - ${Math.round(maxValue * 0.5)}</td>` +
                `</tr>`;
        }
        legend_table += `</table>` + `<div id='od_table'></div>`;
        $("#od_legend").html(legend_table);

        let st_sum = getonoff_object.reduce((acc, item) => {
            acc += item.count;
            return acc;
        }, 0);

        let od_text = "<p>stop_name:" + oq_stopname + "</p>";
        od_text += "<p>" + (od_val == "0" ? "起点利用者人数" : "終点利用者人数") + ":" + st_sum + "</p>";
        $("#popup-content").html(od_text);
        overlay.setPosition(gon_coords);

        let st_point_feature = new ol.Feature({
            geometry: st_point.getGeometry(),
            count: st_sum,
            stopname: oq_stopname,
        });
        st_point_feature.setStyle(
            new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 5,
                    fill: new ol.style.Fill({
                        color: od_val == "0" ? "#0000ff" : od_color,
                    }),
                    stroke: new ol.style.Stroke({
                        color: "#ffffff",
                        width: 2,
                    }),
                }),
            })
        );
        odLayerUpload.getSource().addFeature(st_point_feature);

        let od_list_table = "<h6>" + (od_val == "1" ? "終点" : "起点") + "</h6>";
        od_list_table += "<table class='table table-sm table-bordered'>";
        od_list_table += "<tr>";
        od_list_table += "<th style='padding:2px; text-align: center; vertical-align: middle;'>stop_name</th>";
        od_list_table += "<th style='padding:2px; text-align: center; vertical-align: middle; width: 90px;'>" + (od_val == "1" ? "降車人数" : "乗車人数") + "</th>";
        od_list_table += "</tr>";
        od_list_table += "<tr>";
        od_list_table += `<td class="advance2_stop-name" data-advance2_stop-name="${oq_stopname}">${oq_stopname}</td>`;
        od_list_table += "<td>" + st_sum + "</td>";
        od_list_table += "</tr>";
        od_list_table += "</table>";
        od_list_table += "<h6>" + (od_val == "0" ? "終点" : "起点") + "</h6>";
        od_list_table += "<table class='table table-sm table-bordered'>";
        od_list_table += "<tr>";
        od_list_table += "<th style='padding:2px; text-align: center; vertical-align: middle;'>stop_name</th>";
        od_list_table += "<th style='padding:2px; text-align: center; vertical-align: middle; width: 90px;'>" + (od_val == "0" ? "降車人数" : "乗車人数") + "</th>";
        od_list_table += "</tr>";
        advance2_start_stopname = oq_stopname;
        advance2_start_val = st_sum;
        $(document).off("click", ".advance2_stop-name");
        $(document).on("click", ".advance2_stop-name", function (e) {
            const stopName = $(this).data("advance2_stop-name");
            zoomTo_advance2Stop(stopName);
        });
        Object.entries(reduce_name_object)
            .sort((a, b) => b[1] - a[1])
            .forEach((item) => {
                let ed_point = layer_aggregator_stops
                    .getSource()
                    .getFeatures()
                    .filter((f) => f.get("similar_stop_name") == item[0])[0];
                if (!ed_point) return;
                let goff_coords = ed_point.getGeometry().getCoordinates();

                let point_feature = new ol.Feature({
                    geometry: ed_point.getGeometry(),
                    count: item[1],
                    stopname: item,
                });
                let radius = 11;
                if (item[1] < maxValue * 0.95) radius = 9;
                if (item[1] < maxValue * 0.85) radius = 7;
                if (item[1] < maxValue * 0.7) radius = 5;
                if (item[1] < maxValue * 0.5) radius = 3;

                point_feature.setStyle(
                    new ol.style.Style({
                        image: new ol.style.Circle({
                            radius: radius,
                            fill: new ol.style.Fill({
                                color: od_val == "0" ? od_color : "#0000ff",
                            }),
                            stroke: new ol.style.Stroke({
                                color: "#ffffff",
                                width: 2,
                            }),
                        }),
                    })
                );
                odLayerUpload.getSource().addFeature(point_feature);

                let line_feature = new ol.Feature({
                    geometry: new ol.geom.LineString([gon_coords, goff_coords]),
                    count: item[1],
                    stopname_geton: oq_stopname,
                    stopname_getoff: item[0],
                });

                let width = 9;
                if (item[1] < maxValue * 0.95) width = 7;
                if (item[1] < maxValue * 0.85) width = 5;
                if (item[1] < maxValue * 0.7) width = 3;
                if (item[1] < maxValue * 0.5) width = 1;

                line_feature.setStyle(
                    new ol.style.Style({
                        stroke: new ol.style.Stroke({
                            color: "rgba(0, 0, 255, 0.5)",
                            width: width,
                        }),
                    })
                );
                odLayerUploadLine.getSource().addFeature(line_feature);

                od_list_table += "<tr>";
                od_list_table += `<td class="advance2_stop-name" data-advance2_stop-name="${item[0]}">${item[0]}</td>`;
                od_list_table += "<td>" + item[1] + "</td>";
                od_list_table += "</tr>";
            });
        od_list_table += "</table>";

        $("#od_table").html(od_list_table);

        $("#load_overlay").hide();
    };

    advance2.onclick = async () => {
        if (csvLoaded_advance2 == false) {
            alert("ODデータの読み込みを行ってください。");
            return;
        }
        onadvance2();
        offcanvas.hide();
        clearOnMenuClick();

        menu_mode = "advance2";

        $("#load_overlay").show();

        overlay.setPosition(undefined);
        map.removeLayer(到達圏域LayerGroup);

        map.getLayers().forEach((lyr) => {
            clearLayerVisible(lyr);
        });
        if (basic2theme == 1) {
            layer_鉄道輸送密度B.setVisible(true);
        } else {
            layer_鉄道輸送密度A.setVisible(true);
        }

        odLayerGroup.setVisible(true);
        odLayerUpload.getSource().clear();
        odLayerUpload.setVisible(true);

        railroadLayerGroup3.setVisible(false);

        busLayerGroup_setVisible(true);
        地理院Layer.setVisible(true);
        baseLayerGroup.setVisible(true);

        layer_aggregator_stops
            .getSource()
            .getFeatures()
            .forEach((f) => {
                f.set("selected", false);
            });

        odLayerUpload.getSource().clear();
        odLayerUploadLine.getSource().clear();

        $("#mode_exit").removeClass("d-none");
        $("#mode_info").text("表示中：起点/終点からのOD流動図");
        $("#mode_exit_button").text("分析結果クリア");
        history.add("停留所利用者数の可視化");
        isochronemode = false;

        $("#click_info").empty();
        await get_advance2_data_init();
        return false;
    };

    const get_advance2_2_data_init = async () => {
        if (layer_aggregator_stops.getVisible()) layer_aggregator_stops.setVisible(false);
        let url = `/api/get_od_data_dateonly/${open_key}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Network response was not ok [${open_key}]`);
        let r = await response.json();

        let od_select = "<h5>バス停間OD</h5>";
        od_select += "<table class='table table-sm'>";
        od_select += "<tr>";
        od_select += "<td style='vertical-align: middle;'>日にち</td>";
        od_select += "<td>";
        od_select += "<select name='od_date' class='form-select form-select-sm'>";
        for (let i = 0; i < r.dates.length; i++) {
            od_select += "<option value='" + r.dates[i] + "'>" + r.dates_f[i] + "</option>";
        }
        od_select += "<option value=''>全て</option>";
        od_select += "</select>";
        od_select += "</td>";
        od_select += "</tr>";
        od_select += "</table>";

        od_select += "<table class='table table-sm'>";
        od_select += "<tr>";
        od_select += "<td>";
        od_select += "<label><input type='checkbox' id='od_rank_1' name='od_rank' checked>TOP 10</label>";
        od_select += "</td>";
        od_select += "</tr>";
        od_select += "<tr>";
        od_select += "<td>";
        od_select += "<label><input type='checkbox' id='od_rank_2' name='od_rank' checked>TOP 20</label>";
        od_select += "</td>";
        od_select += "</tr>";
        od_select += "<tr>";
        od_select += "<td>";
        od_select += "<label><input type='checkbox' id='od_rank_3' name='od_rank' checked>TOP 30</label>";
        od_select += "</td>";
        od_select += "</tr>";
        od_select += "<tr>";
        od_select += "<td>";
        od_select += "<label><input type='checkbox' id='od_rank_4' name='od_rank' checked>TOP 40</label>";
        od_select += "</td>";
        od_select += "</tr>";
        od_select += "<tr>";
        od_select += "<td>";
        od_select += "<label><input type='checkbox' id='od_rank_5' name='od_rank' checked>Other</label>";
        od_select += "</td>";
        od_select += "</tr>";
        od_select += "</table>";
        od_select += "<div id='od_legend'></div>";
        od_select += "<div id='od_list'></div>";

        $("#click_info").html(od_select);

        $("[name=od_date]")
            .off("change")
            .on("change", (e) => {
                overlay.setPosition(undefined);
                $("#load_overlay").show();
                get_advance2_2_data_point();
            });
        $("[name=od_rank]")
            .off("change")
            .on("change", (e) => {
                overlay.setPosition(undefined);
                $("#load_overlay").show();
                get_advance2_2_data_point();
            });

        $("#load_overlay").hide();
        $("[name=od_rank]").change();
    };
    const get_advance2_2_data_point = async () => {
        if (layer_aggregator_stops.getVisible()) layer_aggregator_stops.setVisible(false);
        $("#od_legend").html("");
        $("#od_table").html("");
        odLayerUpload.getSource().clear();
        odLayerUploadLine.getSource().clear();

        let od_date = $("[name=od_date]").val();
        if (!od_date) od_date = "ALL";
        od_date = od_date.replaceAll("/", "-");

        let url = `/api/get_od_data/${open_key}/${od_date}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Network response was not ok [${open_key}]`);
        let r = await response.json();

        let od_rank1 = $("#od_rank_1").prop("checked");
        let od_rank2 = $("#od_rank_2").prop("checked");
        let od_rank3 = $("#od_rank_3").prop("checked");
        let od_rank4 = $("#od_rank_4").prop("checked");
        let od_rank5 = $("#od_rank_5").prop("checked");

        let sted_reduce_name_object = r.data.reduce((acc, item) => {
            if (!acc[item.stopname_geton + "_" + item.stopname_getoff])
                acc[item.stopname_geton + "_" + item.stopname_getoff] = {
                    stopname_geton: item.stopname_geton,
                    stopname_getoff: item.stopname_getoff,
                    count: 0,
                };
            acc[item.stopname_geton + "_" + item.stopname_getoff].count += item.count;
            return acc;
        }, {});
        sted_reduce_name_object = Object.values(sted_reduce_name_object)
            .sort((a, b) => b.count - a.count)
            .map((item, index) => ({ ...item, rank: index + 1 }));

        let sted_max_count = Math.max(...sted_reduce_name_object.flat().map((item) => item.count));
        let legend_table =
            `<table class='table table-sm table-bordered'>` +
            `<tr>` +
            `<th style='padding:2px; text-align: center; vertical-align: middle;'>表記</th>` +
            `<th style='padding:2px; text-align: center; vertical-align: middle;'>利用者数</th>` +
            `</tr>` +
            `<tr>` +
            `<td style='vertical-align: middle;'>` +
            `<div style="width: 30px; height: 9px; background-color: rgba(0,0,255,0.9); margin: 0 auto;"></div>` +
            `</td>` +
            `<td>${Math.round(sted_max_count * 0.95) + 1} - ${Math.round(sted_max_count * 1.0)}</td>` +
            `</tr>` +
            `<tr>` +
            `<td style='vertical-align: middle;'>` +
            `<div style="width: 30px; height: 7px; background-color: rgba(0,0,255,0.7); margin: 0 auto;"></div>` +
            `</td>` +
            `<td>${Math.round(sted_max_count * 0.85) + 1} - ${Math.round(sted_max_count * 0.95)}</td>` +
            `</tr>` +
            `<tr>` +
            `<td style='vertical-align: middle;'>` +
            `<div style="width: 30px; height: 5px; background-color: rgba(0,0,255,0.5); margin: 0 auto;"></div>` +
            `</td>` +
            `<td>${Math.round(sted_max_count * 0.7) + 1} - ${Math.round(sted_max_count * 0.85)}</td>` +
            `</tr>` +
            `<tr>` +
            `<td style='vertical-align: middle;'>` +
            `<div style="width: 30px; height: 3px; background-color: rgba(0,0,255,0.3); margin: 0 auto;"></div>` +
            `</td>` +
            `<td>${Math.round(sted_max_count * 0.5) + 1} - ${Math.round(sted_max_count * 0.7)}</td>` +
            `</tr>` +
            `<tr>` +
            `<td style='vertical-align: middle;'>` +
            `<div style="width: 30px; height: 1px; background-color: rgba(0,0,255,0.1); margin: 0 auto;"></div>` +
            `</td>` +
            `<td>1 - ${Math.round(sted_max_count * 0.5)}</td>` +
            `</tr>` +
            `</table>`;
        $("#od_legend").html(legend_table);

        const filteredData = sted_reduce_name_object.filter((item) => {
            if (od_rank1 && item.rank <= 10) return true;
            if (od_rank2 && item.rank > 10 && item.rank <= 20) return true;
            if (od_rank3 && item.rank > 20 && item.rank <= 30) return true;
            if (od_rank4 && item.rank > 30 && item.rank <= 40) return true;
            if (od_rank5 && item.rank > 40) return true;
            return false;
        });

        odLayerUpload.getSource().clear();
        odLayerUploadLine.getSource().clear();
        Object.values(filteredData).forEach((item) => {
            let gon_object = layer_aggregator_stops
                .getSource()
                .getFeatures()
                .filter((f) => f.get("similar_stop_name") == item.stopname_geton)[0];
            if (!gon_object) return;
            let gon_coords = gon_object.getGeometry().getCoordinates();
            let goff_object = layer_aggregator_stops
                .getSource()
                .getFeatures()
                .filter((f) => f.get("similar_stop_name") == item.stopname_getoff)[0];
            if (!goff_object) return;
            let goff_coords = goff_object.getGeometry().getCoordinates();

            let line_feature = new ol.Feature({
                geometry: new ol.geom.LineString([gon_coords, goff_coords]),
                count: item.count,
                stopid_geton: item.stopid_geton,
                stopname_geton: item.stopname_geton,
                stopid_getoff: item.stopid_getoff,
                stopname_getoff: item.stopname_getoff,
            });

            let width = 9;
            if (item.count < sted_max_count * 0.95) width = 7;
            if (item.count < sted_max_count * 0.85) width = 5;
            if (item.count < sted_max_count * 0.7) width = 3;
            if (item.count < sted_max_count * 0.5) width = 1;

            line_feature.setStyle(
                new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: "rgba(0, 0, 255, 0." + width + ")",
                        width: width,
                    }),
                })
            );
            odLayerUploadLine.getSource().addFeature(line_feature);
        });
        odLayerUploadLine.setVisible(true);
        odLayerUpload.setVisible(true);

        $("#load_overlay").hide();
    };

    advance2_2.onclick = async () => {
        if (csvLoaded_advance2 == false) {
            alert("ODデータの読み込みを行ってください。");
            return;
        }
        onadvance2();
        offcanvas.hide();
        clearOnMenuClick();

        menu_mode = "advance2_2";

        $("#load_overlay").show();

        overlay.setPosition(undefined);
        map.removeLayer(到達圏域LayerGroup);

        map.getLayers().forEach((lyr) => {
            clearLayerVisible(lyr);
        });
        if (basic2theme == 1) {
            layer_鉄道輸送密度B.setVisible(true);
        } else {
            layer_鉄道輸送密度A.setVisible(true);
        }
        odLayerGroup.setVisible(true);
        odLayerUpload.getSource().clear();
        odLayerUpload.setVisible(true);

        railroadLayerGroup3.setVisible(false);

        地理院Layer.setVisible(true);
        baseLayerGroup.setVisible(true);

        $("#mode_exit").removeClass("d-none");
        $("#mode_info").text("表示中：バス停間OD");
        $("#mode_exit_button").text("分析結果クリア");
        history.add("バス停間ODの可視化");
        isochronemode = false;

        await get_advance2_2_data_init();
        return false;
    };

    const get_advance2_3_popup = async (stops) => {
        if (stops.length == 0) {
            overlay.setPosition(undefined);
            return;
        }

        let od_val = $("[name=od_val]:checked").val();
        let od_date = $("[name=od_date]").val();
        if (!od_date) od_date = "ALL";
        od_date = od_date.replaceAll("/", "-");

        let url = `/api/get_od_data/${open_key}/${od_date}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Network response was not ok [${open_key}]`);
        let r = await response.json();

        let st_reduce_name_object = r.data.reduce((acc, item) => {
            if (!acc[item.stopname_geton])
                acc[item.stopname_geton] = {
                    stopname_geton: item.stopname_geton,
                    stopname_getoff: item.stopname_getoff,
                    count: 0,
                };
            acc[item.stopname_geton].count += item.count;
            return acc;
        }, {});
        let ed_reduce_name_object = r.data.reduce((acc, item) => {
            if (!acc[item.stopname_getoff])
                acc[item.stopname_getoff] = {
                    stopname_geton: item.stopname_geton,
                    stopname_getoff: item.stopname_getoff,
                    count: 0,
                };
            acc[item.stopname_getoff].count += item.count;
            return acc;
        }, {});

        let st_filter_object = Object.values(st_reduce_name_object).filter((item) => stops[0].stopname == item.stopname_geton);
        let ed_filter_object = Object.values(ed_reduce_name_object).filter((item) => stops[0].stopname == item.stopname_getoff);

        let pn_text = "";
        pn_text += "<p>stop_name:" + stops[0].stopname + "</p>";
        pn_text += "<p>乗車人数と降車人数の合計:" + ((st_filter_object.length == 0 ? 0 : st_filter_object[0].count) + (ed_filter_object.length == 0 ? 0 : ed_filter_object[0].count)) + "</p>";
        pn_text += "<p>乗車人数:" + (st_filter_object.length == 0 ? 0 : st_filter_object[0].count) + "</p>";
        pn_text += "<p>降車人数:" + (ed_filter_object.length == 0 ? 0 : ed_filter_object[0].count) + "</p>";
        $("#popup-content").html(pn_text);
    };

    const get_advance2_3_data_point = async () => {
        $("#od_legend").html("");
        $("#od_table").html("");
        odLayerUpload.getSource().clear();
        $("#load_overlay").show();

        let od_val = $("[name=od_val]:checked").val();
        let od_date = $("[name=od_date]").val();
        if (!od_date) od_date = "ALL";
        od_date = od_date.replaceAll("/", "-");

        let legend_table = "";
        let od_table = "";

        let url = `/api/get_od_data/${open_key}/${od_date}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Network response was not ok [${open_key}]`);
        let r = await response.json();

        let r_data = r.data;

        let st_reduce_name_object = r_data.reduce((acc, item) => {
            if (!acc[item.stopname_geton])
                acc[item.stopname_geton] = {
                    stopname_geton: item.stopname_geton,
                    stopname_getoff: item.stopname_getoff,
                    count: 0,
                };
            acc[item.stopname_geton].count += item.count;
            return acc;
        }, {});
        let ed_reduce_name_object = r_data.reduce((acc, item) => {
            if (!acc[item.stopname_getoff])
                acc[item.stopname_getoff] = {
                    stopname_geton: item.stopname_geton,
                    stopname_getoff: item.stopname_getoff,
                    count: 0,
                };
            acc[item.stopname_getoff].count += item.count;
            return acc;
        }, {});

        if (od_val == "-1") {
            let combined_object = { ...st_reduce_name_object };
            for (let key in ed_reduce_name_object) {
                if (combined_object[key]) {
                    combined_object[key].count_on = combined_object[key].count || 0;
                    combined_object[key].count_off = ed_reduce_name_object[key].count || 0;
                    combined_object[key].count = combined_object[key].count_on + combined_object[key].count_off;
                } else {
                    combined_object[key] = {
                        ...ed_reduce_name_object[key],
                        count_on: 0,
                        count_off: ed_reduce_name_object[key].count || 0,
                        count: ed_reduce_name_object[key].count || 0,
                    };
                }
            }
            let result_name_object = Object.values(combined_object).sort((a, b) => b.count - a.count);
            let sum_max_count = result_name_object[0].count;
            legend_table +=
                "<h6>合計</h6>" +
                `<table class='table table-sm table-bordered'>` +
                `<tr>` +
                `<th style='padding:2px; text-align: center; vertical-align: middle;'>表記</th>` +
                `<th style='padding:2px; text-align: center; vertical-align: middle;'>利用者数</th>` +
                `<th style='padding:2px; text-align: center; vertical-align: middle;'>停留所数</th>` +
                `</tr>` +
                `<tr>` +
                `<td style='color:#FF9600; font-size:22px; text-align: center; vertical-align: middle;'>●</td>` +
                `<td>5000 ～</td>` +
                `<td>${result_name_object.filter((item) => item.count > 5000).length}件` +
                `(${((result_name_object.filter((item) => item.count > 5000).length / result_name_object.length) * 100).toFixed(1)}%)` +
                `</td>` +
                `</tr>` +
                `<tr>` +
                `<td style='color:#FF9600; font-size:18px; text-align: center; vertical-align: middle;'>●</td>` +
                `<td>1000 ～</td>` +
                `<td>${result_name_object.filter((item) => 1000 <= item.count && item.count < 5000).length}件` +
                `(${((result_name_object.filter((item) => 1000 <= item.count && item.count < 5000).length / result_name_object.length) * 100).toFixed(1)}%)` +
                `</td>` +
                `</tr>` +
                `<tr>` +
                `<td style='color:#FF9600; font-size:14px; text-align: center; vertical-align: middle;'>●</td>` +
                `<td>100 ～</td>` +
                `<td>${result_name_object.filter((item) => 100 <= item.count && item.count < 1000).length}件` +
                `(${((result_name_object.filter((item) => 100 <= item.count && item.count < 1000).length / result_name_object.length) * 100).toFixed(1)}%)` +
                `</td>` +
                `</tr>` +
                `<tr>` +
                `<td style='color:#FF9600; font-size:12px; text-align: center; vertical-align: middle;'>●</td>` +
                `<td>50 ～</td>` +
                `<td>${result_name_object.filter((item) => 50 <= item.count && item.count < 100).length}件` +
                `(${((result_name_object.filter((item) => 50 <= item.count && item.count < 100).length / result_name_object.length) * 100).toFixed(1)}%)` +
                `</td>` +
                `</tr>` +
                `<tr>` +
                `<td style='color:#FF9600; font-size:10px; text-align: center; vertical-align: middle;'>●</td>` +
                `<td>1 ～</td>` +
                `<td>${result_name_object.filter((item) => item.count < 50).length}件` +
                `(${((result_name_object.filter((item) => item.count < 50).length / result_name_object.length) * 100).toFixed(1)}%)` +
                `</td>` +
                `</tr>` +
                `</table>`;

            legend_table +=
                "<table class='table table-sm table-bordered'>" +
                "<tr>" +
                "<th style='font-size: 12px; text-align: center; vertical-align: middle;'>停留所名</th>" +
                "<th style='font-size: 12px; text-align: center; vertical-align: middle;'>乗車人数</th>" +
                "<th style='font-size: 12px; text-align: center; vertical-align: middle;'>降車人数</th>" +
                "<th style='font-size: 12px; text-align: center; vertical-align: middle;'>利用者数(起点・終点)</th>" +
                "</tr>";
            result_name_object.forEach((item) => {
                if (item.count_on == undefined) item.count_on = 0;
                if (item.count_off == undefined) item.count_off = 0;
                legend_table += "<tr>";
                legend_table += `<td class="advance2_stop-name" data-advance2_stop-name="${item.stopname_geton}">${item.stopname_geton}</td>`;
                legend_table += "<td>" + item.count_on + "</td>";
                legend_table += "<td>" + item.count_off + "</td>";
                legend_table += "<td>" + item.count + "</td>";
                legend_table += "</tr>";
            });
            legend_table += "</table>";

            $(document).off("click", ".advance2_stop-name");
            $(document).on("click", ".advance2_stop-name", function (e) {
                const stopName = $(this).data("advance2_stop-name");
                zoomToAggregatorStop2(stopName);
            });

            result_name_object.map((item) => {
                let g_object = layer_aggregator_stops
                    .getSource()
                    .getFeatures()
                    .filter((f) => f.get("similar_stop_name") == item.stopname_geton)[0];
                if (!g_object) return;
                let g_coords = g_object.getGeometry().getCoordinates();
                let g_feature = new ol.Feature({
                    geometry: g_object.getGeometry(),
                    count: item.count,
                    stopname: item.stopname_geton,
                });
                let radius = 13;
                if (1000 <= item.count && item.count < 5000) radius = 11;
                if (100 <= item.count && item.count < 1000) radius = 9;
                if (50 <= item.count && item.count < 100) radius = 7;
                if (item.count < 50) radius = 5;
                g_feature.setStyle(
                    new ol.style.Style({
                        image: new ol.style.Circle({
                            radius: radius,
                            fill: new ol.style.Fill({
                                color: "#FF9600",
                            }),
                            stroke: new ol.style.Stroke({
                                color: "#ffffff",
                                width: 2,
                            }),
                        }),
                    })
                );
                odLayerUpload.getSource().addFeature(g_feature);
            });
        }
        if (od_val == "0") {
            st_reduce_name_object = Object.values(st_reduce_name_object).sort((a, b) => b.count - a.count);

            let st_max_count = st_reduce_name_object[0].count;
            legend_table +=
                "<h6>起点</h6>" +
                `<table class='table table-sm table-bordered'>` +
                `<tr>` +
                `<th style='padding:2px; text-align: center; vertical-align: middle;'>表記</th>` +
                `<th style='padding:2px; text-align: center; vertical-align: middle;'>利用者数</th>` +
                `<th style='padding:2px; text-align: center; vertical-align: middle;'>停留所数</th>` +
                `</tr>` +
                `<tr>` +
                `<td style='color:#0000ff; font-size:22px; text-align: center; vertical-align: middle;'>●</td>` +
                `<td>1000 ～</td>` +
                `<td>` +
                `${st_reduce_name_object.filter((item) => item.count > 1000).length}件` +
                `(${((st_reduce_name_object.filter((item) => item.count > 1000).length / st_reduce_name_object.length) * 100).toFixed(1)}%)` +
                `</td>` +
                `</tr>` +
                `<tr>` +
                `<td style='color:#0000ff; font-size:18px; text-align: center; vertical-align: middle;'>●</td>` +
                `<td>500 ～</td>` +
                `<td>${st_reduce_name_object.filter((item) => 500 <= item.count && item.count < 1000).length}件` +
                `(${((st_reduce_name_object.filter((item) => 500 <= item.count && item.count < 1000).length / st_reduce_name_object.length) * 100).toFixed(1)}%)` +
                `</td>` +
                `</tr>` +
                `<tr>` +
                `<td style='color:#0000ff; font-size:14px; text-align: center; vertical-align: middle;'>●</td>` +
                `<td>100 ～</td>` +
                `<td>${st_reduce_name_object.filter((item) => 100 <= item.count && item.count < 500).length}件` +
                `(${((st_reduce_name_object.filter((item) => 100 <= item.count && item.count < 500).length / st_reduce_name_object.length) * 100).toFixed(1)}%)` +
                `</td>` +
                `</tr>` +
                `<tr>` +
                `<td style='color:#0000ff; font-size:12px; text-align: center; vertical-align: middle;'>●</td>` +
                `<td>50 ～</td>` +
                `<td>${st_reduce_name_object.filter((item) => 50 <= item.count && item.count < 100).length}件` +
                `(${((st_reduce_name_object.filter((item) => 50 <= item.count && item.count < 100).length / st_reduce_name_object.length) * 100).toFixed(1)}%)` +
                `</td>` +
                `</tr>` +
                `<tr>` +
                `<td style='color:#0000ff; font-size:10px; text-align: center; vertical-align: middle;'>●</td>` +
                `<td>1 ～</td>` +
                `<td>${st_reduce_name_object.filter((item) => item.count < 50).length}件` +
                `(${((st_reduce_name_object.filter((item) => item.count < 50).length / st_reduce_name_object.length) * 100).toFixed(1)}%)` +
                `</td>` +
                `</tr>` +
                `</table>`;

            st_reduce_name_object.map((item) => {
                let g_object = layer_aggregator_stops
                    .getSource()
                    .getFeatures()
                    .filter((f) => f.get("similar_stop_name") == item.stopname_geton)[0];
                if (!g_object) return;
                let g_coords = g_object.getGeometry().getCoordinates();
                let g_feature = new ol.Feature({
                    geometry: g_object.getGeometry(),
                    count: item.count,
                    stopname: item.stopname_geton,
                });
                let radius = 13;
                if (1000 <= item.count && item.count < 5000) radius = 11;
                if (100 <= item.count && item.count < 1000) radius = 9;
                if (50 <= item.count && item.count < 100) radius = 7;
                if (item.count < 50) radius = 5;
                g_feature.setStyle(
                    new ol.style.Style({
                        image: new ol.style.Circle({
                            radius: radius,
                            fill: new ol.style.Fill({
                                color: "#0000ff",
                            }),
                            stroke: new ol.style.Stroke({
                                color: "#ffffff",
                                width: 2,
                            }),
                        }),
                    })
                );
                odLayerUpload.getSource().addFeature(g_feature);
            });

            od_table += "<h6>起点</h6>";
            od_table += "<table class='table table-sm table-bordered'>";
            od_table += "<tr>";
            od_table += "<th style='padding:2px; text-align: center; vertical-align: middle;'>停留所名</th>";
            od_table += "<th style='padding:2px; text-align: center; vertical-align: middle;'>乗車人数</th>";
            od_table += "</tr>";
            st_reduce_name_object.forEach((item) => {
                od_table += "<tr>";
                od_table += `<td class="advance2_stop-name" data-advance2_stop-name="${item.stopname_geton}">${item.stopname_geton}</td>`;
                od_table += "<td>" + item.count + "</td>";
                od_table += "</tr>";
            });
            od_table += "</table>";
            $(document).off("click", ".advance2_stop-name");
            $(document).on("click", ".advance2_stop-name", function (e) {
                const stopName = $(this).data("advance2_stop-name");
                zoomToAggregatorStop2(stopName);
            });
        }
        if (od_val == "1") {
            ed_reduce_name_object = Object.values(ed_reduce_name_object).sort((a, b) => b.count - a.count);

            let ed_max_count = ed_reduce_name_object[0].count;
            legend_table +=
                "<h6>終点</h6>" +
                `<table class='table table-sm table-bordered'>` +
                `<tr>` +
                `<th style='padding:2px; text-align: center; vertical-align: middle;'>表記</th>` +
                `<th style='padding:2px; text-align: center; vertical-align: middle;'>利用者数</th>` +
                `<th style='padding:2px; text-align: center; vertical-align: middle;'>停留所数</th>` +
                `</tr>` +
                `<tr>` +
                `<td style='color:#ff0000; font-size:22px; text-align: center; vertical-align: middle;'>●</td>` +
                `<td>1000 ～</td>` +
                `<td>` +
                `${ed_reduce_name_object.filter((item) => item.count > 1000).length}件` +
                `(${((ed_reduce_name_object.filter((item) => item.count > 1000).length / ed_reduce_name_object.length) * 100).toFixed(1)}%)` +
                `</td>` +
                `</tr>` +
                `<tr>` +
                `<td style='color:#ff0000; font-size:18px; text-align: center; vertical-align: middle;'>●</td>` +
                `<td>500 ～</td>` +
                `<td>${ed_reduce_name_object.filter((item) => 500 <= item.count && item.count < 1000).length}件` +
                `(${((ed_reduce_name_object.filter((item) => 500 <= item.count && item.count < 1000).length / ed_reduce_name_object.length) * 100).toFixed(1)}%)` +
                `</td>` +
                `</tr>` +
                `<tr>` +
                `<td style='color:#ff0000; font-size:14px; text-align: center; vertical-align: middle;'>●</td>` +
                `<td>100 ～</td>` +
                `<td>${ed_reduce_name_object.filter((item) => 100 <= item.count && item.count < 500).length}件` +
                `(${((ed_reduce_name_object.filter((item) => 100 <= item.count && item.count < 500).length / ed_reduce_name_object.length) * 100).toFixed(1)}%)` +
                `</td>` +
                `</tr>` +
                `<tr>` +
                `<td style='color:#ff0000; font-size:12px; text-align: center; vertical-align: middle;'>●</td>` +
                `<td>50 ～</td>` +
                `<td>${ed_reduce_name_object.filter((item) => 50 <= item.count && item.count < 100).length}件` +
                `(${((ed_reduce_name_object.filter((item) => 50 <= item.count && item.count < 100).length / ed_reduce_name_object.length) * 100).toFixed(1)}%)` +
                `</td>` +
                `</tr>` +
                `<tr>` +
                `<td style='color:#ff0000; font-size:10px; text-align: center; vertical-align: middle;'>●</td>` +
                `<td>1 ～</td>` +
                `<td>${ed_reduce_name_object.filter((item) => item.count < 50).length}件` +
                `(${((ed_reduce_name_object.filter((item) => item.count < 50).length / ed_reduce_name_object.length) * 100).toFixed(1)}%)` +
                `</td>` +
                `</tr>` +
                `</table>`;

            ed_reduce_name_object.map((item) => {
                let g_object = layer_aggregator_stops
                    .getSource()
                    .getFeatures()
                    .filter((f) => f.get("similar_stop_name") == item.stopname_getoff)[0];
                if (!g_object) return;
                let g_coords = g_object.getGeometry().getCoordinates();
                let g_feature = new ol.Feature({
                    geometry: g_object.getGeometry(),
                    count: item.count,
                    stopname: item.stopname_getoff,
                });
                let radius = 13;
                if (1000 <= item.count && item.count < 5000) radius = 11;
                if (100 <= item.count && item.count < 1000) radius = 9;
                if (50 <= item.count && item.count < 100) radius = 7;
                if (item.count < 50) radius = 5;
                g_feature.setStyle(
                    new ol.style.Style({
                        image: new ol.style.Circle({
                            radius: radius,
                            fill: new ol.style.Fill({
                                color: "#ff0000",
                            }),
                            stroke: new ol.style.Stroke({
                                color: "#ffffff",
                                width: 2,
                            }),
                        }),
                    })
                );
                odLayerUpload.getSource().addFeature(g_feature);
            });

            od_table += "<h6>終点</h6>";
            od_table += "<table class='table table-sm table-bordered'>";
            od_table += "<tr>";
            od_table += "<th style='padding:2px; text-align: center; vertical-align: middle;'>停留所名</th>";
            od_table += "<th style='padding:2px; text-align: center; vertical-align: middle;'>降車人数</th>";
            od_table += "</tr>";
            ed_reduce_name_object.forEach((item) => {
                od_table += "<tr>";
                od_table += `<td class="advance2_stop-name" data-advance2_stop-name="${item.stopname_getoff}">${item.stopname_getoff}</td>`;
                od_table += "<td>" + item.count + "</td>";
                od_table += "</tr>";
            });
            od_table += "</table>";
            $(document).off("click", ".advance2_stop-name");
            $(document).on("click", ".advance2_stop-name", function (e) {
                const stopName = $(this).data("advance2_stop-name");
                zoomToAggregatorStop2(stopName);
            });
        }

        $("#od_legend").html(legend_table);
        $("#od_table").html(od_table);
        odLayerUpload.setVisible(true);
        odLayerUploadLine.setVisible(true);

        $("#load_overlay").hide();
    };
    const get_advance2_3_data = async () => {
        $("#od_legend").html("");
        $("#od_table").html("");
        odLayerUpload.getSource().clear();
        odLayerUploadLine.getSource().clear();

        let url = `/api/get_od_data_dateonly/${open_key}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Network response was not ok [${open_key}]`);
        let r = await response.json();

        let od_select = "<h5>OD利用者分布</h5>";
        od_select += "<table class='table table-sm'>";
        od_select += "<tr>";
        od_select += "<td>起点終点</td>";
        od_select += "<td class='d-flex justify-content-between'>";
        od_select += "<label><input type='radio' name='od_val' value='-1' checked>合計</label>";
        od_select += "<label><input type='radio' name='od_val' value='0'>起点のみ</label>";
        od_select += "<label><input type='radio' name='od_val' value='1'>終点のみ</label>";
        od_select += "</td>";
        od_select += "</tr>";
        od_select += "<tr>";
        od_select += "<td style='vertical-align: middle;'>日にち</td>";
        od_select += "<td>";
        od_select += "<select name='od_date' class='form-select form-select-sm'>";
        for (let i = 0; i < r.dates.length; i++) {
            od_select += "<option value='" + r.dates[i] + "'>" + r.dates_f[i] + "</option>";
        }
        od_select += "<option value=''>全て</option>";
        od_select += "</select>";
        od_select += "</td>";
        od_select += "</tr>";
        od_select += "</table>";
        od_select += "<div id='od_legend'></div>";
        od_select += "<div id='od_table'></div>";

        $("#click_info").html(od_select);

        $("[name=od_val]")
            .off("change")
            .on("change", (e) => {
                overlay.setPosition(undefined);
                get_advance2_3_data_point();
            });
        $("[name=od_date]")
            .off("change")
            .on("change", (e) => {
                overlay.setPosition(undefined);
                get_advance2_3_data_point();
            });
        $("[name=od_date]").change();
    };

    advance2_3.onclick = async () => {
        if (csvLoaded_advance2 == false) {
            alert("ODデータの読み込みを行ってください。");
            return;
        }
        onadvance2();
        offcanvas.hide();
        clearOnMenuClick();

        menu_mode = "advance2_3";

        $("#load_overlay").show();

        overlay.setPosition(undefined);
        map.removeLayer(到達圏域LayerGroup);
        map.getLayers().forEach((lyr) => {
            clearLayerVisible(lyr);
        });
        if (basic2theme == 1) {
            layer_鉄道輸送密度B.setVisible(true);
        } else {
            layer_鉄道輸送密度A.setVisible(true);
        }
        odLayerGroup.setVisible(true);
        odLayerUpload.getSource().clear();
        odLayerUpload.setVisible(true);

        railroadLayerGroup3.setVisible(false);

        地理院Layer.setVisible(true);
        baseLayerGroup.setVisible(true);

        $("#mode_exit").removeClass("d-none");
        $("#mode_info").text("表示中：OD利用者分布");
        $("#mode_exit_button").text("分析結果クリア");
        history.add("乗降者数の可視化");
        isochronemode = false;

        get_advance2_3_data();
        return false;
    };

    basic4a.onclick = () => {
        basic4mode = 1;
        menu_mode = "basic4a";
        basic4ab_click();
    };
    basic4b.onclick = () => {
        basic4mode = 2;
        menu_mode = "basic4b";
        basic4ab_click();
    };
    basic4ab_click = () => {
        onbasic();
        offcanvas.hide();
        overlay.setPosition(undefined);
        clearOnMenuClick();
        map.removeLayer(到達圏域LayerGroup);
        let content_str = `
                <fieldset class='fs-border'>
                    <legend class='col-form-label fs-border'>時刻設定</legend>
                        <div>
                            <input type="radio" id="time_setting1" name="time_setting" value="0" ${basic4timemode == 0 ? " checked" : ""} >
                                <label for="time_setting1">
                                    現在時刻で探索
                                </label>
                            <label style='display: flex;align-items: center;'>
                            <input type="radio" name="time_setting" value="1" ${basic4timemode == 1 ? " checked" : ""}>
                            <select id='basic4hour' style='flex-shrink: 0;width:90px;'
                                class="form-select form-select-sm"
                            >
                            ${Array.from({ length: 19 }, (_, i) => {
                                let time = 5 + i;
                                return `<option value='${time}' ${basic4hour == time ? " selected" : ""}>${time}</option>`;
                            }).join("")}
                            </select>
                            <span style='margin:4px;'>時</span>
                            <select id='basic4minute' style='flex-shrink: 0;width:90px;'
                                class="form-select form-select-sm"
                            >
                            ${Array.from({ length: 60 }, (_, i) => {
                                let time = 0 + i;
                                return `<option value='${time}' ${basic4minute == time ? " selected" : ""}>${time}</option>`;
                            }).join("")}
                            </select>
                            <span style='margin:4px;'>分</span>
                            <span style='margin:4px;'>で探索</span>
                            </label>
                        </div>
                </fieldset>`;
        if (basic4mode == 2) {
            content_str += `
                        <fieldset class='fs-border'>
                        <legend class='col-form-label fs-border'>発着の指定</legend>
                            <div style='margin-top:8px;'>
                                <input type="radio" id="da_setting1" name="da_setting" value="1" ${da_setting == 1 ? " checked" : ""}>
                                <label for="da_setting1" style=''>発</label>
                                <input type="radio" id="da_setting2" name="da_setting" value="2" ${da_setting == 2 ? " checked" : ""}>
                                <label for="da_setting2" style=''>着</label>
                            </div>
                        </fieldset>
                        <fieldset class='fs-border'>
                        <legend class='col-form-label fs-border'>徒歩移動距離の指定</legend>
                            <div style='margin-top:8px;'>
                                <input type='radio' id='rbmaxwd01' name='basic4maxwd' value='100' ${basic4maxwd == 100 ? " checked" : ""}>
                                <label for='rbmaxwd01' style='margin-left:4px;'>100m</label>
                                <input type='radio' id='rbmaxwd02' name='basic4maxwd' value='200' ${basic4maxwd == 200 ? " checked" : ""} style='margin-left:4px;'>
                                <label for='rbmaxwd02' style='margin-left:4px;'>200m</label>
                                <input type='radio' id='rbmaxwd03' name='basic4maxwd' value='300' ${basic4maxwd == 300 ? " checked" : ""} style='margin-left:4px;'>
                                <label for='rbmaxwd03' style='margin-left:4px;'>300m</label>
                                <input type='radio' id='rbmaxwd04' name='basic4maxwd' value='400' ${basic4maxwd == 400 ? " checked" : ""} style='margin-left:4px;'>
                                <label for='rbmaxwd04' style='margin-left:4px;'>400m</label>
                                <input type='radio' id='rbmaxwd05' name='basic4maxwd' value='500' ${basic4maxwd == 500 ? " checked" : ""} style='margin-left:4px;'>
                                <label for='rbmaxwd05' style='margin-left:4px;'>500m</label>
                                <br />
                                <input type='radio' id='rbmaxwd06' name='basic4maxwd' value='600' ${basic4maxwd == 600 ? " checked" : ""} style=''>
                                <label for='rbmaxwd06' style='margin-left:4px;'>600m</label>
                                <input type='radio' id='rbmaxwd07' name='basic4maxwd' value='700' ${basic4maxwd == 700 ? " checked" : ""} style='margin-left:4px;'>
                                <label for='rbmaxwd07' style='margin-left:4px;'>700m</label>
                                <input type='radio' id='rbmaxwd08' name='basic4maxwd' value='800' ${basic4maxwd == 800 ? " checked" : ""} style='margin-left:4px;'>
                                <label for='rbmaxwd08' style='margin-left:4px;'>800m</label>
                                <input type='radio' id='rbmaxwd09' name='basic4maxwd' value='900' ${basic4maxwd == 900 ? " checked" : ""} style='margin-left:4px;'>
                                <label for='rbmaxwd09' style='margin-left:4px;'>900m</label>
                                <input type='radio' id='rbmaxwd10' name='basic4maxwd' value='1000' ${basic4maxwd == 1000 ? " checked" : ""} style='margin-left:4px;'>
                                <label for='rbmaxwd10' style='margin-left:4px;'>1,000m</label>
                            </div>
                        </fieldset>`;
        }
        setPanelInfo("到達圏域分析" + (basic4mode == 1 ? "（バッファ）" : "（ネットワーク）"), (basic4mode == 1 ? "出発時刻" : "時刻と発着の別, 徒歩移動距離") + "を指定してください", content_str);

        $("#overlay_inner_button1").off("click");
        $("#overlay_inner_button1").click((e) => {
            alert("地図をクリックした位置から到達圏域分析を実行します。");
            $("#click_info").html("");
            map.getLayers().forEach((lyr) => {
                clearLayerVisible(lyr);
            });
            if (basic2theme == 1) {
                layer_鉄道輸送密度B.setVisible(true);
            } else {
                layer_鉄道輸送密度A.setVisible(true);
            }

            到達圏域LayerGroup.getLayers().clear();
            if (basic4mode == 1) {
                到達圏域LayerGroup.getLayers().push(到達圏域python);
                到達圏域LayerGroup.getLayers().push(markerLayer);
            } else {
                到達圏域LayerGroup.getLayers().push(到達圏域otp);
                到達圏域LayerGroup.getLayers().push(markerLayer);
            }
            map.getLayers().insertAt(4, 到達圏域LayerGroup);

            if (basic4mode == 1) {
                到達圏域python.setVisible(true);
                markerLayer.setVisible(true);
            } else {
                到達圏域otp.setVisible(true);
                markerLayer.setVisible(true);
            }
            layer_stops.setVisible(true);
            routesLayerGroup.setVisible(true);
            routesLayerGroup.getLayers().forEach((lyr) => {
                lyr.setVisible(true);
            });
            facilityLayerGroup.setVisible(true);
            病院Layer_name.setVisible(false);
            学校Layer_name.setVisible(false);
            baseLayerGroup.setVisible(true);
            地理院Layer.setVisible(true);

            if (basic4mode == 2) {
                basic4maxwd = Number($("input[name='basic4maxwd']:checked").val());
                da_setting = Number($("input[name='da_setting']:checked").val());
            }
            basic4hour = Number($("#basic4hour option:selected").val());
            basic4minute = Number($("#basic4minute option:selected").val());
            basic4timemode = Number($("input[name='time_setting']:checked").val());

            overlay_panel.style.display = "none";

            $("#mode_exit").removeClass("d-none");
            $("#mode_info").text("表示中：到達圏域分析");
            $("#mode_exit_button").text("分析結果クリア");
            history.add("到達圏域");
            isochronemode = true;

            到達圏域python.getLayers().clear();
            markerLayer.getSource().clear();
            到達圏域otp.getLayers().clear();

        });
        return false;
    };

    externalexport.onclick = () => {

        const args = createExternalExport();
        setPanelInfo("エクスポート", "出力するデータを指定してください", args);

        $("#overlay_inner_button1").off("click");
        $("#overlay_inner_button1").click((e) => {
            const selectedLayers = [];
            const selectedCSVs = [];
            const cb到達圏 = document.getElementById("dlcb到達圏域_g");

            for (var i = 0; i < document.exportForm.download_checkboxes.length; i++) {
                if (document.exportForm.download_checkboxes[i].checked) {
                    if (document.exportForm.download_checkboxes[i].id.endsWith("_g")) {
                        if (document.exportForm.download_checkboxes[i].id == "dlcbメッシュ人口_g") {
                            selectedLayers.push($("#typeメッシュ人口").val());
                        } else if (document.exportForm.download_checkboxes[i].id == "dlcbメッシュ5人口_g") {
                            selectedLayers.push($("#typeメッシュ5人口").val());
                        } else if (document.exportForm.download_checkboxes[i].id == "dlcb小地域人口_g") {
                            selectedLayers.push($("#type小地域人口").val());
                        } else if (document.exportForm.download_checkboxes[i].id == "dlcb利用交通手段_g") {
                            selectedLayers.push($("#type利用交通手段").val());
                        } else {
                            selectedLayers.push(document.exportForm.download_checkboxes[i].id);
                        }
                    } else {
                        selectedCSVs.push(document.exportForm.download_checkboxes[i].id);
                    }
                    flag = true;
                }
            }

            if (selectedLayers.length + selectedCSVs.length + (cb到達圏.checked ? 1 : 0) == 0) {
                alert("出力する項目を選択してください。");
            } else {

                let geojson = null;
                const format = new ol.format.GeoJSON();
                let features = null;
                if (basic4mode == 1) {
                    let allFeatures = [];

                    let layers = 到達圏域python.getLayers().getArray();

                    layers.forEach((layer) => {
                        let features = layer.getSource().getFeatures();
                        allFeatures.push(...features);
                    });
                    features = allFeatures;
                } else if (basic4mode == 2) {
                    features = 到達圏域otp_source.getFeatures();
                }
                if (cb到達圏.checked) {
                    if (features == null || features.length == 0) {
                        alert("出力対象となる到達圏域の図形がありません。");
                        return;
                    }

                    geojson = format.writeFeatures(features, {
                        dataProjection: "EPSG:4326",
                        featureProjection: "EPSG:3857",
                    });
                } else {
                    geojson = null;
                }

                let dl_filename = "export.zip";

                if (cb到達圏.checked && selectedLayers.length == 1 && selectedCSVs.length == 0) {
                    dl_filename = "isochrone.geojson";
                } else if (cb到達圏.checked == false && selectedLayers.length == 1 && selectedCSVs.length == 0) {
                    dl_filename = selectedLayers[0].replace("dlcb", "").replace("_g", "") + ".geojson";
                } else if (cb到達圏.checked == false && selectedLayers.length == 0 && selectedCSVs.length == 1) {
                    dl_filename = selectedCSVs[0].replace("dlcb", "").replace("_c", "") + ".csv";
                }

                $("#load_overlay").show();
                try {
                    fetch("/api/download_exportfile", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": "{{ csrf_token }}",
                        },
                        body: JSON.stringify({
                            layers: selectedLayers,
                            csvs: selectedCSVs,
                            isochrone: geojson,
                            session_id: open_key,
                            pref: 16,
                            year: 2020,
                        }),
                    })
                        .then((response) => response.blob())
                        .then((blob) => {
                            $("#load_overlay").hide();
                            const url = window.URL.createObjectURL(blob);
                            const link = document.createElement("a");
                            link.href = url;
                            link.setAttribute("download", dl_filename);
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            window.URL.revokeObjectURL(url);
                        });
                } catch (error) {
                    $("#load_overlay").hide();
                    console.error("エクスポート時にエラーが発生しました：", error);
                }
                return;
            }
        });
        return false;
    };

    const createExternalExport = () => {
        let s = "";
        s += "<form name = 'exportForm' style='display:block'>";
        s += "    <ul>";
        s += "        <li>";
        s += "            <input type='checkbox' id='dlcb到達圏域_g' name='download_checkboxes' />";
        s += "            <label for='dlcb到達圏域_g'>到達圏解析 到達圏域（GeoJSON形式）</label><br>";
        s += "        </li>";

        s += "        <li>";
        s += "            <input type='checkbox' id='dlcb鉄道路線_g' name='download_checkboxes' />";
        s += "            <label for='dlcb鉄道路線_g'>鉄道路線（GeoJSON形式）</label><br>";
        s += "        </li>";

        let p利用交通手段 = "";
        if (利用交通手段_不詳Layer.getVisible()) p利用交通手段 = "利用交通手段不詳";
        if (利用交通手段_その他Layer.getVisible()) p利用交通手段 = "その他";
        if (利用交通手段_自転車Layer.getVisible()) p利用交通手段 = "自転車";
        if (利用交通手段_オートバイLayer.getVisible()) p利用交通手段 = "オートバイ";
        if (利用交通手段_ハイヤーLayer.getVisible()) p利用交通手段 = "ハイヤー_タクシー";
        if (利用交通手段_自家用車Layer.getVisible()) p利用交通手段 = "自家用車";
        if (利用交通手段_勤め先学Layer.getVisible()) p利用交通手段 = "勤め先_学校のバス";
        if (利用交通手段_乗合バスLayer.getVisible()) p利用交通手段 = "乗合バス";
        if (利用交通手段_鉄道電車Layer.getVisible()) p利用交通手段 = "鉄道_電車";
        if (利用交通手段_徒歩のみLayer.getVisible()) p利用交通手段 = "徒歩のみ";
        if (利用交通手段_総数Layer.getVisible()) p利用交通手段 = "総数";
        s += "        <li>";
        s += "            <input type='checkbox' id='dlcb利用交通手段_g' name='download_checkboxes' />";
        s += `            <input type="hidden" id="type利用交通手段" value="dlcb利用交通手段_${p利用交通手段}_g">`;
        s += `            <label for='dlcb利用交通手段_g'>利用交通手段：${p利用交通手段.replace("利用交通手段_", "")}（GeoJSON形式）</label><br>`;
        s += "        </li>";

        let pメッシュ人口 = "";
        if (人口総数Layer.getVisible()) pメッシュ人口 = "総数";
        if (人口総0to17Layer.getVisible()) pメッシュ人口 = "0to17";
        if (人口総18to64Layer.getVisible()) pメッシュ人口 = "18to64";
        if (人口総65to74Layer.getVisible()) pメッシュ人口 = "65to74";
        if (人口総75to94Layer.getVisible()) pメッシュ人口 = "75to94";
        s += "        <li>";
        s += "            <input type='checkbox' id='dlcbメッシュ人口_g' name='download_checkboxes' />";
        s += `            <input type="hidden" id="typeメッシュ人口" value="dlcbメッシュ人口${pメッシュ人口}_g">`;
        s += `            <label for='dlcbメッシュ人口_g'>人口（３次メッシュ）：${pメッシュ人口.replace("to", "～") + (pメッシュ人口.includes("to") ? "歳" : "")}（GeoJSON形式）</label><br>`;
        s += "        </li>";

        let pメッシュ5人口 = "";
        if (人口総数Layer5.getVisible()) pメッシュ5人口 = "総数";
        if (人口総0to17Layer5.getVisible()) pメッシュ5人口 = "0to17";
        if (人口総18to64Layer5.getVisible()) pメッシュ5人口 = "18to64";
        if (人口総65to74Layer5.getVisible()) pメッシュ5人口 = "65to74";
        if (人口総75to94Layer5.getVisible()) pメッシュ5人口 = "75to94";
        s += "        <li>";
        s += "            <input type='checkbox' id='dlcbメッシュ5人口_g' name='download_checkboxes' />";
        s += `            <input type="hidden" id="typeメッシュ5人口" value="dlcbメッシュ5人口${pメッシュ5人口}_g">`;
        s += `            <label for='dlcbメッシュ5人口_g'>人口（５次メッシュ）：${pメッシュ5人口.replace("to", "～") + (pメッシュ5人口.includes("to") ? "歳" : "")}（GeoJSON形式）</label><br>`;
        s += "        </li>";

        let p小地域人口 = "";
        if (小地域年齢Layer.getVisible()) p小地域人口 = "総数";
        if (小地域年齢0_19Layer.getVisible()) p小地域人口 = "0to19";
        if (小地域年齢20_59Layer.getVisible()) p小地域人口 = "20to59";
        if (小地域年齢60_74Layer.getVisible()) p小地域人口 = "60to74";
        if (小地域年齢75Layer.getVisible()) p小地域人口 = "gte75";
        s += "        <li>";
        s += "            <input type='checkbox' id='dlcb小地域人口_g' name='download_checkboxes' />";
        s += `            <input type="hidden" id="type小地域人口" value="dlcb小地域人口${p小地域人口}_g">`;
        s += `            <label for='dlcb小地域人口_g'>人口（小地域）：${
            p小地域人口.replace("to", "～").replace("gte", "") + (p小地域人口.includes("to") || p小地域人口.includes("gte") ? "歳" + (p小地域人口.includes("gte") ? "以上" : "") : "")
        }（GeoJSON形式）</label><br>`;
        s += "        </li>";

        s += "        <li>";
        s += "            <input type='checkbox' id='dlcbメッシュ人口及び世帯_c' name='download_checkboxes' />";
        s += "            <label for='dlcbメッシュ人口及び世帯_c'>メッシュ人口及び世帯（CSV形式）</label><br>";
        s += "        </li>";

        s += "        <li>";
        s += "            <input type='checkbox' id='dlcb運行本数集計_c' name='download_checkboxes' />";
        s += "            <label for='dlcb運行本数集計_c'>service_id別・時間別の運行本数（CSV形式）</label><br>";
        s += "        </li>";

        s += "    </ul>";
        s += "</form>";

        return s;
    };

    const doModoru = document.getElementById("overlay_inner_button2");

    doModoru.onclick = () => {
        overlay_panel.style.display = "none";
        return false;
    };

    const setPanelInfo = (title, title2, content) => {
        const inner_title = document.getElementById("inner_title");
        const inner_title2 = document.getElementById("inner_title2");
        const inner_content = document.getElementById("inner_content");

        inner_title.textContent = title;
        inner_title2.textContent = title2;
        inner_content.innerHTML = content;

        $("#overlay_inner_button1").show();
        $("#overlay_inner_button2").show();

        if ($("#inner_content_container").hasClass("overflow-y-scroll") == false) {
            $("#inner_content_container").addClass("overflow-y-scroll");
        }
        overlay_panel.style.display = "block";
    };

    const setCSVPanelInfo = (title, title2, content) => {
        const inner_title = document.getElementById("inner_title");
        const inner_title2 = document.getElementById("inner_title2");
        const inner_content = document.getElementById("inner_content");

        inner_title.textContent = title;
        inner_title2.textContent = title2;
        inner_content.innerHTML = content;

        $("#overlay_inner_button1").hide();
        $("#overlay_inner_button2").hide();

        if ($("#inner_content_container").hasClass("overflow-y-scroll")) {
            $("#inner_content_container").removeClass("overflow-y-scroll");
        }

        overlay_panel.style.display = "block";
    };

    const doExport = () => {};


    mode_exit_button.onclick = async () => {
        overlay.setPosition(undefined);
        menu_mode = "";
        routesLayerGroup.getLayers().forEach((l) => {
            l.getSource()
                .getFeatures()
                .forEach((f) => {
                    f.set("selected", false);
                    f.set("advance1a_mode", false);
                    f.set("advance1b_mode", false);
                });
        });
        layer_aggregator_stops
            .getSource()
            .getFeatures()
            .forEach((f) => {
                f.set("selected", false);
                f.set("advance1a_mode", false);
                f.set("advance1b_mode", false);
            });

        for (var hist of history) {
            switch (hist) {
                case "運行頻度図":
                    運行頻度図LayerGroup.setVisible(false);
                    aggregator_routesLayerGroup.setVisible(false);
                    railroadLayerGroup2.setVisible(false);
                    railroadLayerGroup2.getLayers().forEach(function (layer, i) {
                        layer.setVisible(false);
                    });
                    layer_rail_運行本数合計.setVisible(false);

                    railroadLayerGroup.setVisible(false);
                    railroadLayerGroup.getLayers().forEach(function (layer, i) {
                        layer.setVisible(false);
                    });

                    populatedLayerGroup.setVisible(false);
                    populatedLayerGroup5.setVisible(false);

                    if ($("#cbグラフ出力")) {
                        $("#cbグラフ出力").prop("checked", false);
                        $("#cbグラフ出力").prop("disabled", true);
                        $("label[for='cbグラフ出力']").css("color", "darkgrey");
                    }
                    break;

                case "交通分担":
                    利用交通手段LayerGroup.setVisible(false);
                    break;

                case "到達圏域":
                    map.removeLayer(到達圏域LayerGroup);
                    到達圏域python.setVisible(false);
                    到達圏域otp.setVisible(false);
                    markerLayer.setVisible(false);
                    break;

                case "停留所別乗降実績":
                    clear停留所別乗降実績();
                    break;

                case "時間帯別乗降実績":
                    clear時間帯別乗降実績();
                    break;

                case "停留所利用者数の可視化":
                case "バス停間ODの可視化":
                case "乗降者数の可視化":
                    odLayerUpload.getSource().clear();
                    odLayerUploadLine.getSource().clear();
                    odLayerUpload.setVisible(false);
                    advance2_start_stopname = "\t";
                    advance2_start_val = 0;
                    break;
            }
        }

        setLayersToDefault();

        $("#click_info").html("");
        isochronemode = false;
        $("#mode_exit").addClass("d-none");

        await init_agg_route_source(initial_service_id);
        setDefaultPanel();
    };

    menu_print.onclick = () => {
        let count = 0;
        let msg = "";
        if (利用交通手段LayerGroup.getVisible()) {
            count += 1;
            msg += ", 利用交通手段";
        }
        if (populatedLayerGroup.getVisible()) {
            count += 1;
            msg += ", 人口（３次メッシュ）";
        }
        if (populatedLayerGroup5.getVisible()) {
            count += 1;
            msg += ", 人口（５次メッシュ）";
        }
        if (小地域年齢LayerGroup.getVisible()) {
            count += 1;
            msg += ", 人口（小地域）";
        }

        if (count > 1) {
            msg = msg.substring(2);
            alert(msg + "は、\r\nいずれか1つのみチェックをONにしてください。");
            return;
        }


        var tileOperation = false;
        if (地理院Layer.getVisible() && baseLayerGroup.getVisible()) {
            tileOperation = true;
            tileOperation_start();
        }
        const args = createPrintToPDF();
        setPanelInfo("プリント", "用紙サイズを指定してください", args);

        $("#overlay_inner_button1").off("click");
        $("#overlay_inner_button1").click((e) => {
            printPaperSize = $("input[name='printPaperSize']:checked").val();
            callPDF(printPaperSize);
            if (tileOperation == true) tileOperation_end();
        });
        return false;
    };
    const createPrintToPDF = () => {
        let rgArea = $("#routes_graph");
        let a1Area = $("#advance1a_graph");
        let a1AreaB = $("#advance1b_graph_panel");
        let canvasCount = 0;
        if (rgArea) {
            $("#routes_graph canvas").each(function () {
                canvasCount += 1;
            });
        }
        if (a1Area) {
            $("#advance1a_graph canvas").each(function () {
                canvasCount += 1;
            });
        }
        if (a1AreaB) {
            $("#advance1b_graph_panel canvas").each(function () {
                canvasCount += 1;
            });
        }

        const s =
            "<fieldset class='fs-border'>" +
            "    <legend class='col-form-label fs-border'>用紙サイズ</legend>" +
            "    <input type='radio' id='rb用紙サイズ01' name='printPaperSize' value='A4' style='margin-top:12px;' " +
            (printPaperSize == "A4" ? " checked" : "") +
            ">" +
            "    <label for='rb用紙サイズ01' style='margin-left:4px;'>A4</label>" +
            "    <br />" +
            "    <input type='radio' id='rb用紙サイズ02' name='printPaperSize' value='A3'" +
            (printPaperSize == "A3" ? " checked" : "") +
            ">" +
            "    <label for='rb用紙サイズ02' style='margin-left:4px;'>A3</label>" +
            "    <br />" +
            "</fieldset>" +
            "<div>" +
            "    <input type='checkbox' id='cbグラフ出力' name='print_checkboxes' style='margin-left: 25px;' " +
            (canvasCount == 0 ? "" : "checked") +
            " " +
            (canvasCount == 0 ? "disabled" : "") +
            " />" +
            "    <label for='cbグラフ出力' style='color:" +
            (canvasCount == 0 ? "darkgrey" : "black") +
            ";'>グラフを出力する</label><br>" +
            "</div>";
        return s;
    };
</script>
<script>
    let 小地域Layer = new ol.layer.Tile({
        title: "小地域（町丁・字）",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "小地域",
                LAYERS: "traffic_info:app_choaza",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
            },
        }),
        baseLayer: true,
        visible: false,
    });
    let 市町村界Layer = new ol.layer.Tile({
        title: "市町村界",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "市町村界",
                LAYERS: "traffic_info:app_city",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
            },
        }),
        baseLayer: true,
        visible: false,
    });
    let 地理院src = new ol.source.XYZ({
        attributions: [
            "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>",
            '<a href="https://github.com/yuru7/udev-gothic" target="_blank">udev-gothic (SIL OFL)</a>',
            '<a href="https://moji.or.jp/ipafont/" target="_blank">BIZ UDゴシック (IPA Font License v1.0)</a>',
        ],
        url: "https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png",
        projection: "EPSG:3857",
        crossOrigin: "anonymous",
    });
    let 地理院Layer = new ol.layer.Tile({
        className: "gray-colour",
        title: "地理院タイル",
        source: 地理院src,
        baseLayer: true,
        visible: true,
    });
    let 地理院Layer_PDF = new ol.layer.Tile({
        title: "地理院タイル",
        source: 地理院src,
        baseLayer: true,
        visible: false,
        displayInLayerSwitcher: false,
    });
    地理院Layer_PDF.on("postrender", (e) => {
        let c = e.context;
        try {
            c.canvas.willReadFrequently = true;
            let imageData = c.getImageData(0, 0, c.canvas.width, c.canvas.height);
            for (let i = 0; i < imageData.data.length; i += 4) {
                let v = 0.2126 * imageData.data[i] + 0.7152 * imageData.data[i + 1] + 0.0722 * imageData.data[i + 2];
                imageData.data.set([v, v, v, 128], i);
            }
            c.putImageData(imageData, 0, 0);
        } catch (e) {
            console.log("CORS Canvas : " + e);
        }
    });
    let 地理院白地図Layer = new ol.layer.Tile({
        title: "白地図",
        source: new ol.source.XYZ({
            url: "https://cyberjapandata.gsi.go.jp/xyz/blank/{z}/{x}/{y}.png",
            attributions: ["<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>"],
            projection: "EPSG:3857",
            crossOrigin: "anonymous",
        }),
        baseLayer: true,
        visible: false,
    });
    let 地理院ベクトル地図Layer = new ol.layer.VectorTile({
        title: "地理院ベクトルタイル",
        declutter: true,
        source: new ol.source.VectorTile({
            url: "https://cyberjapandata.gsi.go.jp/xyz/experimental_bvmap/{z}/{x}/{y}.pbf",
            format: new ol.format.MVT({}),
            attributions: ["出典：<a href='https://www.gsi.go.jp/' target='_blank'>国土地理院ベクトルタイル提供実験</a>"],
        }),
        style: (feature, resolution) => {
            let e_style = new ol.style.Style({
                fill: new ol.style.Fill({
                    color: "rgba(245, 245, 245, 0.6)",
                }),
                stroke: new ol.style.Stroke({
                    color: "rgba(225, 225, 225, 0.6)",
                    width: 1,
                }),
            });

            if (feature.get("layer") == "road" || feature.get("layer") == "wstructurea") {
                let rdCtg = feature.get("rdCtg");
                let roadWidth = 1;
                if (rdCtg == 0) roadWidth = 2;
                if (rdCtg == 3) roadWidth = 3;
                e_style = new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: "#ee9999",
                        width: roadWidth,
                    }),
                    fill: new ol.style.Fill({
                        color: "#ffeeee",
                    }),
                });
            }
            if (feature.get("layer") == "railway") {
                let rtCode = feature.get("rtCode") || "";
                let rtColor = "rgba(160, 160, 160, 1)";
                if (feature.get("rtCode10") == "1") rtColor = "rgba(20, 40, 160, 1)";
                if (rtCode.startsWith("40201") || rtCode.startsWith("40216")) {
                    e_style = [
                        new ol.style.Style({
                            stroke: new ol.style.Stroke({
                                color: rtColor,
                                width: 3,
                            }),
                            zIndex: 1,
                        }),
                        new ol.style.Style({
                            stroke: new ol.style.Stroke({
                                color: "rgba(255, 255 , 255, 1)",
                                lineCap: "square",
                                lineDash: [20, 15],
                                width: 2,
                            }),
                            zIndex: 2,
                        }),
                    ];
                } else {
                    e_style = new ol.style.Style({
                        stroke: new ol.style.Stroke({
                            color: "rgba(127, 127 , 127, 1)",
                            width: 3,
                        }),
                    });
                }
            }

            if (feature.get("layer") == "label" && feature.get("annoCtg") == 110) {
                e_style = new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: "#aaffaa",
                        width: 2,
                    }),
                    fill: new ol.style.Fill({
                        color: "#eeffee",
                    }),
                    text: new ol.style.Text({
                        font: "24px sans-serif",
                        text: feature.get("annoChar"),
                        fill: new ol.style.Fill({
                            color: "rgba(0, 0, 0, 0.8)",
                        }),
                        stroke: new ol.style.Stroke({
                            color: "rgba(255, 255, 255, 0.8)",
                            width: 3,
                        }),
                    }),
                });
            }
            if (feature.get("layer") == "boundary" || feature.get("layer") == "coastline") {
                e_style = new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: "#666666",
                        width: 3,
                    }),
                });
            }
            if (feature.get("layer") == "river" || feature.get("layer") == "waterarea") {
                e_style = new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: "rgba(49, 159 ,211, 0.4)",
                        width: 1,
                    }),
                    fill: new ol.style.Fill({
                        color: "rgba(49, 159 ,211, 0.2)",
                    }),
                });
            } else {
            }
            return e_style;
        },
        baseLayer: true,
        visible: false,
    });
    let baseLayerGroup = new ol.layer.Group({
        title: "背景地図",
        openInLayerSwitcher: true,
        layers: [地理院Layer_PDF, 地理院Layer, 地理院白地図Layer, 地理院ベクトル地図Layer, 小地域Layer, 市町村界Layer],
    });

    let 人口総数Layer = new ol.layer.Tile({
        title: "総数　",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "メッシュ人口総数",
                LAYERS: "traffic_info:メッシュ人口総数",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
                CQL_FILTER: "prefs like '%[" + pref + "]%'",
            },
        }),
        opacity: 0.5,
        baseLayer: true,
    });
    let 人口総0to17Layer = new ol.layer.Tile({
        title: "0～17歳",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "メッシュ人口総数以外共通",
                LAYERS: "traffic_info:メッシュ人口0to17",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
                CQL_FILTER: "prefs like '%[" + pref + "]%'",
            },
        }),
        opacity: 0.5,
        baseLayer: true,
        visible: false,
    });
    let 人口総18to64Layer = new ol.layer.Tile({
        title: "18～64歳",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "メッシュ人口総数以外共通",
                LAYERS: "traffic_info:メッシュ人口18to64",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
                CQL_FILTER: "prefs like '%[" + pref + "]%'",
            },
        }),
        opacity: 0.5,
        baseLayer: true,
        visible: false,
    });
    let 人口総65to74Layer = new ol.layer.Tile({
        title: "65～74歳",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "メッシュ人口総数以外共通",
                LAYERS: "traffic_info:メッシュ人口65to74",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
                CQL_FILTER: "prefs like '%[" + pref + "]%'",
            },
        }),
        opacity: 0.5,
        baseLayer: true,
        visible: false,
    });
    let 人口総75to94Layer = new ol.layer.Tile({
        title: "75～94歳",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "メッシュ人口総数以外共通",
                LAYERS: "traffic_info:メッシュ人口75to94",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
                CQL_FILTER: "prefs like '%[" + pref + "]%'",
            },
        }),
        opacity: 0.5,
        baseLayer: true,
        visible: false,
    });
    let populatedLayerGroup = new ol.layer.Group({
        title: "人口（３次メッシュ）",
        openInLayerSwitcher: false,
        layers: [人口総75to94Layer, 人口総65to74Layer, 人口総18to64Layer, 人口総0to17Layer, 人口総数Layer],
        visible: false,
    });

    let 人口総数Layer5 = new ol.layer.Tile({
        title: "総数　　　　",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "メッシュ人口総数",
                LAYERS: "traffic_info:メッシュ5人口総数",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
                CQL_FILTER: "prefs like '%[" + pref + "]%'",
            },
        }),
        opacity: 0.5,
        baseLayer: true,
    });
    let 人口総0to17Layer5 = new ol.layer.Tile({
        title: "0～17歳",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "メッシュ人口総数以外共通",
                LAYERS: "traffic_info:メッシュ5人口0to17",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
                CQL_FILTER: "prefs like '%[" + pref + "]%'",
            },
        }),
        opacity: 0.5,
        baseLayer: true,
        visible: false,
    });
    let 人口総18to64Layer5 = new ol.layer.Tile({
        title: "18～64歳",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "メッシュ人口総数以外共通",
                LAYERS: "traffic_info:メッシュ5人口18to64",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
                CQL_FILTER: "prefs like '%[" + pref + "]%'",
            },
        }),
        opacity: 0.5,
        baseLayer: true,
        visible: false,
    });
    let 人口総65to74Layer5 = new ol.layer.Tile({
        title: "65～74歳",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "メッシュ人口総数以外共通",
                LAYERS: "traffic_info:メッシュ5人口65to74",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
                CQL_FILTER: "prefs like '%[" + pref + "]%'",
            },
        }),
        opacity: 0.5,
        baseLayer: true,
        visible: false,
    });
    let 人口総75to94Layer5 = new ol.layer.Tile({
        title: "75～94歳",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "メッシュ人口総数以外共通",
                LAYERS: "traffic_info:メッシュ5人口75to94",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
                CQL_FILTER: "prefs like '%[" + pref + "]%'",
            },
        }),
        opacity: 0.5,
        baseLayer: true,
        visible: false,
    });
    let populatedLayerGroup5 = new ol.layer.Group({
        title: "人口（５次メッシュ）",
        openInLayerSwitcher: false,
        layers: [人口総75to94Layer5, 人口総65to74Layer5, 人口総18to64Layer5, 人口総0to17Layer5, 人口総数Layer5],
        visible: false,
    });

    let 病院Style = new ol.style.Style({
        image: new ol.style.Circle({
            radius: 5,
            fill: new ol.style.Fill({
                color: "rgba(255, 255, 255, 1.0)",
            }),
            stroke: new ol.style.Stroke({
                color: "#ff0000",
                width: 2,
            }),
        }),
    });
    let 病院Layer_source = new ol.source.Vector({
        format: new ol.format.GeoJSON(),
        loader: (extent, resolution, projection) => {
            let url =
                "/geoserver/traffic_info/ows" +
                "?service=WFS" +
                "&version=1.1.0" +
                "&request=GetFeature" +
                "&typename=traffic_info:app_hospital" +
                "&outputFormat=application/json" +
                "&srsname=EPSG:3857" +
                `&CQL_FILTER=pref='${pref}' and p04_001=1`;
            fetch(url)
                .then((response) => response.json())
                .then((data) => {
                    病院Layer_source.addFeatures(
                        new ol.format.GeoJSON().readFeatures(data, {
                            featureProjection: projection,
                        })
                    );
                })
                .catch((error) => console.error("Error fetching data:", error));
        },
        strategy: ol.loadingstrategy.bbox,
    });
    let 病院Layer = new ol.layer.VectorImage({
        declutter: true,
        title: "病院",
        source: 病院Layer_source,
        style: 病院Style,
    });
    let 病院Layer_name = new ol.layer.Tile({
        title: "病院名（ラベル表示）",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "病院名",
                LAYERS: "traffic_info:app_hospital",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
                CQL_FILTER: "pref = " + pref + " and p04_001=1",
            },
        }),
        visible: false,
        displayInLayerSwitcher: false,
    });
    let 学校Style = new ol.style.Style({
        image: new ol.style.Circle({
            radius: 5,
            fill: new ol.style.Fill({
                color: "rgba(255, 255, 255, 1.0)",
            }),
            stroke: new ol.style.Stroke({
                color: "#003366",
                width: 2,
            }),
        }),
    });
    let 学校Layer_source = new ol.source.Vector({
        format: new ol.format.GeoJSON(),
        loader: (extent, resolution, projection) => {
            let url =
                "/geoserver/traffic_info/ows" +
                "?service=WFS" +
                "&version=1.1.0" +
                "&request=GetFeature" +
                "&typename=traffic_info:app_school" +
                "&outputFormat=application/json" +
                "&srsname=EPSG:3857" +
                `&CQL_FILTER=pref='${pref}' and p29_003 in('16002', '16003', '16004', '16005')`;
            fetch(url)
                .then((response) => response.json())
                .then((data) => {
                    学校Layer_source.addFeatures(
                        new ol.format.GeoJSON().readFeatures(data, {
                            featureProjection: projection,
                        })
                    );
                })
                .catch((error) => console.error("Error fetching data:", error));
        },
        strategy: ol.loadingstrategy.bbox,
    });
    let 学校Layer = new ol.layer.VectorImage({
        declutter: true,
        title: "学校",
        source: 学校Layer_source,
        style: 学校Style,
    });
    let 学校Layer_name = new ol.layer.Tile({
        title: "学校名（ラベル表示）",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "学校名",
                LAYERS: "traffic_info:app_school",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
                CQL_FILTER: "pref = " + pref + " and p29_003 in('16002', '16003', '16004', '16005')",
            },
        }),
        visible: false,
        displayInLayerSwitcher: false,
    });
    let facilityLayerGroup = new ol.layer.Group({
        title: "施設",
        openInLayerSwitcher: false,
        layers: [病院Layer, 学校Layer, 病院Layer_name, 学校Layer_name],
        visible: false,
    });

    let 小地域年齢Layer = new ol.layer.Tile({
        title: "総数 　",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "メッシュ人口総数",
                LAYERS: "traffic_info:小地域人口総数",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
                CQL_FILTER: "pref = " + pref,
            },
        }),
        opacity: 0.5,
        baseLayer: true,
    });
    let 小地域年齢0_19Layer = new ol.layer.Tile({
        title: "0～19歳",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "メッシュ人口総数以外共通",
                LAYERS: "traffic_info:小地域人口0to19",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
                CQL_FILTER: "pref = " + pref,
            },
        }),
        opacity: 0.5,
        baseLayer: true,
        visible: false,
    });
    let 小地域年齢20_59Layer = new ol.layer.Tile({
        title: "20～59歳",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "メッシュ人口総数以外共通",
                LAYERS: "traffic_info:小地域人口20to59",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
                CQL_FILTER: "pref = " + pref,
            },
        }),
        opacity: 0.5,
        baseLayer: true,
        visible: false,
    });
    let 小地域年齢60_74Layer = new ol.layer.Tile({
        title: "60～74歳",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "メッシュ人口総数以外共通",
                LAYERS: "traffic_info:小地域人口60to74",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
                CQL_FILTER: "pref = " + pref,
            },
        }),
        opacity: 0.5,
        baseLayer: true,
        visible: false,
    });
    let 小地域年齢75Layer = new ol.layer.Tile({
        title: "75歳以上",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "メッシュ人口総数以外共通",
                LAYERS: "traffic_info:小地域人口gte75",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
                CQL_FILTER: "pref=" + pref,
            },
        }),
        opacity: 0.5,
        baseLayer: true,
        visible: false,
    });

    let 小地域年齢LayerGroup = new ol.layer.Group({
        title: "人口（小地域）",
        openInLayerSwitcher: false,
        layers: [小地域年齢75Layer, 小地域年齢60_74Layer, 小地域年齢20_59Layer, 小地域年齢0_19Layer, 小地域年齢Layer],
        visible: false,
    });

    let 利用交通手段_その他Layer = new ol.layer.Tile({
        title: "その他",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "利用交通手段総数以外共通",
                LAYERS: "traffic_info:利用交通手段_その他",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
                CQL_FILTER: "pref = " + pref,
            },
        }),
        opacity: 0.5,
        baseLayer: true,
        visible: false,
    });
    let 利用交通手段_オートバイLayer = new ol.layer.Tile({
        title: "オートバイ",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "利用交通手段総数以外共通",
                LAYERS: "traffic_info:利用交通手段_オートバイ",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
                CQL_FILTER: "pref = " + pref,
            },
        }),
        opacity: 0.5,
        baseLayer: true,
        visible: false,
    });
    let 利用交通手段_ハイヤーLayer = new ol.layer.Tile({
        title: "ハイヤー・タクシー",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "利用交通手段総数以外共通",
                LAYERS: "traffic_info:利用交通手段_ハイヤー_タクシー",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
                CQL_FILTER: "pref = " + pref,
            },
        }),
        opacity: 0.5,
        baseLayer: true,
        visible: false,
    });
    let 利用交通手段_乗合バスLayer = new ol.layer.Tile({
        title: "乗合バス",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "利用交通手段総数以外共通",
                LAYERS: "traffic_info:利用交通手段_乗合バス",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
                CQL_FILTER: "pref = " + pref,
            },
        }),
        opacity: 0.5,
        baseLayer: true,
        visible: false,
    });
    let 利用交通手段_勤め先学Layer = new ol.layer.Tile({
        title: "勤め先・学校のバス",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "利用交通手段総数以外共通",
                LAYERS: "traffic_info:利用交通手段_勤め先_学校のバス",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
                CQL_FILTER: "pref = " + pref,
            },
        }),
        opacity: 0.5,
        baseLayer: true,
        visible: false,
    });
    let 利用交通手段_徒歩のみLayer = new ol.layer.Tile({
        title: "徒歩のみ",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "利用交通手段総数以外共通",
                LAYERS: "traffic_info:利用交通手段_徒歩のみ",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
                CQL_FILTER: "pref = " + pref,
            },
        }),
        opacity: 0.5,
        baseLayer: true,
        visible: false,
    });
    let 利用交通手段_自家用車Layer = new ol.layer.Tile({
        title: "自家用車",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "利用交通手段総数以外共通",
                LAYERS: "traffic_info:利用交通手段_自家用車",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
                CQL_FILTER: "pref = " + pref,
            },
        }),
        opacity: 0.5,
        baseLayer: true,
        visible: false,
    });
    let 利用交通手段_自転車Layer = new ol.layer.Tile({
        title: "自転車",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "利用交通手段総数以外共通",
                LAYERS: "traffic_info:利用交通手段_自転車",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
                CQL_FILTER: "pref = " + pref,
            },
        }),
        opacity: 0.5,
        baseLayer: true,
        visible: false,
    });
    let 利用交通手段_鉄道電車Layer = new ol.layer.Tile({
        title: "鉄道・電車",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "利用交通手段総数以外共通",
                LAYERS: "traffic_info:利用交通手段_鉄道_電車",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
                CQL_FILTER: "pref = " + pref,
            },
        }),
        opacity: 0.5,
        baseLayer: true,
        visible: false,
    });
    let 利用交通手段_総数Layer = new ol.layer.Tile({
        title: "総数",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "利用交通手段総数",
                LAYERS: "traffic_info:利用交通手段_総数",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
                CQL_FILTER: "pref = " + pref,
            },
        }),
        opacity: 0.5,
        baseLayer: true,
    });
    let 利用交通手段_不詳Layer = new ol.layer.Tile({
        title: "利用交通手段不詳",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "利用交通手段総数以外共通",
                LAYERS: "traffic_info:利用交通手段_利用交通手段不詳",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
                CQL_FILTER: "pref = " + pref,
            },
        }),
        opacity: 0.5,
        baseLayer: true,
        visible: false,
    });
    let 利用交通手段LayerGroup = new ol.layer.Group({
        title: "利用交通手段",
        openInLayerSwitcher: false,
        layers: [
            利用交通手段_不詳Layer,
            利用交通手段_その他Layer,
            利用交通手段_自転車Layer,
            利用交通手段_オートバイLayer,
            利用交通手段_ハイヤーLayer,
            利用交通手段_自家用車Layer,
            利用交通手段_勤め先学Layer,
            利用交通手段_乗合バスLayer,
            利用交通手段_鉄道電車Layer,
            利用交通手段_徒歩のみLayer,
            利用交通手段_総数Layer,
        ],
        visible: false,
    });

    let layer_rail_buffer300 = new ol.layer.Tile({
        title: "バッファ300m指定",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "鉄道バッファー",
                LAYERS: "traffic_info:富山県内鉄道＿バッファ300m指定",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
            },
        }),
        visible: false,
        opacity: 0.5,
    });
    let layer_rail_buffer600 = new ol.layer.Tile({
        title: "バッファ600m指定",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "鉄道バッファー",
                LAYERS: "traffic_info:富山県内鉄道＿バッファ600m指定",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
            },
        }),
        visible: false,
        opacity: 0.5,
    });
    let layer_rail_buffer800 = new ol.layer.Tile({
        title: "バッファ800m指定",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "鉄道バッファー",
                LAYERS: "traffic_info:富山県内鉄道＿バッファ800m指定",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
            },
        }),
        visible: false,
        opacity: 0.5,
    });
    let layer_rail_buffer600n = new ol.layer.Tile({
        title: "（地方）バッファ600m指定",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "鉄道バッファー",
                LAYERS: "traffic_info:富山地方鉄道（鉄道線）＿バッファ600m指定",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
            },
        }),
        visible: false,
        opacity: 0.5,
    });
    let layer_rail_buffer800n = new ol.layer.Tile({
        title: "（地方）バッファ800m指定",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "鉄道バッファー",
                LAYERS: "traffic_info:富山地方鉄道（鉄道線）＿バッファ800m指定",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
            },
        }),
        visible: false,
        opacity: 0.5,
    });
    let layer_stops_buffer300 = new ol.layer.Tile({
        title: "(バス停)バッファ300m指定",
        cacheSize: 0,
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            cacheSize: 0,
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "",
                LAYERS: "traffic_info:app_aggregator_stops_buffer300",
                exceptions: "application/vnd.ogc.se_blank",
                CQL_FILTER: "file_name='current'",
                tilesOrigin: -180 + "," + -90,
            },
        }),
        opacity: 0.5,
    });
    let bufferLayerGroup = new ol.layer.Group({
        title: "運行頻度バッファ",
        openInLayerSwitcher: false,
        layers: [layer_stops_buffer300, layer_rail_buffer800, layer_rail_buffer600, layer_rail_buffer300, layer_rail_buffer800n, layer_rail_buffer600n],
        visible: false,
    });

    let layer_rail_routes = new ol.layer.Tile({
        title: "鉄道路線",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "鉄道路線",
                LAYERS: "traffic_info:app_railroadsection",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
                CQL_FILTER: "prefs like '%[" + pref + "]%'",
            },
        }),
        visible: true,
    });
    let layer_rail_routes_name = new ol.layer.Tile({
        title: "鉄道路線名（ラベル表示）",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "鉄道路線名",
                LAYERS: "traffic_info:app_railroadsection",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
                CQL_FILTER: "prefs like '%[" + pref + "]%'",
            },
        }),
        visible: true,
        displayInLayerSwitcher: false,
    });
    let layer_rail_stops = new ol.layer.Tile({
        title: "鉄道駅",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "鉄道駅",
                LAYERS: "traffic_info:app_station",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
                CQL_FILTER: "prefs like '%[" + pref + "]%'",
            },
        }),
        visible: true,
    });
    let layer_rail_stops_name = new ol.layer.Tile({
        title: "鉄道駅名（ラベル表示）",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "鉄道駅名",
                LAYERS: "traffic_info:鉄道駅名用",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
                CQL_FILTER: "prefs like '%[" + pref + "]%'",
            },
        }),
        visible: true,
        displayInLayerSwitcher: false,
    });

    let layer_rail_運行本数合計 = new ol.layer.Tile({
        title: "順方向・逆方向合算",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "鉄道運行本数区間別合計2024",
                LAYERS: "traffic_info:鉄道運行本数区間別合計2024",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
                CQL_FILTER: "prefs like '%[" + pref + "]%'",
            },
        }),
        baseLayer: true,
        visible: true,
    });
    let layer_rail_運行本数順方向 = new ol.layer.Tile({
        title: "順方向",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "鉄道運行本数区間別順方向2024",
                LAYERS: "traffic_info:鉄道運行本数区間別順方向2024",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
                CQL_FILTER: "prefs like '%[" + pref + "]%'",
            },
        }),
        baseLayer: true,
        visible: false,
    });
    let layer_rail_運行本数逆方向 = new ol.layer.Tile({
        title: "逆方向",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "鉄道運行本数区間別逆方向2024",
                LAYERS: "traffic_info:鉄道運行本数区間別逆方向2024",
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
                CQL_FILTER: "prefs like '%[" + pref + "]%'",
            },
        }),
        baseLayer: true,
        visible: false,
    });
    let layer_鉄道輸送密度A = new ol.layer.Tile({
        title: "輸送密度・色別表示（鉄道）",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "鉄道輸送密度A",
                LAYERS: `traffic_info:鉄道輸送密度${basic2year}`,
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
            },
        }),
        baseLayer: true,
        visible: false,
    });
    let layer_鉄道輸送密度B = new ol.layer.Tile({
        title: "輸送密度・太さ別表示（鉄道）",
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "鉄道輸送密度B",
                LAYERS: `traffic_info:鉄道輸送密度${basic2year}`,
                exceptions: "application/vnd.ogc.se_blank",
                tilesOrigin: -180 + "," + -90,
            },
        }),
        baseLayer: true,
        visible: true,
    });
    let railroadLayerGroup2 = new ol.layer.Group({
        title: "運行頻度図（鉄道）",
        openInLayerSwitcher: false,
        layers: [layer_rail_運行本数逆方向, layer_rail_運行本数順方向, layer_rail_運行本数合計],
        visible: false,
    });
    let railroadLayerGroup3 = new ol.layer.Group({
        title: "輸送密度（鉄道）",
        openInLayerSwitcher: false,
        layers: [layer_鉄道輸送密度A, layer_鉄道輸送密度B],
        visible: false,
    });
    let odLayerUpload = new ol.layer.VectorImage({
        title: "ODデータ",
        source: new ol.source.Vector({}),
        visible: false,
    });
    let odLayerUploadLine = new ol.layer.VectorImage({
        title: "ODデータ ライン",
        source: new ol.source.Vector({}),
        openInLayerSwitcher: false,
        displayInLayerSwitcher: false,
        visible: true,
    });
    let odLayerGroup = new ol.layer.Group({
        title: "輸送密度",
        openInLayerSwitcher: false,
        displayInLayerSwitcher: false,
        layers: [odLayerUploadLine, odLayerUpload],
        visible: false,
    });
    let railroadLayerGroup = new ol.layer.Group({
        title: "鉄道",
        openInLayerSwitcher: false,
        layers: [layer_rail_routes, layer_rail_stops, layer_rail_routes_name, layer_rail_stops_name],
        visible: false,
    });

    const offsetLineString = (geometry, offset, resolution) => {
        let mapOffset = offset * resolution;
        if (mapOffset < 25) mapOffset *= 2;

        const coords = geometry.getCoordinates();
        const offsetCoords = [];

        for (let i = 0; i < coords.length - 1; i++) {
            const start = coords[i];
            const end = coords[i + 1];

            const dx = end[0] - start[0];
            const dy = end[1] - start[1];

            const length = Math.sqrt(dx * dx + dy * dy);
            const normalizedPerpX = -dy / length;
            const normalizedPerpY = dx / length;

            const offsetX = normalizedPerpX * mapOffset;
            const offsetY = normalizedPerpY * mapOffset;

            if (i === 0) {
                offsetCoords.push([start[0] + offsetX, start[1] + offsetY]);
            }
            offsetCoords.push([end[0] + offsetX, end[1] + offsetY]);
        }

        return new ol.geom.LineString(offsetCoords);
    };

    const ARLL_originalStyleFunction = (f, r) => {
        let frequency = f.get("frequency");
        let width = 1;
        if (frequency >= 10) width = 4;
        if (frequency >= 30) width = 7;

        let color = "#00af20";
        if (menu_mode == "advance1b") {
            width = 3;

            let during = f.get("during_ride");
            let getoff = f.get("count_getoff");
            let geton = f.get("count_geton");

            let during50 = f.get("during50");
            let during70 = f.get("during70");
            let during85 = f.get("during85");
            let during95 = f.get("during95");
            let getoff50 = f.get("getoff50");
            let getoff70 = f.get("getoff70");
            let getoff85 = f.get("getoff85");
            let getoff95 = f.get("getoff95");
            let geton50 = f.get("geton50");
            let geton70 = f.get("geton70");
            let geton85 = f.get("geton85");
            let geton95 = f.get("geton95");

            if ($("[name=stops_jisseki_onoff]:checked").val() == -1) {
                color = "#FFDEB3";
                if (during >= during50) color = "#FFCE8A";
                if (during >= during70) color = "#FFBC61";
                if (during >= during85) color = "#FFAA33";
                if (during >= during95) color = "#FF9600";
                if (f.get("selected") == true) width = 5;
            }
            if ($("[name=stops_jisseki_onoff]:checked").val() == 0) {
                color = "#80C1EA";
            }
            if ($("[name=stops_jisseki_onoff]:checked").val() == 1) {
                color = "#E9A5A8";
            }
        }
        if (menu_mode == "advance1a") width = 3;

        return new ol.style.Style({
            stroke: new ol.style.Stroke({
                color: color,
                width: width,
            }),
            geometry: (feature) => {
                const geometry = feature.getGeometry().clone();
                return offsetLineString(geometry, width, r);
            },
        });
    };

    let aggregator_routesLayerLines = new ol.layer.VectorImage({
        title: "運行頻度図（バス）",
        source: new ol.source.Vector({}),
        baseLayer: false,
        visible: true,
        style: ARLL_originalStyleFunction,
        openInLayerSwitcher: false,
        displayInLayerSwitcher: false,
    });
    let aggregator_routesLayerTexts = new ol.layer.Tile({
        title: "運行頻度図（バス）Frequency",
        source: new ol.source.TileWMS({}),
        baseLayer: false,
        visible: true,
        openInLayerSwitcher: false,
        displayInLayerSwitcher: false,
    });
    let aggregator_routesLayerGroup = new ol.layer.Group({
        title: "運行頻度図（バス）",
        openInLayerSwitcher: false,
        layers: [aggregator_routesLayerLines, aggregator_routesLayerTexts],
        visible: false,
    });
    aggregator_routesLayerGroup.on("change:visible", function (event) {
        updateSpecialLegend("運行頻度図（バス）", event.target.getVisible());
    });

    const update_agg_route_source = async () => {
        let service_id = $("[name=service_id]:checked").val();
        let time = -1;
        if ($("[name=allDay]:checked").val() == 1) time = $("#timeSelect").val();
        aggregator_routesLayerLines.setSource(
            new ol.source.Vector({
                format: new ol.format.GeoJSON(),
                url: (extent) => {
                    let url =
                        "/geoserver/traffic_info/wfs?" +
                        "service=WFS&" +
                        "version=1.1.0&" +
                        "request=GetFeature&" +
                        "typename=traffic_info:app_aggregator_routes&" +
                        "outputFormat=application/json&" +
                        "srsname=EPSG:3857&" +
                        `CQL_FILTER=file_name='${open_key}' and hour='${time}'`;
                    if (service_id != undefined) url += ` and service_id='${service_id}'`;
                    return url;
                },
                strategy: ol.loadingstrategy.bbox,
            })
        );
        let CQL_FILTER = `file_name='${open_key}' and hour='${time}'`;
        if (service_id != undefined) CQL_FILTER += ` and service_id='${service_id}'`;
        aggregator_routesLayerTexts.setSource(
            new ol.source.TileWMS({
                url: "/geoserver/traffic_info/wms",
                cacheSize: 0,
                params: {
                    FORMAT: "image/png",
                    tiled: true,
                    STYLES: "バス路線集計Frequency",
                    LAYERS: "traffic_info:app_aggregator_routes",
                    exceptions: "application/vnd.ogc.se_blank",
                    CQL_FILTER: CQL_FILTER,
                    tilesOrigin: -180 + "," + -90,
                },
            })
        );
    };

    let routesLayerGroup = new ol.layer.Group({
        title: "バス路線",
        openInLayerSwitcher: true,
        layers: [],
        visible: true,
    });
    let url =
        "/geoserver/traffic_info/ows" +
        "?service=WFS" +
        "&version=1.1.0" +
        "&request=GetFeature" +
        "&typename=traffic_info:app_merged_routes" +
        "&outputFormat=application/json" +
        "&srsname=EPSG:3857" +
        `&CQL_FILTER=file_name='${open_key}'`;
    fetch(url)
        .then((response) => response.json())
        .then((data) => {
            data.features.forEach((feature, index) => {
                const layer = new ol.layer.VectorImage({
                    title: feature.properties.route_id,
                    source: new ol.source.Vector({
                        features: new ol.format.GeoJSON().readFeatures({
                            type: "FeatureCollection",
                            features: [feature],
                        }),
                    }),
                    style: new ol.style.Style({
                        stroke: new ol.style.Stroke({
                            color: "#" + feature.properties.route_color,
                            width: 2,
                        }),
                    }),
                });
                routesLayerGroup.getLayers().push(layer);
                layer.on("change:visible", function (event) {
                    if (event.target.getVisible() && routesLayerGroup.getVisible() == false) {
                        routesLayerGroup.setVisible(true);
                    }
                });
            });
        })
        .catch((error) => console.error("Error fetching data:", error));

    let layer_stops_source = new ol.source.Vector({
        format: new ol.format.GeoJSON(),
        loader: (extent, resolution, projection) => {
            let url =
                "/geoserver/traffic_info/ows" +
                "?service=WFS" +
                "&version=1.1.0" +
                "&request=GetFeature" +
                "&typename=traffic_info:app_stops" +
                "&outputFormat=application/json" +
                "&srsname=EPSG:3857" +
                `&CQL_FILTER=file_name='${open_key}'`;
            fetch(url)
                .then((response) => response.json())
                .then((data) => {
                    layer_stops_source.addFeatures(
                        new ol.format.GeoJSON().readFeatures(data, {
                            featureProjection: projection,
                        })
                    );
                })
                .catch((error) => console.error("Error fetching data:", error));
        },
        strategy: ol.loadingstrategy.bbox,
    });

    let originalStyle = new ol.style.Style({
        image: new ol.style.Circle({
            radius: 4,
            fill: new ol.style.Fill({
                color: "rgba(255, 0, 0, 1.0)",
            }),
            stroke: new ol.style.Stroke({
                color: "#ffffff",
                width: 2,
            }),
        }),
    });

    const 標柱styleCache = {};
    const 標柱style = (feature, resolution) => {
        const zoom = parseInt(map.getView().getZoom());
        if (!標柱styleCache[zoom]) {
            let properties = feature?.getProperties();
            let f_text = properties && properties.j_count ? properties.j_count : "";
            const radius = zoom <= 13 ? 4 : zoom === 14 ? 5 : zoom === 15 ? 6 : zoom === 16 ? 7 : zoom === 17 ? 8 : zoom === 18 ? 9 : 10;
            標柱styleCache[zoom] = new ol.style.Style({
                image: new ol.style.Circle({
                    radius: radius,
                    fill: new ol.style.Fill({
                        color: "rgba(90, 91, 91, 1.0)",
                    }),
                    stroke: new ol.style.Stroke({
                        color: "#ffffff",
                        width: 2,
                    }),
                }),
                text: new ol.style.Text({
                    text: "" + f_text,
                    fill: new ol.style.Fill({ color: "#f00" }),
                    font: "12px sans-serif",
                    offsetY: -15,
                    offsetX: 10,
                }),
            });
        }

        return 標柱styleCache[zoom];
    };

    const 停留所styleCache = {};
    const 停留所style = (feature, resolution) => {
        const zoom = parseInt(map.getView().getZoom());
        if (!停留所styleCache[zoom]) {
            const radius = zoom <= 13 ? 4 : zoom === 14 ? 5 : zoom === 15 ? 6 : zoom === 16 ? 7 : zoom === 17 ? 8 : zoom === 18 ? 9 : 10;
            停留所styleCache[zoom] = new ol.style.Style({
                image: new ol.style.RegularShape({
                    fill: new ol.style.Fill({
                        color: "rgba(255, 94, 91, 1.0)",
                    }),
                    stroke: new ol.style.Stroke({
                        color: "#ffffff",
                        width: 2,
                    }),
                    points: 4,
                    radius: feature.get("selected") ? 10 : radius,
                    angle: 0,
                }),
            });
        }
        return 停留所styleCache[zoom];
    };

    let layer_stops = new ol.layer.VectorImage({
        title: "標柱",
        source: layer_stops_source,
        style: 標柱style,
        visible: false,
    });
    let layer_aggregator_stops = new ol.layer.VectorImage({
        title: "停留所",
        source: new ol.source.Vector({}),
        style: 停留所style,
        visible: true,
    });

    let layer_stops_name = new ol.layer.Tile({
        title: "停留所名（ラベル表示）",
        cacheSize: 0,
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            cacheSize: 0,
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "個別バス停名",
                LAYERS: "traffic_info:app_stops",
                exceptions: "application/vnd.ogc.se_blank",
                CQL_FILTER: "file_name='" + open_key + "'",
                tilesOrigin: -180 + "," + -90,
            },
        }),
        visible: false,
        displayInLayerSwitcher: false,
    });

    let layer_aggrigator_stops_name = new ol.layer.Tile({
        title: "停留所名寄せあり（ラベル表示）",
        cacheSize: 0,
        source: new ol.source.TileWMS({
            url: "/geoserver/traffic_info/wms",
            cacheSize: 0,
            params: {
                FORMAT: "image/png",
                tiled: true,
                STYLES: "バス停名",
                LAYERS: "traffic_info:app_aggregator_stops",
                exceptions: "application/vnd.ogc.se_blank",
                CQL_FILTER: "file_name='" + open_key + "'",
                tilesOrigin: -180 + "," + -90,
            },
        }),
        visible: false,
        displayInLayerSwitcher: false,
    });

    let busLayerGroup = new ol.layer.Group({
        title: "公共交通",
        openInLayerSwitcher: true,
        layers: [routesLayerGroup, layer_stops, layer_stops_name, layer_aggregator_stops, layer_aggrigator_stops_name],
        visible: true,
    });
    const busLayerGroup_setVisible = (visible) => {
        cl2pl_flag = true;
        busLayerGroup.setVisible(visible);
        cl2pl_flag = false;
    };
    let markerSource = new ol.source.Vector();
    let markerLayer = new ol.layer.VectorImage({
        title: "出発地点・到達地点",
        source: markerSource,
        openInLayerSwitcher: false,
        opacity: 0.75,
    });

    let 到達圏域otp_source = new ol.source.Vector({});
    let 到達圏域otp = new ol.layer.Group({
        title: "到達圏域分析（道路ネットワーク解析）",
        openInLayerSwitcher: true,
        opacity: 0.5,
        visible: true,
    });

    let 到達圏域python = new ol.layer.Group({
        title: "到達圏域分析（バッファ）",
        openInLayerSwitcher: true,
        opacity: 0.5,
        visible: true,
    });
    let 到達圏域LayerGroup = new ol.layer.Group({
        title: "到達圏域分析",
        openInLayerSwitcher: true,
        layers: [到達圏域python, 到達圏域otp, markerLayer],
        visible: true,
    });

    let 運行頻度図LayerGroup = new ol.layer.Group({
        title: "運行頻度図",
        openInLayerSwitcher: true,
        layers: [railroadLayerGroup2, aggregator_routesLayerGroup],
        visible: false,
    });

    let 実績Icon表示Layer = new ol.layer.VectorImage({
        title: "実績アイコン表示",
        source: new ol.source.Vector(),
        visible: false,
        displayInLayerSwitcher: false,
        openInLayerSwitcher: false,
    });
    let 実績数表示Layer = new ol.layer.VectorImage({
        title: "実績数表示",
        source: new ol.source.Vector(),
        style: (f, r) => {
            const properties = f.getProperties().properties;
            let t_text = properties.during_ride;
            if ($("[name=stops_jisseki_onoff]:checked").val() == "0") t_text = properties.count_geton;
            if ($("[name=stops_jisseki_onoff]:checked").val() == "1") t_text = properties.count_getoff;
            return new ol.style.Style({
                text: new ol.style.Text({
                    text: t_text ? t_text + "" : "0",
                    fill: new ol.style.Fill({ color: "#ff0000" }),
                    font: "12px sans-serif",
                    offsetY: -15,
                    offsetX: 10,
                }),
            });
        },
        visible: false,
        displayInLayerSwitcher: false,
        openInLayerSwitcher: false,
        declutter: true,
    });
</script>
<script>
    let map = new ol.Map({
        target: "map",
        overlays: [overlay],
        layers: [
            baseLayerGroup,
            小地域年齢LayerGroup,
            populatedLayerGroup,
            populatedLayerGroup5,
            利用交通手段LayerGroup,
            facilityLayerGroup,
            railroadLayerGroup,
            運行頻度図LayerGroup,
            railroadLayerGroup3,
            odLayerGroup,
            実績数表示Layer,
            実績Icon表示Layer,
            病院Layer_name,
            busLayerGroup,
        ],
        view: new ol.View({
            center: [15274807.48173176, 4396346.922493158],
            zoom: 13,
            minZoom: 5,
            maxZoom: 20,
            constrainResolution: true,
        }),
    });

    let ctrl = new ol.control.LayerSwitcher({
        target: $("#layer-switcher-div").get(0),
        collapsed: false,
        show_progress: true,
        reordering: false,
        extent: true,
        trash: false,
    });
    map.addControl(ctrl);

    let scaleLineControl = new ol.control.ScaleLine({
        units: "metric",
        bar: true,
        text: true,
        steps: 5,
        minWidth: 150,
        maxWidth: 150,
    });
    map.addControl(scaleLineControl);

    const info = document.getElementById("info");
    let currentFeature;
    const displayFeatureInfo = function (pixel, target) {
        const feature = target.closest(".ol-control")
            ? undefined
            : map.forEachFeatureAtPixel(pixel, function (feature) {
                  return feature;
              });
        if (feature && feature.get("stopname")) {
            info.style.left = pixel[0] + 15 + "px";
            info.style.top = pixel[1] + 15 + "px";
            if (feature !== currentFeature) {
                info.style.visibility = "visible";
                if (menu_mode == "advance2") {
                    var attr = feature.get("stopname");
                    var attr2 = "";
                    if (attr == advance2_start_stopname) {
                        attr2 = "\r\n起点からの輸送量：" + advance2_start_val;
                    } else {
                        if (Array.isArray(attr)) {
                            attr2 = "\r\n終点への輸送量：" + attr[1];
                            attr = attr[0];
                        }
                    }

                    info.innerText = attr + (attr2 == "" ? "" : attr2);
                } else if (menu_mode == "advance2_3") {
                    info.innerText = feature.get("stopname");
                }
            }
        } else if (feature && feature.get("similar_stop_name")) {
            info.style.left = pixel[0] + 15 + "px";
            info.style.top = pixel[1] + 15 + "px";
            if (feature !== currentFeature) {
                info.style.visibility = "visible";
                var attr = feature.get("similar_stop_name");
                info.innerText = attr;
            }
        } else {
            info.style.visibility = "hidden";
        }
        currentFeature = feature;
    };
</script>
<script>
    利用交通手段LayerGroup.on("change:visible", function (event) {
        updateLegend利用交通手段();
    });

    利用交通手段_不詳Layer.on("change:visible", function (l) {
        updateLegend利用交通手段();
    });
    利用交通手段_その他Layer.on("change:visible", function (l) {
        updateLegend利用交通手段();
    });
    利用交通手段_自転車Layer.on("change:visible", function (l) {
        updateLegend利用交通手段();
    });
    利用交通手段_オートバイLayer.on("change:visible", function (l) {
        updateLegend利用交通手段();
    });
    利用交通手段_ハイヤーLayer.on("change:visible", function (l) {
        updateLegend利用交通手段();
    });
    利用交通手段_自家用車Layer.on("change:visible", function (l) {
        updateLegend利用交通手段();
    });
    利用交通手段_勤め先学Layer.on("change:visible", function (l) {
        updateLegend利用交通手段();
    });
    利用交通手段_乗合バスLayer.on("change:visible", function (l) {
        updateLegend利用交通手段();
    });
    利用交通手段_鉄道電車Layer.on("change:visible", function (l) {
        updateLegend利用交通手段();
    });
    利用交通手段_徒歩のみLayer.on("change:visible", function (l) {
        updateLegend利用交通手段();
    });
    利用交通手段_総数Layer.on("change:visible", function (l) {
        updateLegend利用交通手段();
    });

    const updateLegend利用交通手段 = () => {
        let 総数visible = 利用交通手段_総数Layer.getVisible();
        let その他visible = !利用交通手段_総数Layer.getVisible();

        if (利用交通手段LayerGroup.getVisible() == false) {
            総数visible = false;
            その他visible = false;
        }

        updateSpecialLegend("利用交通手段（総数）", 総数visible);
        updateSpecialLegend("利用交通手段（総数以外共通）", その他visible);
    };

    railroadLayerGroup2.on("change:visible", function (event) {
        if (event.target.getVisible() == false) {
            forceSetLegend(layer_rail_運行本数合計, false);
            forceSetLegend(layer_rail_運行本数順方向, false);
            forceSetLegend(layer_rail_運行本数逆方向, false);
            return;
        }
        railroadLayerGroup2.getLayers().forEach(function (layer, i) {
            setLegend(layer);
        });
    });
    const updateLegend鉄道輸送密度 = () => {
        if (railroadLayerGroup3.getVisible() && odLayerGroup.getVisible()) {
            SetLegend(layer_鉄道輸送密度B);
            SetLegend(layer_鉄道輸送密度A);
        } else {
            forceSetLegend(layer_鉄道輸送密度B, false);
            forceSetLegend(layer_鉄道輸送密度A, false);
        }
    };
    railroadLayerGroup3.on("change:visible", function (event) {
        if (event.target.getVisible() == false) {
            forceSetLegend(layer_鉄道輸送密度B, false);
            forceSetLegend(layer_鉄道輸送密度A, false);

            return;
        }
        if (odLayerGroup.getVisible() == false) {
            odLayerGroup.setVisible(true);
        }
        railroadLayerGroup3.getLayers().forEach(function (layer, i) {
            setLegend(layer);
        });
    });
    odLayerGroup.on("change:visible", function (event) {
        if (event.target.getVisible() == false) {
            railroadLayerGroup3.setVisible(false);
            forceSetLegend(layer_鉄道輸送密度B, false);
            forceSetLegend(layer_鉄道輸送密度A, false);
            return;
        }
        railroadLayerGroup3.setVisible(true);
        railroadLayerGroup3.getLayers().forEach(function (layer, i) {
            setLegend(layer);
        });
    });
    layer_鉄道輸送密度A.on("change:visible", function (l) {
        if (layer_鉄道輸送密度A.getVisible()) basic2theme = 2;
        if (railroadLayerGroup3.getVisible() == false) {
            forceSetLegend(l.target, false);
            return;
        }
        setLegend(layer_鉄道輸送密度A);
    });
    layer_鉄道輸送密度B.on("change:visible", function (l) {
        if (layer_鉄道輸送密度B.getVisible()) basic2theme = 1;
        if (railroadLayerGroup3.getVisible() == false) {
            forceSetLegend(l.target, false);
            return;
        }
        setLegend(layer_鉄道輸送密度B);
    });
    layer_rail_運行本数合計.on("change:visible", function (l) {
        if (運行頻度図LayerGroup.getVisible() == false || railroadLayerGroup2.getVisible() == false) {
            forceSetLegend(l.target, false);
            return;
        }
        setLegend(layer_rail_運行本数合計);
    });
    layer_rail_運行本数順方向.on("change:visible", function (l) {
        if (運行頻度図LayerGroup.getVisible() == false || railroadLayerGroup2.getVisible() == false) {
            forceSetLegend(l.target, false);
            return;
        }
        setLegend(layer_rail_運行本数順方向);
    });
    layer_rail_運行本数逆方向.on("change:visible", function (l) {
        if (運行頻度図LayerGroup.getVisible() == false || railroadLayerGroup2.getVisible() == false) {
            forceSetLegend(l.target, false);
            return;
        }
        setLegend(layer_rail_運行本数逆方向);
    });

    populatedLayerGroup.on("change:visible", function (event) {
        updateLegend人口３次メッシュ();
    });

    人口総数Layer.on("change:visible", function () {
        updateLegend人口３次メッシュ();
    });
    人口総0to17Layer.on("change:visible", function () {
        updateLegend人口３次メッシュ();
    });
    人口総18to64Layer.on("change:visible", function () {
        updateLegend人口３次メッシュ();
    });
    人口総65to74Layer.on("change:visible", function () {
        updateLegend人口３次メッシュ();
    });
    人口総75to94Layer.on("change:visible", function () {
        updateLegend人口３次メッシュ();
    });

    const updateLegend人口３次メッシュ = () => {
        let 総数visible = 人口総数Layer.getVisible();
        let その他visible = !人口総数Layer.getVisible();

        if (populatedLayerGroup.getVisible() == false) {
            総数visible = false;
            その他visible = false;
        }

        updateSpecialLegend("人口（３次メッシュ）（総数）", 総数visible);
        updateSpecialLegend("人口（３次メッシュ）（総数以外共通）", その他visible);
    };

    populatedLayerGroup5.on("change:visible", function (event) {
        updateLegend人口５次メッシュ();
    });

    人口総数Layer5.on("change:visible", function () {
        updateLegend人口５次メッシュ();
    });
    人口総0to17Layer5.on("change:visible", function () {
        updateLegend人口５次メッシュ();
    });
    人口総18to64Layer5.on("change:visible", function () {
        updateLegend人口５次メッシュ();
    });
    人口総65to74Layer5.on("change:visible", function () {
        updateLegend人口５次メッシュ();
    });
    人口総75to94Layer5.on("change:visible", function () {
        updateLegend人口５次メッシュ();
    });

    const updateLegend人口５次メッシュ = () => {
        let 総数visible = 人口総数Layer5.getVisible();
        let その他visible = !人口総数Layer5.getVisible();

        if (populatedLayerGroup5.getVisible() == false) {
            総数visible = false;
            その他visible = false;
        }

        updateSpecialLegend("人口（５次メッシュ）（総数）", 総数visible);
        updateSpecialLegend("人口（５次メッシュ）（総数以外共通）", その他visible);
    };

    小地域年齢LayerGroup.on("change:visible", function (event) {
        updateLegend小地域年齢();
    });
    小地域年齢Layer.on("change:visible", function (event) {
        updateLegend小地域年齢();
    });
    小地域年齢0_19Layer.on("change:visible", function (event) {
        updateLegend小地域年齢();
    });
    小地域年齢20_59Layer.on("change:visible", function (event) {
        updateLegend小地域年齢();
    });
    小地域年齢60_74Layer.on("change:visible", function (event) {
        updateLegend小地域年齢();
    });
    小地域年齢75Layer.on("change:visible", function (event) {
        updateLegend小地域年齢();
    });

    const updateLegend小地域年齢 = () => {
        let 総数visible = 小地域年齢Layer.getVisible();
        let その他visible = !小地域年齢Layer.getVisible();

        if (小地域年齢LayerGroup.getVisible() == false) {
            総数visible = false;
            その他visible = false;
        }

        updateSpecialLegend("人口（小地域）（総数）", 総数visible);
        updateSpecialLegend("人口（小地域）（総数以外共通）", その他visible);
    };

    const updateLegend到達圏域 = () => {
        updateSpecialLegend("到達圏域分析（共通）", false);
        if (到達圏域LayerGroup.getVisible() == false) return;
        if (
            map
                .getLayers()
                .getArray()
                .some((layer) => layer === 到達圏域LayerGroup) == false
        )
            return;
        updateSpecialLegend("到達圏域分析（共通）", 到達圏域LayerGroup.getVisible());
    };

    病院Layer.on("change:visible", function (event) {
        updateSpecialLegend("病院", event.target.getVisible());
    });
    学校Layer.on("change:visible", function (event) {
        updateSpecialLegend("学校", event.target.getVisible());
    });
    病院Layer_name.on("change:visible", function (event) {
        $("#病院_label_toggle").text(病院Layer_name.getVisible() ? "ラベル非表示" : "ラベル表示");
    });
    学校Layer_name.on("change:visible", function (event) {
        $("#学校_label_toggle").text(学校Layer_name.getVisible() ? "ラベル非表示" : "ラベル表示");
    });
    facilityLayerGroup.on("change:visible", function (event) {
        updateLegend施設情報();
    });
    const updateLegend施設情報 = () => {
        if (facilityLayerGroup.getVisible()) {
            updateSpecialLegend("病院", 病院Layer.getVisible());
            updateSpecialLegend("学校", 学校Layer.getVisible());
        } else {
            updateSpecialLegend("病院", false);
            updateSpecialLegend("学校", false);
        }
    };
    const updateLegend停留所標柱 = () => {
        if (busLayerGroup.getVisible()) {
            updateSpecialLegend("停留所", layer_aggregator_stops.getVisible());
            updateSpecialLegend("標柱", layer_stops.getVisible());
        } else {
            updateSpecialLegend("停留所", false);
            updateSpecialLegend("標柱", false);
        }
    };
    markerLayer.on("change:visible", function (event) {
        if (da_setting == 1) {
            updateLegend出発地();
        } else {
            updateLegend到着地();
        }
    });
    const updateLegend出発地 = () => {
        updateSpecialLegend("出発地点", false);
        updateSpecialLegend("到達地点", false);
        if (menu_mode != "basic4a" && menu_mode != "basic4b") return;
        if (da_setting == 1) updateSpecialLegend("出発地点", markerLayer.getVisible());
    };
    const updateLegend到着地 = () => {
        updateSpecialLegend("出発地点", false);
        updateSpecialLegend("到達地点", false);
        if (menu_mode != "basic4b") return;
        if (da_setting == 2) updateSpecialLegend("到達地点", markerLayer.getVisible());
    };
    const setLegend = (layer) => {
        let accordionItemId = layerAccordionMap.get(layer);
        const accordionItemElement = document.getElementById(accordionItemId);
        if (layer.getVisible()) {
            accordionItemElement.classList.remove("d-none");
        } else {
            accordionItemElement.classList.add("d-none");
        }
        computeClickInfoHeight();
    };

    const forceSetLegend = (layer, visible) => {
        let accordionItemId = layerAccordionMap.get(layer);
        const accordionItemElement = document.getElementById(accordionItemId);
        if (visible) {
            accordionItemElement.classList.remove("d-none");
        } else {
            accordionItemElement.classList.add("d-none");
        }
        computeClickInfoHeight();
    };

    const updateSpecialLegend = (layerName, visible) => {
        let accordionItemId = layerAccordionMap.get(layerName);

        const accordionItemElement = document.getElementById(accordionItemId);
        if (visible) {
            accordionItemElement.classList.remove("d-none");
        } else {
            accordionItemElement.classList.add("d-none");
        }
        computeClickInfoHeight();
    };

    routesLayerGroup.on("change:visible", function (event) {
        if (event.target.getVisible() && busLayerGroup.getVisible() == false) {
            busLayerGroup_setVisible(true);
        }
    });
    busLayerGroup.on("change:visible", function (event) {
        if (cl2pl_flag) return;
        if (event.target.getVisible() == true) {
            busLayerGroup.getLayers().forEach((lyr) => {
                setLayerVisible(lyr);
            });
            $("#バス路線_label_toggle").text("全解除");
        } else {
            busLayerGroup.getLayers().forEach((lyr) => {
                clearLayerVisible(lyr);
            });
            $("#バス路線_label_toggle").text("全選択");
        }
    });
    layer_aggrigator_stops_name.on("change:visible", function (event) {
        $("#停留所_label_toggle").text(layer_aggrigator_stops_name.getVisible() ? "ラベル非表示" : "ラベル表示");
    });
    layer_stops_name.on("change:visible", function (event) {
        $("#標柱_label_toggle").text(layer_stops_name.getVisible() ? "ラベル非表示" : "ラベル表示");
    });
</script>
<script>
    let current_val = -1;
    map.on("click", async (e) => {
        overlay.setPosition(undefined);

        current_val = $("[name=direction]:checked").val();

        if (isochronemode) callSetSArea(e.coordinate, 0, 0);

        layer_aggregator_stops
            .getSource()
            .getFeatures()
            .forEach((f) => {
                f.set("selected", false);
            });
        aggregator_routesLayerLines
            .getSource()
            .getFeatures()
            .forEach((f) => {
                f.set("selected", false);
            });

        let route_names = [];
        let stop_names = [];
        let advance1_stops = [];
        let advance2_stops = [];
        let aggr_routes = [];
        let hospitals = "";
        let schools = "";
        let count停留所 = 0;
        let count停留所別乗降実績 = 0;
        $("#od_list").html("");
        let advance2_2_count = 0;
        map.forEachFeatureAtPixel(e.pixel, async (feature, layer) => {
            if (layer.get("title") == "ODデータ" && feature.get("stopname")) {
                let stop_id = feature.get("stopid");
                let stop_name = feature.get("stopname");
                let count = feature.get("count") | 0;
                stop_names.push([stop_id, stop_name, count]);
                layer
                    .getSource()
                    .getFeatures()
                    .forEach((f) => {
                        f.set("selected", false);
                    });
                feature.set("selected", true);
                advance2_stops.push({ stopname: stop_name, stopid: stop_id });
            }
            if (feature.get("stopname_geton")) {
                od_top50(feature.get("stopname_geton"), feature.get("stopname_getoff"), e.coordinate);
                advance2_2_count += 1;
                return true;
            }
            if (feature.get("similar_stop_name") && menu_mode != "advance2_2") {
                let stop_id = feature.get("similar_stop_id");
                let stop_name = feature.get("similar_stop_name");
                let count = feature.get("count") | 0;
                stop_names.push([stop_id, stop_name, count]);
                layer
                    .getSource()
                    .getFeatures()
                    .forEach((f) => {
                        f.set("selected", false);
                    });
                feature.set("selected", true);

                advance2_stops.push({ stopname: stop_name, stopid: stop_id });
            }
            if (feature.get("stop_name")) {
                let stop_id = feature.get("stop_id");
                let stop_name = feature.get("stop_name");
                let route_ids = feature.get("route_ids");
                advance1_stops.push({ stop_id: stop_id, stop_name: stop_name, route_ids: route_ids });
                layer
                    .getSource()
                    .getFeatures()
                    .forEach((f) => {
                        f.set("selected", false);
                    });
                feature.set("selected", true);
            }
            if (feature.get("route_id")) {
                route_names.push(feature.get("route_id"));
                layer
                    .getSource()
                    .getFeatures()
                    .forEach((f) => {
                        f.set("selected", false);
                    });
                feature.set("selected", true);
            }
            if (feature.get("prev_stop_id") || feature.get("next_stop_id")) {
                aggr_routes.push(feature);
                layer
                    .getSource()
                    .getFeatures()
                    .forEach((f) => {
                        f.set("selected", false);
                    });
                feature.set("selected", true);
            }
            hospitals += info_hosp(feature);
            schools += info_school(feature);

            if ((layer.get("title") == "停留所" || layer.get("title") == "ODデータ") && menu_mode == "advance2") count停留所 += 1;
            if (layer.get("title") == "実績アイコン表示" && menu_mode == "advance1a") count停留所別乗降実績 += 1;
        });

        if (menu_mode == "advance2") {
            get_advance2_data_line(advance2_stops);
            return;
        }
        if (stop_names.length > 0) route_names = [];

        let pn_text = "";
        pn_text += hospitals;
        pn_text += schools;
        if (pn_text != "" && isochronemode == false) {
            $("#popup-content").html(pn_text);
            overlay.setPosition(e.coordinate);
        }
        if (route_names.length > 0) {
            if (menu_mode == "advance1a") return;
            if (menu_mode == "advance1b") return;
            $("#click_info").html("");
            $("#popup-content").html("データ取得中・・・");
            show_route_info_list(route_names);
            return;
        }
        if (menu_mode == "advance1a") {
            if (count停留所別乗降実績 == 0) return;
            if ($("#advance1a_graph").html().includes("データなし")) return;

            $("#popup-content").html("データ取得中・・・");
            overlay.setPosition(e.coordinate);
            advance1a_popup(advance2_stops);
            return;
        }
        if (menu_mode == "advance2") {
            get_advance2_data_line(advance2_stops);
            return;
        }
        if (menu_mode == "advance1b" && $("[name=stops_jisseki_onoff]:checked").val() == "-1") {
            $("#advance1b_legend").empty();
            advance1b_graph(aggr_routes);
            return;
        }
        if (menu_mode == "advance1b" && ($("[name=stops_jisseki_onoff]:checked").val() == "0" || $("[name=stops_jisseki_onoff]:checked").val() == "1")) {
            $("#advance1b_legend").empty();
            if (stop_names.length == 0) return;

            $("#popup-content").html("データ取得中・・・");
            overlay.setPosition(e.coordinate);
            if (stop_names.length > 0) {
                await advance1b_graph_point(stop_names);
            }
            return;
        }
        if (menu_mode == "advance2_3") {
            overlay.setPosition(e.coordinate);
            get_advance2_3_popup(advance2_stops);
            return;
        }
        if (menu_mode == "basic1") {
            if (basic1ChartResizeObserver) basic1ChartResizeObserver.disconnect();
            if (aggr_routes.length > 0) {
                await get_aggregator_routes_info(aggr_routes);
            } else {
                await set_operation_frequency();
            }

            if (stop_names.length > 0) {
                await choose_bus_stop(stop_names);
            } else {
                $("#basic1_stop_times").html("");
            }

            const routesGraphDiv = document.getElementById("routes_graph");
            if (routesGraphDiv) {
                if (basic1ChartResizeObserver) {
                    basic1ChartResizeObserver.observe(routesGraphDiv.parentElement);
                }
            }
            return;
        } else if (stop_names.length > 0) {
            if (menu_mode == "advance2_2" || menu_mode == "advance2_3") return;
            choose_bus_stop(stop_names);
            return;
        }
        if (menu_mode == "advance2_2" && advance2_2_count == 0) {
            layer_aggregator_stops.setVisible(false);
            info.style.visibility = "hidden";
            currentFeature = undefined;
        }
    });

    const od_top50 = async (geton, getoff, coord) => {
        if (layer_aggregator_stops.getVisible()) layer_aggregator_stops.setVisible(false);
        let od_date = $("[name=od_date]").val();
        if (od_date == undefined) return;
        if (od_date == "") od_date = "ALL";
        od_date = od_date.replaceAll("/", "-");

        let url = `/api/get_od_data/${open_key}/${od_date}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Network response was not ok [${open_key}]`);
        let r = await response.json();

        let getonoff_list = r.data
            .filter((item) => (item.stopname_geton == geton && item.stopname_getoff == getoff) || (item.stopname_getoff == geton && item.stopname_geton == getoff))
            .reduce((grouped, item) => {
                let key = `${item.stopname_geton}-${item.stopname_getoff}`;
                if (!grouped[key]) {
                    grouped[key] = { stopname_geton: item.stopname_geton, stopname_getoff: item.stopname_getoff, count: 0 };
                }
                grouped[key].count += item.count;
                return grouped;
            }, {});
        let top50 = Object.values(getonoff_list)
            .sort((a, b) => b.count - a.count)
            .slice(0, 50);

        let od_first = top50[0];
        let od_popup = "<p>起点停留所: " + od_first.stopname_geton + "</p>";
        od_popup += "<p>終点停留所: " + od_first.stopname_getoff + "</p>";
        od_popup += "<p>輸送量: " + od_first.count + "件</p>";
        $("#popup-content").html(od_popup);
        overlay.setPosition(coord);

        let all_list = r.data.reduce((grouped, item) => {
            let key = `${item.stopname_geton}-${item.stopname_getoff}`;
            if (!grouped[key]) {
                grouped[key] = { stopname_geton: item.stopname_geton, stopname_getoff: item.stopname_getoff, count: 0 };
            }
            grouped[key].count += item.count;
            return grouped;
        }, {});
        let all_top50 = Object.values(all_list)
            .sort((a, b) => b.count - a.count)
            .slice(0, 50);
        let od_text = "";
        od_text += "<table class='table table-sm table-bordered'>";
        od_text += "<thead>";
        od_text += "<tr>";
        od_text += "<th style='font-size: 0.8rem;'>乗車停留所</th>";
        od_text += "<th style='font-size: 0.8rem;'>降車停留所</th>";
        od_text += "<th style='font-size: 0.8rem; width:65px'>輸送量</th>";
        od_text += "</tr>";
        od_text += "</thead>";
        od_text += "<tbody>";
        for (let item of all_top50) {
            od_text += "<tr>";
            od_text += `<td style="font-size: 0.7rem;" class="advance2_stop-name" data-advance2_stop-name="${item.stopname_geton}">${item.stopname_geton}</td>`;
            od_text += `<td style="font-size: 0.7rem;" class="advance2_stop-name" data-advance2_stop-name="${item.stopname_getoff}">${item.stopname_getoff}</td>`;
            od_text += "<td style='font-size: 0.7rem;'>" + item.count + "</td>";
            od_text += "</tr>";
        }
        od_text += "</tbody>";
        od_text += "</table>";
        $("#od_list").html(od_text);

        $(document).off("click", ".advance2_stop-name");
        $(document).on("click", ".advance2_stop-name", function (e) {
            const stopName = $(this).data("advance2_stop-name");
            zoomToAggregatorStop2(stopName);
        });
    };

    const get_aggregator_routes_info = async (features) => {
        dgbasic1.innerHTML = "";
        for (let feature of features) {
            let prev_stop_id = feature.get("prev_stop_id");
            let next_stop_id = feature.get("next_stop_id");
            let frequency = feature.get("frequency");

            let route_id = $("#route_select").val();
            let service_id = $("[name=service_id]:checked").val();
            let time = -1;
            if ($("[name=allDay]:checked").val() == 1) time = $("#timeSelect").val();

            let get_time_table_url = "/api/get_aggregator_routes_info/" + open_key + "/" + service_id + "/" + prev_stop_id + "/" + next_stop_id;
            const response = await fetch(get_time_table_url);
            if (!response.ok) throw new Error(`Network response was not ok [${open_key}]`);
            const r = await response.json();


            let panel_info = "<table class='table table-sm table-bordered'>";
            panel_info += "<thead><tr><th>Route ID</th><th>本数</th></tr></thead><tbody>";
            for (const [route_id, count] of Object.entries(r.route_count)) {
                panel_info += "<tr>";
                panel_info += "<td>" + route_id + "</td>";
                panel_info += "<td>" + count + "本</td>";
                panel_info += "</tr>";
            }
            panel_info += "</tbody></table>";
            $("#routes_table").html(panel_info);

            const labels = r.route_graph.map((item) => `${item.hour}時`);
            const data = r.route_graph.map((item) => item.frequency);

            const routesGraphDiv = document.getElementById("routes_graph");
            if (!routesGraphDiv) return;

            routesGraphDiv.innerHTML = "";

            let canvas = document.createElement("canvas");
            routesGraphDiv.appendChild(canvas);
            const ctx = canvas.getContext("2d");

            const hiddenCanvas = document.createElement("canvas");
            hiddenCanvas.style.display = "none";
            hiddenCanvas.width = 1900;
            hiddenCanvas.height = 540;
            hiddenCanvas.classList.add("hidden-chart");

            dgbasic1.appendChild(hiddenCanvas);
            const hiddenCtx = hiddenCanvas.getContext("2d");

            const basic1Chart = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: feature.get("prev_stop_name") + " - " + feature.get("next_stop_name"),
                            data: data,
                            borderWidth: 1,
                        },
                    ],
                },
                options: {
                    responsive: true,

                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: "時間",
                            },
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: "運行本数",
                            },
                            ticks: {
                                stepSize: 1,
                            },
                        },
                    },
                },
            });
            basic1ChartResizeObserver = new ResizeObserver(() => {
                basic1Chart.resize();
            });

            new Chart(hiddenCtx, {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: feature.get("prev_stop_name") + " - " + feature.get("next_stop_name"),
                            data: data,
                            borderWidth: 1,
                        },
                    ],
                },
                options: {
                    animation: false,
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: "時間",
                            },
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: "運行本数",
                            },
                            ticks: {
                                stepSize: 1,
                            },
                        },
                    },
                },
            });
            break;
        }
    };

    const choose_bus_stop = async (stop_names) => {
        if (menu_mode == "basic1") {
            $("#basic1_stop_times").html("");
        } else {
            $("#click_info").html("");
        }
        let panel_info = "";
        const uniqueStops = Array.from(new Set(stop_names.map(([stop_id, stop_name]) => `${stop_id}**${stop_name}`))).map((key) => {
            const [stop_id, stop_name] = key.split("**");
            return [stop_id, stop_name];
        });

        for (let x of uniqueStops) {
            let route_ids = await aggr_stop_id_to_route_ids(x[0], selected_service_id);
            panel_info += "<select id='route_select' class='form-select form-select-sm mb-1 mt-1'>";
            for (let route of route_ids) {
                let long_name = route["route_long_name"];
                if (long_name == "") long_name = route["route_short_name"];
                panel_info += "<option value='" + route["route_id"] + "'>[" + route["route_id"] + "] " + long_name + "</option>";
            }

            panel_info += "<option value='-1'>全て</option>";
            panel_info += "</select>";

            panel_info += "stop_name：" + x[1] + "<br>";
            panel_info += "<input type='hidden' id='current_stop_id' value='" + x[0] + "' />";
            panel_info += "<p class='fs-6'>";
            panel_info += "この停留所は以下の標柱が1つにまとめられて作成されたものです";
            panel_info += "</p>";
            panel_info += "<div id='stop_id_in_route_div'>";

            let stop_ids = await aggr_stop_id_to_stop_ids_with_route_id(x[0], -1, selected_service_id);
            const uniqueStopIds = [...new Set(stop_ids.map((item) => item.stop_id))];
            panel_info += "<input type='hidden' id='current_stop_ids' value='" + uniqueStopIds + "' />";
            for (let stop of stop_ids) {
                panel_info += "・<code>[" + stop["stop_id"] + "]</code> " + stop["stop_name"] + "<br>";
            }
            panel_info += "</div>";

            let sdata = await get_service_ids();
            let init_flag = true;
            panel_info += "<div class='direction_div'>";
            for (let service_id of sdata.service_ids) {
                panel_info +=
                    "<label><input type='radio' name='service_id_停留所' class='service_id_停留所' value='" +
                    service_id +
                    "' " +
                    (selected_service_id == service_id ? "checked" : "") +
                    "/>" +
                    service_id +
                    "</label>";
                init_flag = false;
            }
            panel_info += "</div>";

            panel_info += "<div id='bus_stop_time_table'></div>";

            if (menu_mode == "basic1") {
                $("#basic1_stop_times").html(panel_info);
            } else {
                $("#click_info").html(panel_info);
            }
            initTooltip();

            if (route_ids.length == 0) {
                $("#route_select").empty();
            }
            break;
        }

        let time_table = await bus_stop_time_table();
        $("#bus_stop_time_table").html(time_table);

        $("#route_select").change(async (e) => {
            if ($("#route_select").val() == -1) {
                if (confirm("全てを表示するのは時間がかかりますが、表示してもよろしいですか？") == false) return;
                $("#load_overlay").show();
            }
            let time_table = await bus_stop_time_table();
            $("#bus_stop_time_table").html(time_table);
            $("#load_overlay").hide();
        });
        $(".service_id_停留所").change(async (e) => {
            selected_service_id = $("[name=service_id_停留所]:checked").val();

            let stop_id = $("#current_stop_id").val();
            let route_ids = await aggr_stop_id_to_route_ids(stop_id, selected_service_id);
            if (route_ids.length == 0) {
                $("#route_select").empty();
                $("#bus_stop_time_table").html("<p>データなし</p>");
                return;
            }
            let routes_select = $("<select/>", {
                id: "route_select",
                class: "form-select form-select-sm mb-1 mt-1",
            });
            let bk = $("#route_select").val();
            $.each(route_ids, function (i, route) {
                let long_name = route["route_long_name"];
                if (long_name == "") long_name = route["route_short_name"];

                $("<option/>", {
                    value: route["route_id"],
                    text: `[${route["route_id"]}] ${long_name}`,
                }).appendTo(routes_select);
            });
            $("<option/>", {
                value: -1,
                text: "全て",
            }).appendTo(routes_select);
            $("#route_select").empty().append(routes_select.children());
            if (bk == null) {
                if ($("#route_select").children().length > 0) {
                    $("#route_select").prop("selectedIndex", 0);
                } else {
                    $("#route_select").empty();
                    $("#bus_stop_time_table").html("<p>データなし</p>");
                    return;
                }
            } else {
                if ($("#route_select").find("option[value='" + bk + "']").length > 0) {
                    $("#route_select").val(bk);
                } else {
                    if ($("#route_select").children().length > 0) {
                        $("#route_select").prop("selectedIndex", 0);
                    } else {
                        $("#route_select").empty();
                        $("#bus_stop_time_table").html("<p>データなし</p>");
                        return;
                    }
                }
            }
            if ($("#route_select").val() == -1) {
                if (confirm("全てを表示するのは時間がかかりますが、表示してもよろしいですか？") == false) return;
                $("#load_overlay").show();
            }

            let time_table = await bus_stop_time_table();
            $("#bus_stop_time_table").html(time_table);
            $("#load_overlay").hide();
        });
    };

    const refilter_stop_ids = async (route_id) => {
        let panel_info = "";
        let stop_id = $("#current_stop_id").val();
        let service_id = $("[name=service_id_停留所]:checked").val();
        let stop_ids = await aggr_stop_id_to_stop_ids_with_route_id(stop_id, route_id, service_id);
        const uniqueStopIds = [...new Set(stop_ids.map((item) => item.stop_id))];
        panel_info += "<input type='hidden' id='current_stop_ids' value='" + uniqueStopIds + "' />";
        for (let stop of stop_ids) {
            panel_info += "・<code>[" + stop["stop_id"] + "]</code> " + stop["stop_name"] + "<br>";
        }
        panel_info += "</div>";
        $("#stop_id_in_route_div").html(panel_info);
    };
    const bus_stop_time_table = async () => {
        let sel_route_id = $("#route_select").val();
        let route_id = sel_route_id;

        if (sel_route_id == null) {
            return "<p>データなし</p>";
        }

        await refilter_stop_ids(route_id);

        let stop_ids = $("#current_stop_ids").val();
        let service_id = $("[name=service_id_停留所]:checked").val();
        let table_str = "";

        for (let stop_id of stop_ids.split(",")) {
            let route_ids = await stop_id_to_route_ids(stop_id);

            for (let route of route_ids) {
                if (sel_route_id == -1) {
                    route_id = route["route_id"];
                } else {
                    if (route_id != route["route_id"]) continue;
                }


                let get_time_table_url = "/api/get_time_table/" + open_key + "/" + service_id + "/" + route_id + "/" + stop_id;
                const response = await fetch(get_time_table_url);
                if (!response.ok) throw new Error(`Network response was not ok [${open_key}]`);
                const r = await response.json();

                const createTimeTable = (dayType) => `
                    <table class='routes-table table table-sm table-border table-striped'>
                        <tr>
                            <td style="width: 50px;">時間</td>
                            <td>分</td>
                        </tr>
                        ${Object.entries(r.hourly_timetable[dayType])
                            .sort(([a], [b]) => a.localeCompare(b))
                            .map(
                                ([hour, times]) => `
                                    <tr>
                                        <td>${hour}時</td>
                                        <td>
                                        ${times.map((time) => `${time.departure_time}`).join(" ")}
                                        </td>
                                    </tr>`
                            )
                            .join("")}
                    </table>
                    `;

                let pn_text = "";
                Object.keys(r.hourly_timetable).forEach((key) => {
                    if (key == service_id) pn_text += createTimeTable(key);
                });
                if (pn_text == "") pn_text += "<p>時刻表がありません</p>";
                const totalCountWeekends = Object.values(r.hourly_timetable[service_id] || {}).reduce((sum, arr) => sum + arr.length, 0);
                if (totalCountWeekends <= 0) continue;

                let get_startend_url = "/api/get_route_start_end/" + open_key + "/" + service_id + "/" + route_id;
                const response2 = await fetch(get_startend_url);
                if (!response2.ok) throw new Error(`Network response was not ok [${open_key}]`);
                const ser = await response2.json();
                const firstStopId = ser.first_stop.stop_id;
                const firstStopName = ser.first_stop.stop_name;
                const lastStopId = ser.last_stop.stop_id;
                const lastStopName = ser.last_stop.stop_name;

                table_str += `
                    <p class="mb-0">Route_id: ${route["route_id"]}</p>
                    <p class="mb-0">Route_short_name: ${route["route_short_name"]}</p>
                    <p class="mb-0">Route_long_name: ${route["route_long_name"]}</p>
                    <p class="mb-0">始点のstop_name: ${firstStopName}</p>
                    <p>終点のstop_name: ${lastStopName}</p>
                `;
                table_str += `
                    <h6><code>[${r.stop_id}]</code> ${r.stop_name}の時刻表</h6>
                    <p>この標柱には1日${totalCountWeekends}本のバスが停車しています。</p>
                    `;
                table_str += pn_text;
            }
        }
        return table_str;
    };
    const set_operation_frequency = async () => {
        $("#click_info").empty();

        let panel_info = "<h5>運行頻度図</h5>";

        let sdata = await get_service_ids();
        let init_flag = true;

        panel_info += "<table class='operation_frequency_table'>";
        panel_info += "<tr>";
        panel_info += "<td class='p-1 text-nowrap'><label>Service_id</label></td>";
        panel_info += "<td class='p-1'>";
        panel_info += "<div class='direction_div2'>";
        for (let service_id of sdata.service_ids) {
            panel_info += "<label class='ms-1'><input type='radio' name='service_id' class='service_id' value='" + service_id + "' " + (init_flag ? "checked" : "") + "/>" + service_id + "</label>";
            init_flag = false;
        }
        panel_info += "</div>";
        panel_info += "</td>";

        panel_info += "<tr>";
        panel_info += "<td class='p-1 text-nowrap'><label>タイムレンジ</label></td>";
        panel_info += "<td class='p-1'>";

        panel_info += "<div class='direction_div2'>";
        panel_info += '<label class="ms-1"><input type="radio" name="allDay" value="0" class="ol-visibility" style="display:inline" checked />全日</label>';
        panel_info += '<label class="ms-1"><input type="radio" name="allDay" value="1" class="ol-visibility" style="display:inline"/>時間帯別</label>';
        panel_info += '<select id="timeSelect" class="ms-1" disabled>';
        for (var hour = 5; hour <= 23; hour++) {
            panel_info += '<option value="' + hour + '"' + (hour == 7 ? "selected" : "") + ">" + hour + "時</option>";
        }
        panel_info += "</select>";
        panel_info += "</div>";

        panel_info += "</td>";
        panel_info += "</tr>";
        panel_info += "</table>";

        panel_info += "<div id='routes_table'></div>";
        panel_info += "<div id='routes_graph'></div>";
        panel_info += "<div id='basic1_stop_times'></div>";
        $("#click_info").html(panel_info);

        $(document).off("change", "[name=service_id]");
        $(document).on("change", "[name=service_id]", (e) => {
            update_agg_route_source();
            update_agg_stops_source();
        });
        $(document).off("change", "[name=allDay]");
        $(document).on("change", "[name=allDay]", (e) => {
            $("#timeSelect").prop("disabled", true);
            update_agg_route_source();
            update_agg_stops_source();
            allDay = e.target.value;

            if (allDay == 1) $("#timeSelect").prop("disabled", false);
        });
        $(document).off("change", "#timeSelect");
        $(document).on("change", "#timeSelect", (e) => {
            update_agg_route_source();
            update_agg_stops_source();
        });

        update_agg_route_source();
        update_agg_stops_source();
    };

    const route_service_to_graph = async () => {
        let route_id = $("#route_select").val();
        let service_id = $("[name=service_id]:checked").val();

        let routes_graph = document.getElementById("routes_graph");

        routes_graph.innerHTML = "";

        if (!route_id || !service_id) return;

        let route_url = `/api/get_route_service_to_jisseki_data/${open_key}/${route_id}/${service_id}`;
        let response = await fetch(route_url);
        if (!response.ok) throw new Error(`Network response was not ok [${open_key}]`);
        let r = await response.json();
        if (r.data.length == 0) return;

        let summedData = res.data.reduce((acc, curr) => {
            const key = `${curr.stop_sequence}_${curr.stop_id}_${curr.stop_name}`;
            if (!acc[key]) {
                acc[key] = {
                    stop_sequence: curr.stop_sequence,
                    stop_id: curr.stop_id,
                    stop_name: curr.stop_name,
                    乗車中人数: 0,
                    乗車数: 0,
                    降車数: 0,
                };
            }
            acc[key].乗車中人数 += curr.乗車中人数;
            acc[key].乗車数 += curr.乗車数;
            acc[key].降車数 += curr.降車数;
            return acc;
        }, {});
        let resultArray = Object.values(summedData);

        let en_div_j = document.createElement("div");
        en_div_j.height = "250px";
        en_div_j.width = "100%";
        routes_graph.appendChild(en_div_j);

        let canvas_j = document.createElement("canvas");
        canvas_j.style.height = "250px";
        canvas_j.style.width = "100%";
        en_div_j.appendChild(canvas_j);

        const labels = resultArray.map((item) => item.stop_name);
        const stop_ids = resultArray.map((item) => item.stop_id);
        const 乗車数 = resultArray.map((item) => item.乗車数);
        const 降車数 = resultArray.map((item) => item.降車数);
        const 乗車中人数 = resultArray.map((item) => item.乗車中人数);

        layer_stops
            .getSource()
            .getFeatures()
            .forEach((f) => {
                stop_ids.forEach((stop_id) => {
                    if (f.get("stop_id") == stop_id) {
                        f.set("j_count", 乗車中人数[stop_ids.indexOf(stop_id)]);
                    }
                });
            });

        let ctx = canvas_j.getContext("2d");
        new Chart(ctx, {
            type: "bar",
            data: {
                labels: labels,
                datasets: [
                    { label: "乗車数", data: 乗車数 },
                    { label: "降車数", data: 降車数 },
                    { label: "乗車中人数", data: 乗車中人数, type: "line" },
                ],
            },
            options: {
                plugins: {
                    title: {
                        display: true,
                        text: res.route_name + " 乗車中人数",
                    },
                },
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1,
                            precision: 0,
                        },
                    },
                },
            },
        });
    };

    const route_service_to_trip_ids = async (route_id, service_id) => {
        let trip_url = `/api/get_route_service_to_trip_ids/${open_key}/${route_id}/${service_id}`;
        const response = await fetch(trip_url);
        if (!response.ok) {
            throw new Error(`Network response was not ok [${open_key}]`);
        }
        return await response.json();
    };
    const get_service_ids = async () => {
        let url = `/api/get_uniq_service_id/${open_key}`;
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`Network response was not ok [${open_key}]`);
        }
        return await response.json();
    };
    const aggr_stop_id_to_stop_ids = async (stop_id) => {
        let url = `/api/get_aggr_stop_to_stop_ids/${open_key}/${stop_id}`;
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`Network response was not ok [${open_key}]`);
        }
        return await response.json();
    };
    const aggr_stop_id_to_stop_ids_with_route_id = async (stop_id, route_id, service_id) => {
        let url = `/api/get_aggr_stop_to_stop_ids_with_route_id/${open_key}/${stop_id}/${route_id}/${service_id}`;
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`Network response was not ok [${open_key}]`);
        }
        return await response.json();
    };
    const aggr_stop_id_to_route_ids = async (stop_id, service_id) => {
        let url = `/api/get_aggr_stop_to_route_ids_with_service_id/${open_key}/${stop_id}/${service_id}`;
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`Network response was not ok [${open_key}]`);
        }
        return await response.json();
    };
    const stop_id_to_route_ids = async (stop_id) => {
        let url = `/api/get_stop_to_route_ids/${open_key}/${stop_id}`;
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`Network response was not ok [${open_key}]`);
        }
        return await response.json();
    };
    const route_id_to_trip_ids = async (route_id) => {
        let direction = $("[name=direction]:checked").val();
        let trip_url = `/api/get_route_to_trip_ids/${open_key}/${route_id}/${direction}`;
        const response = await fetch(trip_url);
        if (!response.ok) {
            throw new Error(`Network response was not ok [${open_key}]`);
        }
        return await response.json();
    };

    const route_jisseki_action = async (canvas, trip_id) => {
        let ctx = canvas.getContext("2d");

        let direction = $("[name=direction]:checked").val();
        let hour = $("#timeSelect").val();
        if ($("#allDay").prop("checked")) hour = -1;

        let route_url = `/api/get_route_to_jisseki_data/${open_key}/${trip_id}/${direction}/${hour}`;
        let response = await fetch(route_url);
        if (!response.ok) throw new Error(`Network response was not ok [${open_key}]`);
        let res = await response.json();
        if (!res || !Array.isArray(res.data)) {
            canvas.style.height = "0px";
            return;
        }

        let labels = res.data.map((item) => item.stop_name);
        let stop_ids = res.data.map((item) => item.stop_id);
        let 乗車数 = res.data.map((item) => item["乗車数"]);
        let 降車数 = res.data.map((item) => item["降車数"]);
        let 乗車中人数 = res.data.map((item) => item["乗車中人数"]);
        layer_stops
            .getSource()
            .getFeatures()
            .forEach((f) => {
                stop_ids.forEach((stop_id) => {
                    if (f.get("stop_id") == stop_id) {
                        f.set("j_count", 乗車中人数[stop_ids.indexOf(stop_id)]);
                    }
                });
            });

        if (乗車中人数.length == 0) {
            canvas.style.height = "0px";
            return;
        }
        new Chart(ctx, {
            type: "bar",
            data: {
                labels: labels,
                datasets: [
                    { label: "乗車数", data: 乗車数 },
                    { label: "降車数", data: 降車数 },
                    { label: "乗車中人数", data: 乗車中人数, type: "line" },
                ],
            },
            options: {
                plugins: {
                    title: {
                        display: true,
                        text: res.route_name + " 乗車中人数",
                    },
                },
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1,
                            precision: 0,
                        },
                    },
                },
            },
        });
    };

    map.getView().on("resolutionchange", function () {
    });

    const info_hosp = (feature) => {
        let pn_text = "";
        if (feature.get("p04_001") != undefined) {
            pn_text += "<table style='white-space:nowrap;'>";

            pn_text += "<tr><td>医療機関分類: " + feature.get("p04_001") + "</td></tr>";
            pn_text += "<tr><td>施設名称: " + feature.get("p04_002") + "</td></tr>";
            pn_text += "<tr><td>所在地: " + feature.get("p04_003") + "</td></tr>";
            pn_text += "<tr><td style='white-space:wrap;'>診療科目１: " + feature.get("p04_004") + "</td></tr>";
            pn_text += "<tr><td>診療科目２: " + feature.get("p04_005") + "</td></tr>";
            pn_text += "<tr><td>診療科目３: " + feature.get("p04_006") + "</td></tr>";
            pn_text += "<tr><td>開設者分類: " + feature.get("p04_007") + "</td></tr>";
            pn_text += "<tr><td>病床数: " + feature.get("p04_008") + "</td></tr>";
            pn_text += "<tr><td>救急告示病院: " + feature.get("p04_009") + "</td></tr>";
            pn_text += "<tr><td>災害拠点病院: " + feature.get("p04_010") + "</td></tr>";

            pn_text += "</table>";
        }
        return pn_text;
    };
    const info_school = (feature) => {
        let pn_text = "";
        if (feature.get("p29_003") != undefined) {
            pn_text += "<table style='white-space:nowrap;'>";
            pn_text += "<tr><td>行政区域コード: " + feature.get("p29_001") + "</td></tr>";
            pn_text += "<tr><td>学校コード: " + feature.get("p29_002") + "</td></tr>";
            pn_text += "<tr><td>学校分類: " + feature.get("p29_003") + "</td></tr>";
            pn_text += "<tr><td>名称: " + feature.get("p29_004") + "</td></tr>";
            pn_text += "<tr><td>所在地: " + feature.get("p29_005") + "</td></tr>";
            pn_text += "<tr><td>管理者コード: " + feature.get("p29_006") + "</td></tr>";
            pn_text += "<tr><td>休校区分: " + feature.get("p29_007") + "</td></tr>";
            pn_text += "<tr><td>キャンパスコード: " + feature.get("p29_008") + "</td></tr>";
            pn_text += "<tr><td>学校名備考: " + feature.get("p29_009") + "</td></tr>";

            pn_text += "</table>";
        }
        return pn_text;
    };

    const get_route_ids = async (route_name) => {
        let route_url = "/api/get_route_ids/" + open_key + "/" + route_name;
        const response = await fetch(route_url);
        if (!response.ok) {
            throw new Error(`Network response was not ok [${open_key}]`);
        }
        return await response.json();
    };

    const route_info_action = async (canvas, route_id) => {
        let ctx = canvas.getContext("2d");
        let title_url = "api/get_route_sl_name/" + open_key + "/" + route_id;
        let title_response = await fetch(title_url);
        if (!title_response.ok) {
            throw new Error(`Network response was not ok [${open_key}]`);
        }
        let title_r = await title_response.json();

        let route_url = "/api/stops_on_route/" + open_key + "/" + route_id + "/" + $("[name=direction]:checked").val();
        const response = await fetch(route_url);
        if (!response.ok) {
            throw new Error(`Network response was not ok [${open_key}]`);
        }
        const r = await response.json();
        const datasets = Object.entries(r)
            .filter(([service_id]) => service_id !== "全て")
            .sort(([a], [b]) => {
                if (a === "全て") return -1;
                if (b === "全て") return 1;
                return b.localeCompare(a);
            })
            .map(([service_id, stops]) => {
                return {
                    label: service_id,
                    data: stops.map((stop) => stop.count),
                    borderWidth: 1,
                };
            });

        if (datasets.length == 0) {
            canvas.style.height = "0px";
            return;
        }

        new Chart(ctx, {
            type: "bar",
            data: {
                labels: r["全て"].map((item) => {
                    return item.stop_name;
                }),
                datasets: datasets,
            },
            options: {
                plugins: {
                    title: {
                        display: true,
                        text: title_r + " 運行本数",
                    },
                },
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                    },
                },
            },
        });
    };

    const bus_stop_action = (stop_id, stop_name, count) => {
        let pn_text = `<p><code>[${stop_id}]</code> ` + stop_name + "</p>";
        if (count > 0) pn_text += `<p>停車バス数合計: <code>${count}</code></p>`;

        return pn_text;
    };

    const callSetSArea = (e) => {
        if (basic4timemode == 0) {
            setSArea(e, new Date().getHours(), new Date().getMinutes());
        } else {
            setSArea(e, basic4hour, basic4minute);
        }
    };

    const updateDonutPolygons = (lyr) => {
        for (let i = 0; i < lyr.getLayers().getArray().length; i++) {
            let pTime = lyr.getLayers().getArray()[i].getSource().getFeatures()[0].getProperties().time;
            let firstLayer = lyr.getLayers().getArray()[i];
            if (firstLayer.getVisible() == false) continue;

            let firstJson = new ol.format.GeoJSON().writeGeometryObject(firstLayer.getSource().getFeatures()[0].getGeometry(), {
                featureProjection: "EPSG:3857",
                dataProjection: "EPSG:4326",
            });
            for (let j = i + 1; j < lyr.getLayers().getArray().length; j++) {
                let secondLayer = lyr.getLayers().getArray()[j];
                if (secondLayer.getVisible() == false) continue;
                let secondJson = new ol.format.GeoJSON().writeGeometryObject(secondLayer.getSource().getFeatures()[0].getGeometry(), {
                    featureProjection: "EPSG:3857",
                    dataProjection: "EPSG:4326",
                });
                firstJson = turf.difference(firstJson, secondJson);
                if (firstJson == null) return;
            }

            lyr.getLayers()
                .getArray()
                [i].setSource(
                    new ol.source.Vector({
                        features: new ol.format.GeoJSON().readFeatures(firstJson, { featureProjection: "EPSG:3857", dataProjection: "EPSG:4326" }),
                    })
                );
            firstLayer.getSource().getFeatures()[0].setProperties({ time: pTime });
        }
    };

    const setSArea = async (coordinate, time, minute) => {
        $("#load_overlay").show();

        let dt = new Date();
        if (time > 0) {
            dt.setHours(time);
            dt.setMinutes(minute);
            dt.setSeconds(0);
        }

        let coord4326 = ol.proj.transform(coordinate, "EPSG:3857", "EPSG:4326");

        if (basic4mode == 1) {
            markerLayer.getSource().clear();
            到達圏域python.getLayers().clear();

            let url =
                "/api/isochrone/" +
                open_key +
                "?lat=" +
                coord4326[1] +
                "&lon=" +
                coord4326[0] +
                "&arriveBy=false" +
                "&start=" +
                dt.getFullYear() +
                "-" +
                ("0" + (dt.getMonth() + 1)).slice(-2) +
                "-" +
                ("0" + dt.getDate()).slice(-2) +
                "T" +
                ("0" + dt.getHours()).slice(-2) +
                ":" +
                ("0" + dt.getMinutes()).slice(-2) +
                ":00";

            const response = await fetch(url);
            if (!response.ok) {
                $("#load_overlay").hide();
                throw new Error(`Network response was not ok [${open_key}]`);
            }
            const r = await response.json();
            r.features.forEach((f) => {
                到達圏域python.getLayers().push(
                    new ol.layer.VectorImage({
                        title: `～ ${f.properties.time / 60} 分　`,
                        source: new ol.source.Vector({
                            features: new ol.format.GeoJSON().readFeatures(f, {
                                featureProjection: "EPSG:3857",
                            }),
                        }),
                        style: (f, r) => {
                            let r_color = "rgb(255, 255, 178)";
                            if (f.getProperties().time == 600) r_color = "rgb(255, 232, 140)";
                            if (f.getProperties().time == 1200) r_color = "rgb(254, 210, 102)";
                            if (f.getProperties().time == 1800) r_color = "rgb(254, 183, 81)";
                            if (f.getProperties().time == 2400) r_color = "rgb(253, 155, 67)";
                            if (f.getProperties().time == 3000) r_color = "rgb(250, 123, 54)";
                            if (f.getProperties().time == 3600) r_color = "rgb(244, 86, 41)";
                            if (f.getProperties().time == 4200) r_color = "rgb(234, 52, 33)";
                            if (f.getProperties().time == 4800) r_color = "rgb(212, 26, 35)";
                            if (f.getProperties().time == 5400) r_color = "rgb(169, 16, 22)";
                            f.setProperties({ route_color: r_color });

                            return new ol.style.Style({
                                stroke: new ol.style.Stroke({
                                    color: "rgba(10, 10, 10, 0.1)",
                                    width: 1,
                                }),
                                fill: new ol.style.Fill({
                                    color: r_color,
                                }),
                            });
                        },
                        opacity: 0.5,
                    })
                );
            });
            let flag_icon = "/static/app/img/flag_red.png";
            let flagFeature = new ol.Feature({
                geometry: new ol.geom.Point(coordinate),
            });
            flagFeature.setStyle(
                new ol.style.Style({
                    image: new ol.style.Icon({
                        anchor: [0.1, 0.75],
                        src: flag_icon,
                        scale: 0.1,
                    }),
                })
            );
            markerSource.addFeature(flagFeature);
            $("#load_overlay").hide();
            updateDonutPolygons(到達圏域python);
            updateLegend出発地();
        }
        if (basic4mode == 2) {
            markerLayer.getSource().clear();
            到達圏域otp.getLayers().clear();

            var cutoffSecStr = "";
            var cutoff = [600, 1200, 1800, 2400, 3000, 3600, 4200, 4800, 5400];
            for (let i = 0; i < cutoff.length; i++) {
                cutoffSecStr += "&cutoffSec=" + cutoff[i];
            }

            let url =
                "/otp/routers/default/isochrone" +
                "?fromPlace=" +
                coord4326[1] +
                "," +
                coord4326[0] +
                "&arriveBy=" +
                (da_setting != 1) +
                "&mode=WALK,TRANSIT" +
                "&date=" +
                ("0" + (dt.getMonth() + 1)).slice(-2) +
                "-" +
                ("0" + dt.getDate()).slice(-2) +
                "-" +
                dt.getFullYear() +
                "&time=" +
                dt.getHours() +
                ":" +
                ("0" + dt.getMinutes()).slice(-2) +
                "&maxWalkDistance=" +
                basic4maxwd +
                cutoffSecStr;
            if (da_setting != 1) url += "&toPlace=" + coord4326[1] + "," + coord4326[0];

            const response = await fetch(url, {
                headers: { Accept: "application/json" },
            });
            if (!response.ok) {
                $("#load_overlay").hide();
                throw new Error(`Network response was not ok [${open_key}]`);
            }
            const r = await response.json();
            到達圏域otp_source = new ol.source.Vector({});
            到達圏域otp_source.addFeatures(
                new ol.format.GeoJSON().readFeatures(r, {
                    featureProjection: "EPSG:3857",
                })
            );

            let flag_icon = "/static/app/img/flag_red.png";
            if (da_setting != 1) flag_icon = "/static/app/img/flag_blue.png";
            let flagFeature = new ol.Feature({
                geometry: new ol.geom.Point(coordinate),
            });
            flagFeature.setStyle(
                new ol.style.Style({
                    image: new ol.style.Icon({
                        anchor: [0.1, 0.75],
                        src: flag_icon,
                        scale: 0.1,
                    }),
                })
            );
            markerSource.addFeature(flagFeature);

            r.features.forEach((f) => {
                到達圏域otp.getLayers().push(
                    new ol.layer.VectorImage({
                        title: `～ ${f.properties.time / 60} 分`,
                        source: new ol.source.Vector({
                            features: new ol.format.GeoJSON().readFeatures(f, {
                                featureProjection: "EPSG:3857",
                            }),
                        }),
                        style: (f, r) => {
                            let r_color = "rgb(255, 255, 178)";
                            if (f.getProperties().time == 600) r_color = "rgb(255, 232, 140)";
                            if (f.getProperties().time == 1200) r_color = "rgb(254, 210, 102)";
                            if (f.getProperties().time == 1800) r_color = "rgb(254, 183, 81)";
                            if (f.getProperties().time == 2400) r_color = "rgb(253, 155, 67)";
                            if (f.getProperties().time == 3000) r_color = "rgb(250, 123, 54)";
                            if (f.getProperties().time == 3600) r_color = "rgb(244, 86, 41)";
                            if (f.getProperties().time == 4200) r_color = "rgb(234, 52, 33)";
                            if (f.getProperties().time == 4800) r_color = "rgb(212, 26, 35)";
                            if (f.getProperties().time == 5400) r_color = "rgb(169, 16, 22)";
                            f.setProperties({ route_color: r_color });

                            return new ol.style.Style({
                                stroke: new ol.style.Stroke({
                                    color: "rgba(10, 10, 10, 0.1)",
                                    width: 1,
                                }),
                                fill: new ol.style.Fill({
                                    color: r_color,
                                }),
                            });
                        },
                        opacity: 0.5,
                    })
                );
            });

            $("#load_overlay").hide();
            updateDonutPolygons(到達圏域otp);
            if (da_setting == 1) {
                updateLegend出発地();
            } else {
                updateLegend到着地();
            }
        }
    };
</script>
<script>
    const routesLayerGroupRefresh = () => {
        到達圏域python.getLayers().forEach((l) => {
            l.getSource()
                .getFeatures()
                .forEach((f) => {
                    let route_color = l.get("route_color") ? l.get("route_color") : f.getProperties().route_color;
                    if (!route_color) {
                        if (f.getProperties().time == 600) route_color = "rgb(255, 232, 140)";
                        if (f.getProperties().time == 1200) route_color = "rgb(254, 210, 102)";
                        if (f.getProperties().time == 1800) route_color = "rgb(254, 183, 81)";
                        if (f.getProperties().time == 2400) route_color = "rgb(253, 155, 67)";
                        if (f.getProperties().time == 3000) route_color = "rgb(250, 123, 54)";
                        if (f.getProperties().time == 3600) route_color = "rgb(244, 86, 41)";
                        if (f.getProperties().time == 4200) route_color = "rgb(234, 52, 33)";
                        if (f.getProperties().time == 4800) route_color = "rgb(212, 26, 35)";
                        if (f.getProperties().time == 5400) route_color = "rgb(169, 16, 22)";
                    }
                    f.setStyle(
                        new ol.style.Style({
                            stroke: new ol.style.Stroke({
                                color: "rgba(10, 10, 10, 0.1)",
                                width: 1,
                            }),
                            fill: new ol.style.Fill({
                                color: route_color,
                            }),
                        })
                    );
                });
        });
        到達圏域otp.getLayers().forEach((l) => {
            l.getSource()
                .getFeatures()
                .forEach((f) => {
                    let route_color = l.get("route_color") ? l.get("route_color") : f.getProperties().route_color;
                    if (!route_color) {
                        if (f.getProperties().time == 600) route_color = "rgb(255, 232, 140)";
                        if (f.getProperties().time == 1200) route_color = "rgb(254, 210, 102)";
                        if (f.getProperties().time == 1800) route_color = "rgb(254, 183, 81)";
                        if (f.getProperties().time == 2400) route_color = "rgb(253, 155, 67)";
                        if (f.getProperties().time == 3000) route_color = "rgb(250, 123, 54)";
                        if (f.getProperties().time == 3600) route_color = "rgb(244, 86, 41)";
                        if (f.getProperties().time == 4200) route_color = "rgb(234, 52, 33)";
                        if (f.getProperties().time == 4800) route_color = "rgb(212, 26, 35)";
                        if (f.getProperties().time == 5400) route_color = "rgb(169, 16, 22)";
                    }
                    f.setStyle(
                        new ol.style.Style({
                            stroke: new ol.style.Stroke({
                                color: "rgba(10, 10, 10, 0.1)",
                                width: 1,
                            }),
                            fill: new ol.style.Fill({
                                color: route_color,
                            }),
                        })
                    );
                });
        });
        routesLayerGroup.getLayers().forEach((l) => {
            l.getSource()
                .getFeatures()
                .forEach((f) => {
                    if (f.getProperties().selected && f.getProperties().advance1a_mode) return;
                    let route_color = l.get("route_color") ? l.get("route_color") : f.getProperties().route_color;
                    let r_color = "#" + route_color.replace("#", "");
                    f.setStyle(
                        new ol.style.Style({
                            stroke: new ol.style.Stroke({
                                color: r_color,
                                width: 2,
                            }),
                        })
                    );
                });
        });
    };

    map.on("pointermove", (event) => {
        map.getTargetElement().style.cursor = "";
        if (実績Icon表示Layer.getVisible()) {
            実績Icon表示Layer
                .getSource()
                .getFeatures()
                .forEach((f) => {
                    let bColor = typeof f.getStyle()?.getImage === "function" ? f.getStyle().getImage()?.getFill()?.getColor() : "rgba(255, 94, 91, 1.0)";
                    f.setStyle(
                        new ol.style.Style({
                            image: new ol.style.RegularShape({
                                fill: new ol.style.Fill({
                                    color: bColor,
                                }),
                                stroke: new ol.style.Stroke({
                                    color: "#ffffff",
                                    width: 2,
                                }),
                                points: 4,
                                radius: f.get("selected") ? 12 : 8,
                                angle: 0,
                            }),
                        })
                    );
                });
        }

        aggregator_routesLayerLines
            .getSource()
            .getFeatures()
            .forEach((f) => {
                if (!f.get("selected")) f.setStyle((f, r) => ARLL_originalStyleFunction(f, r));
            });
        layer_stops
            .getSource()
            .getFeatures()
            .forEach((f) => {
                if (!f.get("advance1a_mode")) f.setStyle(標柱style);
            });
        if (menu_mode != "advance1a" && menu_mode != "advance1b" && menu_mode != "advance2_2") {
            layer_aggregator_stops
                .getSource()
                .getFeatures()
                .forEach((f) => {
                    if (!f.get("selected")) if (!f.get("advance1a_mode") && !f.get("advance1b_mode")) f.setStyle(停留所style);
                });
        }
        if (menu_mode == "advance1b" && ($("[name=stops_jisseki_onoff]:checked").val() == "0" || $("[name=stops_jisseki_onoff]:checked").val() == "1")) {
            layer_aggregator_stops
                .getSource()
                .getFeatures()
                .forEach((feature) => {
                    let org_style = feature.getStyle();
                    if (org_style && org_style.getImage) {
                        let org_color = org_style.getImage().getFill().getColor();
                        let selected = feature.get("selected");
                        feature.setStyle(
                            new ol.style.Style({
                                image: new ol.style.RegularShape({
                                    fill: new ol.style.Fill({
                                        color: org_color,
                                    }),
                                    stroke: new ol.style.Stroke({
                                        color: "#ffffff",
                                        width: 2,
                                    }),
                                    points: 4,
                                    radius: selected ? 10 : 5,
                                    angle: 0,
                                }),
                            })
                        );
                    }
                });
        }
        病院Layer
            .getSource()
            .getFeatures()
            .forEach((f) => {
                f.setStyle(病院Style);
            });
        学校Layer
            .getSource()
            .getFeatures()
            .forEach((f) => {
                f.setStyle(学校Style);
            });

        routesLayerGroupRefresh();

        let radius = 8;
        if (parseInt(map.getView().getZoom()) > 8) radius = 10;
        let odOK = 0;
        let odNG = 0;
        map.forEachFeatureAtPixel(event.pixel, (feature, layer) => {
            if (feature) map.getTargetElement().style.cursor = "pointer";

            if (feature && layer.get("title") == "ODデータ") {
                var currentStyle = feature.getStyle().getImage();
                if (currentStyle.getFill().getColor() == "#999") {
                    odNG += 1;
                } else {
                    odOK += 1;
                }
            }
            if (feature && layer.get("title") == "ODデータ ライン") {
                map.getTargetElement().style.cursor = "";
            }
            if (feature && feature.get("next_stop_id") && (menu_mode == "basic1" || menu_mode == "advance1a" || menu_mode == "advance1b")) {
                if ($("[name=stops_jisseki_onoff]:checked").val() == "-1") {
                    let frequency = feature.get("frequency");
                    let width = 1;
                    if (frequency >= 10) width = 4;
                    if (frequency >= 30) width = 7;
                    if (menu_mode == "advance1a") {
                        map.getTargetElement().style.cursor = "";
                    } else {
                        if (menu_mode == "advance1b") width = 3;
                        feature.setStyle(
                            new ol.style.Style({
                                stroke: new ol.style.Stroke({
                                    color: "#ffaf20",
                                    width: width * 3,
                                }),
                                geometry: (f) => {
                                    return offsetLineString(f.getGeometry(), width, map.getView().getResolution());
                                },
                            })
                        );
                        map.getTargetElement().style.cursor = "pointer";
                    }
                }
            }
            if (feature && menu_mode == "advance1b" && layer.get("title") == "停留所") {
                if ($("[name=stops_jisseki_onoff]:checked").val() == "0" || $("[name=stops_jisseki_onoff]:checked").val() == "1") {
                    let org_color = feature.getStyle().getImage().getFill().getColor();
                    let selected = feature.get("selected");
                    feature.setStyle(
                        new ol.style.Style({
                            image: new ol.style.RegularShape({
                                fill: new ol.style.Fill({
                                    color: org_color,
                                }),
                                stroke: new ol.style.Stroke({
                                    color: "#ffffff",
                                    width: 2,
                                }),
                                points: 4,
                                radius: selected ? 10 : radius,
                                angle: 0,
                            }),
                        })
                    );
                    map.getTargetElement().style.cursor = "pointer";
                }
            }
            if (feature && menu_mode == "advance1b" && layer.get("title") == "運行頻度図（バス）") {
                if ($("[name=stops_jisseki_onoff]:checked").val() == "0" || $("[name=stops_jisseki_onoff]:checked").val() == "1") {
                    map.getTargetElement().style.cursor = "";
                }
            }

            if (feature && feature.get("stop_id") && layer.get("title") != "標柱") {
                if (menu_mode != "advance1a") {
                    feature.setStyle(
                        new ol.style.Style({
                            image: new ol.style.Circle({
                                radius: radius,
                                fill: new ol.style.Fill({
                                    color: "rgba(90, 91, 91, 1.0)",
                                }),
                                stroke: new ol.style.Stroke({
                                    color: "#ffffff",
                                    width: 2,
                                }),
                            }),
                        })
                    );
                }
                map.getTargetElement().style.cursor = "pointer";
            }

            if (feature && feature.get("similar_stop_id") && menu_mode != "advance2_2") {
                if (menu_mode == "advance1a" && layer.get("title") == "実績アイコン表示") {
                    feature.setStyle(
                        new ol.style.Style({
                            image: new ol.style.RegularShape({
                                fill: new ol.style.Fill({
                                    color: feature.getStyle().getImage().getFill().getColor(),
                                }),
                                stroke: new ol.style.Stroke({
                                    color: "#ffffff",
                                    width: 2,
                                }),
                                points: 4,
                                radius: radius * 1.2,
                                angle: 0,
                            }),
                        })
                    );
                }
                if (menu_mode != "advance1a" && menu_mode != "advance1b" && layer.get("title") != "標柱") {
                    feature.setStyle(
                        new ol.style.Style({
                            image: new ol.style.RegularShape({
                                fill: new ol.style.Fill({
                                    color: "rgba(255, 94, 91, 1.0)",
                                }),
                                stroke: new ol.style.Stroke({
                                    color: "#ffffff",
                                    width: 2,
                                }),
                                points: 4,
                                radius: radius,
                                angle: 0,
                            }),
                        })
                    );
                }
                if ((menu_mode == "advance1a" && layer.get("title") == "停留所") || layer.get("title") == "標柱") {
                    map.getTargetElement().style.cursor = "";
                } else {
                    map.getTargetElement().style.cursor = menu_mode != "advance1b" ? "pointer" : "";
                }
            }

            if (feature && feature.get("p29_003")) {
                let hoverStyle = new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: 8,
                        fill: new ol.style.Fill({
                            color: "rgba(255, 255, 255, 1.0)",
                        }),
                        stroke: new ol.style.Stroke({
                            color: "#003366",
                            width: 2,
                        }),
                    }),
                });
                feature.setStyle(hoverStyle);
                map.getTargetElement().style.cursor = "pointer";
            } else if (feature && feature.get("p04_001")) {
                let hoverStyle = new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: 8,
                        fill: new ol.style.Fill({
                            color: "rgba(255, 255, 255, 1.0)",
                        }),
                        stroke: new ol.style.Stroke({
                            color: "#ff0000",
                            width: 2,
                        }),
                    }),
                });
                feature.setStyle(hoverStyle);
                map.getTargetElement().style.cursor = "pointer";
            }

            if (feature && feature.get("route_id")) {
                let current_color = layer.getStyle().getStroke().getColor();
                if (menu_mode != "advance1a") {
                    feature.setStyle(
                        new ol.style.Style({
                            stroke: new ol.style.Stroke({
                                color: current_color,
                                width: 8,
                            }),
                        })
                    );
                }
                if (menu_mode == "advance1a") map.getTargetElement().style.cursor = "";
            }

            if (layer.get("title") == "運行頻度図（バス）" && menu_mode != "basic1" && menu_mode != "advance1a" && menu_mode != "advance1b") {
                map.getTargetElement().style.cursor = "";
            }

            if (feature && menu_mode == "advance2_2" && layer.get("title") == "停留所") {
                map.getTargetElement().style.cursor = "";
            }
        });
        if (odOK == 0 && odNG > 0) {
            map.getTargetElement().style.cursor = "";
        }
        if (menu_mode == "advance2" || (menu_mode == "advance2_2" && layer_aggregator_stops.getVisible()) || menu_mode == "advance2_3") {
            displayFeatureInfo(event.pixel, event.originalEvent.target);
        }
    });
    map.getTargetElement().addEventListener("pointerleave", function () {
        currentFeature = undefined;
        info.style.visibility = "hidden";
    });

    const update_agg_stops_source = async () => {
        let time = $("#timeSelect").val();
        if ($("#allDay").prop("checked")) time = -1;
        if (time == undefined) time = -1;

        const cqlFilter = encodeURIComponent(`file_name='${open_key}' and hour='${time}'`);
        let url =
            "/geoserver/traffic_info/ows" +
            "?service=WFS" +
            "&version=1.1.0" +
            "&request=GetFeature" +
            "&typename=traffic_info:app_aggregator_stops" +
            "&outputFormat=application/json" +
            "&srsname=EPSG:3857" +
            `&CQL_FILTER=${cqlFilter}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Network response was not ok [${open_key}]`);
        const r = await response.json();

        r.features = Object.values(
            r.features.reduce((acc, feature) => {
                const id = feature.properties.similar_stop_id;
                if (!acc[id]) acc[id] = feature;
                return acc;
            }, {})
        );

        layer_aggregator_stops.getSource().clear();
        layer_aggregator_stops.getSource().addFeatures(new ol.format.GeoJSON().readFeatures(r));
        if (layer_aggregator_stops.getSource().getFeatures().length < 1) return;

        if (menu_mode == "") {
            map.getView().fit(layer_aggregator_stops.getSource().getExtent(), {
                padding: [25, 25, 25, 25],
            });
        }
    };
    update_agg_stops_source();
</script>
<script>
    document.getElementById("gtfs-button").addEventListener("click", (e) => {
        window.location.href = "/gtfs_list?open_key=" + open_key;
    });
</script>
<script>
    $(function () {
        var egripTooltip = bootstrap.Tooltip.getOrCreateInstance(document.getElementById("egrip"));
        $("[name='rrow'").resizable({
            handles: "e",
            resize: function (event, ui) {
                egripTooltip.hide();
                const limit = window.innerWidth * 0.25;
                const paddings = remToPixels(1.5);
                const p2 = paddings * 2;
                if (window.innerWidth - ui.size.width - $("#left_panel").innerWidth() <= limit + paddings) {
                    ui.size.width = window.innerWidth - $("#left_panel").innerWidth() - limit;
                    $("#bottom_row").width(limit - p2);
                    $("#click_info").css("width", $("#bottom_row").width());
                    return;
                }
                $("#bottom_row").width(window.innerWidth - ui.size.width - $("#left_panel").innerWidth() - paddings);

                computeBottomRowWidth();
            },
        });
    });
    const remToPixels = (rem) => {
        return parseFloat(getComputedStyle(document.documentElement).fontSize) * rem;
    };
    const targetNode = document.querySelector(".ol-layerswitcher");
    const config = { childList: true, subtree: true };
    const callback = (mutationsList, observer) => {
        observer.disconnect();
        setRoutesColor();
        $(".layerswitcher-opacity").hide();

        $("#停留所_label_toggle").remove();
        $("label[title='停留所']").after(
            `<button id="停留所_label_toggle" class="btn btn-sm btn-outline-secondary ms-1 text-nowrap layer_min_btn">${
                layer_aggrigator_stops_name.getVisible() ? "ラベル非表示" : "ラベル表示"
            }</button>`
        );
        $("#停留所_label_toggle")
            .off("click")
            .on("click", (e) => {
                layer_aggrigator_stops_name.setVisible(!layer_aggrigator_stops_name.getVisible());
                $("#停留所_label_toggle").text("change event");
            });

        $("#標柱_label_toggle").remove();
        $("label[title='標柱']").after(
            `<button id="標柱_label_toggle" class="btn btn-sm btn-outline-secondary ms-1 text-nowrap layer_min_btn">${layer_stops_name.getVisible() ? "ラベル非表示" : "ラベル表示"}</button>`
        );
        $("#標柱_label_toggle")
            .off("click")
            .on("click", (e) => {
                layer_stops_name.setVisible(!layer_stops_name.getVisible());
                $("#標柱_label_toggle").text("change event");
            });

        $("#鉄道駅_label_toggle").remove();
        $("label[title='鉄道駅']").after(
            `<button id="鉄道駅_label_toggle" class="btn btn-sm btn-outline-secondary ms-1 text-nowrap layer_min_btn">${layer_rail_stops_name.getVisible() ? "ラベル非表示" : "ラベル表示"}</button>`
        );
        $("#鉄道駅_label_toggle")
            .off("click")
            .on("click", (e) => {
                layer_rail_stops_name.setVisible(!layer_rail_stops_name.getVisible());
                $("#鉄道駅_label_toggle").text("change event");
            });

        $("#鉄道路線_label_toggle").remove();
        $("label[title='鉄道路線']").after(
            `<button id="鉄道路線_label_toggle" class="btn btn-sm btn-outline-secondary ms-1 text-nowrap layer_min_btn">${layer_rail_routes_name.getVisible() ? "ラベル非表示" : "ラベル表示"}</button>`
        );
        $("#鉄道路線_label_toggle")
            .off("click")
            .on("click", (e) => {
                layer_rail_routes_name.setVisible(!layer_rail_routes_name.getVisible());
                $("#鉄道路線_label_toggle").text("change event");
            });

        $("#病院_label_toggle").remove();
        $("label[title='病院']").after(
            `<button id="病院_label_toggle" class="btn btn-sm btn-outline-secondary ms-1 text-nowrap layer_min_btn">${病院Layer_name.getVisible() ? "ラベル非表示" : "ラベル表示"}</button>`
        );
        $("#病院_label_toggle")
            .off("click")
            .on("click", (e) => {
                病院Layer_name.setVisible(!病院Layer_name.getVisible());
                $("#病院_label_toggle").text("change event");
            });

        $("#学校_label_toggle").remove();
        $("label[title='学校']").after(
            `<button id="学校_label_toggle" class="btn btn-sm btn-outline-secondary ms-1 text-nowrap layer_min_btn">${学校Layer_name.getVisible() ? "ラベル非表示" : "ラベル表示"}</button>`
        );
        $("#学校_label_toggle")
            .off("click")
            .on("click", (e) => {
                学校Layer_name.setVisible(!学校Layer_name.getVisible());
                $("#学校_label_toggle").text("change event");
            });

        $("#バス路線_label_toggle").remove();
        $("label[title='バス路線']").after(
            `<button id="バス路線_label_toggle" class="btn btn-sm btn-outline-secondary ms-1 text-nowrap layer_min_btn">${routesLayerGroup.getVisible() ? "全解除" : "全選択"}</button>`
        );
        $("#バス路線_label_toggle")
            .off("click")
            .on("click", (e) => {
                routesLayerGroup.setVisible($("#バス路線_label_toggle").text() == "全選択");
                routesLayerGroup
                    .getLayers()
                    .getArray()
                    .forEach((lyr) => {
                        lyr.setVisible(routesLayerGroup.getVisible());
                    });
                $("#バス路線_label_toggle").text("change event");
            });

        observer.observe(targetNode, config);
    };
    const observer = new MutationObserver(callback);
    observer.observe(targetNode, config);

    $("#layer-switcher-div").click((e) => {
        $(".layer_settings_panel").hide();
    });
    $("#layer-switcher-div").scroll((e) => {
        $(".layer_settings_panel").hide();
    });

    const setSettingBtn = (lyr) => {
        if (lyr instanceof ol.layer.Group) {
            lyr.setOpacity(1.0);
            lyr.getLayers()
                .getArray()
                .forEach((l) => {
                    setSettingBtn(l);
                });
        }
        var target = false;
        if (lyr instanceof ol.layer.Layer) {
            let title = lyr.get("title");

            if (title.includes("～") && title.includes("分")) {
                lyr.setOpacity(0.5);
            } else {
                lyr.setOpacity(1.0);
            }
            if (lyr.get("baseLayer")) {
                if (title.includes("総数") || title.includes("歳")) {
                    target = true;
                } else {
                    switch (title) {
                        case "徒歩のみ":
                        case "鉄道・電車":
                        case "乗合バス":
                        case "勤め先・学校のバス":
                        case "自家用車":
                        case "ハイヤー・タクシー":
                        case "オートバイ":
                        case "自転車":
                        case "その他":
                        case "利用交通手段不詳":
                            target = true;
                            break;
                    }
                }
                if (target) lyr.setOpacity(0.5);
            }
        }
    };

    const setRoutesColor = () => {
        $(".settings_btn").remove();
        $(".color-box").remove();

        map.getLayers().forEach((lyr) => setSettingBtn(lyr));
        if (basic4mode == 1) basic4a_allonoff();
        到達圏域python.getLayers().forEach((layer) => {
            const getColor = (title) => {
                r_color = "rgb(255, 232, 140)";
                if (title == "～ 20 分　") r_color = "rgb(254, 210, 102)";
                if (title == "～ 30 分　") r_color = "rgb(254, 183, 81)";
                if (title == "～ 40 分　") r_color = "rgb(253, 155, 67)";
                if (title == "～ 50 分　") r_color = "rgb(250, 123, 54)";
                if (title == "～ 60 分　") r_color = "rgb(244, 86, 41)";
                if (title == "～ 70 分　") r_color = "rgb(234, 52, 33)";
                if (title == "～ 80 分　") r_color = "rgb(212, 26, 35)";
                if (title == "～ 90 分　") r_color = "rgb(169, 16, 22)";
                return r_color;
            };
            const routeTitle = layer.get("title");
            const routeColor = getColor(routeTitle);
            const labelSpan = document.querySelector('label[title="' + routeTitle + '"] span');
            if (labelSpan) {
                const colorBox = document.createElement("span");
                colorBox.title = "color-box-" + routeTitle;
                colorBox.classList.add("color-box");
                colorBox.style.backgroundColor = routeColor;
                colorBox.style.width = "16px";
                colorBox.style.height = "16px";
                colorBox.style.display = "inline-block";
                colorBox.style.marginRight = "3px";
                colorBox.style.verticalAlign = "middle";
                colorBox.style.cursor = "pointer";
                colorBox.style.opacity = 0.5;
                switch (routeTitle) {
                    case "～ 10 分　":
                        colorBox.style.backgroundColor = "rgb(255, 232, 140)";
                        break;
                    case "～ 20 分　":
                        colorBox.style.backgroundColor = "rgb(254, 210, 102)";
                        break;
                    case "～ 30 分　":
                        colorBox.style.backgroundColor = "rgb(254, 183, 81)";
                        break;
                    case "～ 40 分　":
                        colorBox.style.backgroundColor = "rgb(253, 155, 67)";
                        break;
                    case "～ 50 分　":
                        colorBox.style.backgroundColor = "rgb(250, 123, 54)";
                        break;
                    case "～ 60 分　":
                        colorBox.style.backgroundColor = "rgb(244, 86, 41)";
                        break;
                    case "～ 70 分　":
                        colorBox.style.backgroundColor = "rgb(234, 52, 33)";
                        break;
                    case "～ 80 分　":
                        colorBox.style.backgroundColor = "rgb(212, 26, 35)";
                        break;
                    default:
                        colorBox.style.backgroundColor = "rgb(169, 16, 22)";
                        break;
                }
                colorBox.addEventListener("click", (e) => {
                    e.stopPropagation();

                    const colorInput = document.createElement("input");
                    colorInput.type = "color";
                    colorInput.style.display = "none";
                    document.body.appendChild(colorInput);

                    colorInput.click();

                    colorInput.addEventListener("input", (event) => {
                        const newColor = event.target.value;
                        colorBox.style.backgroundColor = newColor;
                        layer
                            .getSource()
                            .getFeatures()
                            .forEach((f) => {
                                f.setProperties({ route_color: newColor });
                                f.setStyle(
                                    new ol.style.Style({
                                        stroke: new ol.style.Stroke({
                                            color: "rgba(10, 10, 10, 0.1)",
                                            width: 1,
                                        }),
                                        fill: new ol.style.Fill({
                                            color: newColor,
                                        }),
                                    })
                                );
                            });

                        document.body.removeChild(colorInput);
                        layer.getSource().changed();
                        routesLayerGroupRefresh();
                    });
                });

                if ($('[title="color-box-' + routeTitle + '"]').length == 0) {
                    labelSpan.parentNode.insertBefore(colorBox, labelSpan);
                }
            }
        });
        if (basic4mode == 2) basic4b_allonoff();
        到達圏域otp.getLayers().forEach((layer) => {
            const getColor = (title) => {
                r_color = "rgb(255, 232, 140)";
                if (title == "～ 20 分") r_color = "rgb(254, 210, 102)";
                if (title == "～ 30 分") r_color = "rgb(254, 183, 81)";
                if (title == "～ 40 分") r_color = "rgb(253, 155, 67)";
                if (title == "～ 50 分") r_color = "rgb(250, 123, 54)";
                if (title == "～ 60 分") r_color = "rgb(244, 86, 41)";
                if (title == "～ 70 分") r_color = "rgb(234, 52, 33)";
                if (title == "～ 80 分") r_color = "rgb(212, 26, 35)";
                if (title == "～ 90 分") r_color = "rgb(169, 16, 22)";
                return r_color;
            };
            const routeTitle = layer.get("title");
            const routeColor = getColor(routeTitle);
            const labelSpan = document.querySelector('label[title="' + routeTitle + '"] span');
            if (labelSpan) {
                const colorBox = document.createElement("span");
                colorBox.title = "color-box-" + routeTitle;
                colorBox.classList.add("color-box");
                colorBox.style.backgroundColor = routeColor;
                colorBox.style.width = "16px";
                colorBox.style.height = "16px";
                colorBox.style.display = "inline-block";
                colorBox.style.marginRight = "3px";
                colorBox.style.verticalAlign = "middle";
                colorBox.style.cursor = "pointer";
                switch (routeTitle) {
                    case "～ 10 分":
                        colorBox.style.backgroundColor = "#fecf71";
                        break;
                    case "～ 20 分":
                        colorBox.style.backgroundColor = "#fcb756";
                        break;
                    case "～ 30 分":
                        colorBox.style.backgroundColor = "#fa9c47";
                        break;
                    case "～ 40 分":
                        colorBox.style.backgroundColor = "#f7803c";
                        break;
                    case "～ 50 分":
                        colorBox.style.backgroundColor = "#f16434";
                        break;
                    case "～ 60 分":
                        colorBox.style.backgroundColor = "#e94c33";
                        break;
                    case "～ 70 分":
                        colorBox.style.backgroundColor = "#df423c";
                        break;
                    case "～ 80 分":
                        colorBox.style.backgroundColor = "#d45057";
                        break;
                    default:
                        colorBox.style.backgroundColor = "#d4878a";
                        break;
                }
                colorBox.addEventListener("click", (e) => {
                    e.stopPropagation();

                    const colorInput = document.createElement("input");
                    colorInput.type = "color";
                    colorInput.style.display = "none";
                    document.body.appendChild(colorInput);

                    colorInput.click();

                    colorInput.addEventListener("input", (event) => {
                        const newColor = event.target.value;
                        colorBox.style.backgroundColor = newColor;
                        layer
                            .getSource()
                            .getFeatures()
                            .forEach((f) => {
                                f.setProperties({ route_color: newColor });
                                f.setStyle(
                                    new ol.style.Style({
                                        stroke: new ol.style.Stroke({
                                            color: "rgba(10, 10, 10, 0.1)",
                                            width: 1,
                                        }),
                                        fill: new ol.style.Fill({
                                            color: newColor,
                                        }),
                                    })
                                );
                            });

                        document.body.removeChild(colorInput);
                        layer.getSource().changed();
                        routesLayerGroupRefresh();
                    });
                });

                if ($('[title="color-box-' + routeTitle + '"]').length == 0) {
                    labelSpan.parentNode.insertBefore(colorBox, labelSpan);
                }
            }
        });

        routesLayerGroup.getLayers().forEach((layer) => {
            const routeTitle = layer.get("title");
            const routeColor = layer.getStyle().getStroke().getColor();
            const labelSpan = document.querySelector('label[title="' + routeTitle + '"] span');
            if (labelSpan) {
                const colorBox = document.createElement("span");
                colorBox.title = "color-box-" + routeTitle.replaceAll(" ", "");
                colorBox.classList.add("color-box");
                colorBox.style.backgroundColor = routeColor;
                colorBox.style.width = "16px";
                colorBox.style.height = "16px";
                colorBox.style.display = "inline-block";
                colorBox.style.marginRight = "3px";
                colorBox.style.verticalAlign = "middle";
                colorBox.style.cursor = "pointer";

                colorBox.addEventListener("click", (e) => {
                    e.stopPropagation();

                    const colorInput = document.createElement("input");
                    colorInput.type = "color";
                    colorInput.style.display = "none";
                    document.body.appendChild(colorInput);

                    colorInput.click();

                    colorInput.addEventListener("input", (event) => {
                        const newColor = event.target.value;
                        colorBox.style.backgroundColor = newColor;
                        layer.setProperties({ route_color: newColor });
                        layer.getStyle().getStroke().setColor(newColor);
                        layer
                            .getSource()
                            .getFeatures()
                            .forEach((f) => {
                                f.setProperties({ route_color: newColor });
                            });

                        document.body.removeChild(colorInput);
                        layer.getSource().changed();
                        routesLayerGroupRefresh();
                    });
                });

                if ($('[title="color-box-' + routeTitle + '"]').length == 0) {
                    labelSpan.parentNode.insertBefore(colorBox, labelSpan);
                }
            }
        });
    };

    let toggleGroup = [facilityLayerGroup, bufferLayerGroup, railroadLayerGroup, 到達圏域LayerGroup];

    toggleGroup.forEach(function (layerGroup) {
        layerGroup.on("change:visible", function (l) {
            setLayerGroupVisibility(l.target, l.target.getVisible());
        });
    });

    運行頻度図LayerGroup.on("change:visible", function (l) {
        if (cl2pl_flag) return;

        aggregator_routesLayerGroup.setVisible(l.target.getVisible());
        railroadLayerGroup2.setVisible(l.target.getVisible());

        updateLegend運行頻度図();
    });

    const updateLegend運行頻度図 = () => {
        updateSpecialLegend("運行頻度図（バス）", 運行頻度図LayerGroup.getVisible());
        if (運行頻度図LayerGroup.getVisible() && railroadLayerGroup2.getVisible()) {
            setLegend(layer_rail_運行本数合計);
            setLegend(layer_rail_運行本数順方向);
            setLegend(layer_rail_運行本数逆方向);
        } else {

            forceSetLegend(layer_rail_運行本数合計, false);
            forceSetLegend(layer_rail_運行本数順方向, false);
            forceSetLegend(layer_rail_運行本数逆方向, false);
        }
    };

    const setLayerGroupVisibility = (layerGroup, visible) => {
        if (cl2pl_flag) return;

        layerGroup.setVisible(visible);

        layerGroup.getLayers().forEach(function (layer) {
            if (layer instanceof ol.layer.Group) {
                setLayerGroupVisibility(layer, visible);
            } else {
                layer.setVisible(visible);
            }
        });
    };
    const toggleLayerGroupVisibility = (layerGroup) => {
        $(".aggr_stops_settings_panel").hide();
        setLayerGroupVisibility(layerGroup, !layerGroup.getVisible());
    };
    layer_rail_routes_name.on("change:visible", function (event) {
        $("#鉄道路線_label_toggle").text(layer_rail_routes_name.getVisible() ? "ラベル非表示" : "ラベル表示");
    });
    layer_rail_stops_name.on("change:visible", function (event) {
        $("#鉄道駅_label_toggle").text(layer_rail_stops_name.getVisible() ? "ラベル非表示" : "ラベル表示");
    });
    railroadLayerGroup.on("change:visible", function (l) {
        updateLegend鉄道();
    });
    const updateLegend鉄道 = () => {
        if (cl2pl_flag) return;
        if (railroadLayerGroup.getVisible()) {
            setLegend(layer_rail_routes);
            setLegend(layer_rail_stops);
        } else {
            forceSetLegend(layer_rail_routes, false);
            forceSetLegend(layer_rail_stops, false);
        }
    };

    railroadLayerGroup.getLayers().forEach((layer) => {
        layer.on("change:visible", () => {
            if (layer.getVisible()) {
                cl2pl_flag = true;
                railroadLayerGroup.setVisible(true);
                cl2pl_flag = false;
                return;
            }
        });
    });

    facilityLayerGroup.getLayers().forEach((layer) => {
        layer.on("change:visible", () => {
            if (layer.getVisible()) {
                cl2pl_flag = true;
                facilityLayerGroup.setVisible(true);
                cl2pl_flag = false;
                return;
            }
        });
    });

    運行頻度図LayerGroup.getLayers().forEach((layer) => {
        if (layer instanceof ol.layer.Group) {
            layer.on("change:visible", () => {
                if (layer.getVisible()) {
                    cl2pl_flag = true;
                    運行頻度図LayerGroup.setVisible(true);
                    cl2pl_flag = false;
                    return;
                }
            });
        }
    });

    routesLayerGroup.getLayers().forEach((layer) => {
        layer.on("change:visible", () => {
            if (layer.getVisible()) {
                cl2pl_flag = true;
                routesLayerGroup.setVisible(true);
                cl2pl_flag = false;
                busLayerGroup_setVisible(true);
                return;
            }
        });
    });

    busLayerGroup.getLayers().forEach((layer) => {
        if (layer instanceof ol.layer.Group == false) {
            layer.on("change:visible", () => {
                if (layer.getVisible()) {
                    busLayerGroup_setVisible(true);
                    return;
                }
            });
        }
    });

    layer_stops.on("change:visible", function (event) {
        updateSpecialLegend("標柱", event.target.getVisible());
        if (layer_stops.getVisible() == false) {
            $(".aggr_stops_settings_panel").hide();
            layer_stops_name.setVisible(false);
        }
        layer_stops
            .getSource()
            .getFeatures()
            .forEach((f) => {
                f.unset("route_ids");
                f.unset("file_name");
            });
    });
    layer_aggregator_stops.on("change:visible", function (event) {
        updateSpecialLegend("停留所", event.target.getVisible());
        if (layer_aggregator_stops.getVisible() == false) {
            $(".aggr_stops_settings_panel").hide();
            layer_aggrigator_stops_name.setVisible(false);
        }
        layer_aggregator_stops
            .getSource()
            .getFeatures()
            .forEach((f) => {
                f.unset("file_name");
            });
    });

    layer_rail_stops.on("change:visible", function (event) {
        if (layer_rail_stops.getVisible() == false) {
            $(".aggr_stops_settings_panel").hide();
            layer_rail_stops_name.setVisible(false);
        }

        setLegend(event.target);
    });

    layer_rail_routes.on("change:visible", function (event) {
        if (layer_rail_routes.getVisible() == false) {
            $(".aggr_stops_settings_panel").hide();
            layer_rail_routes_name.setVisible(false);
        }

        setLegend(event.target);
    });

    $("[name='app_station_setting']").click((e) => {
        e.stopPropagation();
        $("#layer_stops_name").prop("checked", layer_rail_stops_name.getVisible());

        $(".aggr_stops_settings_panel").show();
        $(".aggr_stops_settings_panel").css("top", e.clientY - 20 + "px");
        $(".aggr_stops_settings_panel").css("left", e.clientX + 20 + "px");
        $("#layer_stops_name").off("change");
        $("#layer_stops_name").change((e) => {
            layer_rail_stops_name.setVisible(e.target.checked);
        });
    });

    $("[name='app_railroadsection_setting']").click((e) => {
        e.stopPropagation();
        $("#layer_stops_name").prop("checked", layer_rail_routes_name.getVisible());

        $(".aggr_stops_settings_panel").show();
        $(".aggr_stops_settings_panel").css("top", e.clientY - 20 + "px");
        $(".aggr_stops_settings_panel").css("left", e.clientX + 20 + "px");
        $("#layer_stops_name").off("change");
        $("#layer_stops_name").change((e) => {
            layer_rail_routes_name.setVisible(e.target.checked);
        });
    });

    const legendDivId = "legend-accordion";

    let wmsLayerList = [];

    const addWMSLayer = (layer) => {
        updateLegend();
    };

    const addSpecialLayer = (index, layerName, legendURL) => {
        const legendAccordion = document.getElementById(legendDivId);
        const taccordionItem = document.createElement("div");
        taccordionItem.classList.add("accordion-item");
        taccordionItem.id = "specialLayer" + index;
        const taccordionHeaderId = `heading${index}`;
        const taccordionCollapseId = `collapse${index}`;

        taccordionItem.innerHTML = `
            <h2 class="accordion-header" id="${taccordionHeaderId}" style="--bs-accordion-btn-icon: －;">
                <button class="accordion-button" type="button" data-bs-title=" " data-bs-toggle="collapse" data-bs-target="#${taccordionCollapseId}" aria-expanded="true" aria-controls="${taccordionCollapseId}">
                ${layerName}
                </button>
            </h2>
            <div id="${taccordionCollapseId}" class="mb-2 accordion-collapse collapse show" aria-labelledby="${taccordionHeaderId}">
                <div class="accordion-body">
                    <img style="margin-left:4px;" src="${legendURL}" alt="${layerName} Legend">
                </div>
            </div>
        `;

        layerAccordionMap.set(layerName, taccordionItem.id);
        legendAccordion.appendChild(taccordionItem);
    };

    const updateLegend = () => {
        const legendAccordion = document.getElementById(legendDivId);
        legendAccordion.innerHTML = "";

        const tlayerName = "到達圏域分析（共通）";
        const tUrl = "/geoserver/wms?REQUEST=GetLegendGraphic&STRICT=false&STYLE=%E5%88%B0%E9%81%94%E5%9C%8F%E5%9F%9F";
        addSpecialLayer(0, tlayerName, tUrl);

        const tlayerName2 = "運行頻度図（バス）";
        const tUrl2 = "/geoserver/wms?REQUEST=GetLegendGraphic&STRICT=false&STYLE=バス路線集計";
        addSpecialLayer(1, tlayerName2, tUrl2);

        const tlayerName3 = "停留所";
        const tUrl3 = "/geoserver/wms?REQUEST=GetLegendGraphic&FORMAT=image/png&STRICT=false&STYLE=停留所凡例&legend_options=fontName:meiryo;fontAntiAliasing:true;forceLabels:on;";
        addSpecialLayer(2, tlayerName3, tUrl3);

        const tlayerName4 = "標柱";
        const tUrl4 = "/geoserver/wms?REQUEST=GetLegendGraphic&FORMAT=image/png&STRICT=false&STYLE=標柱凡例&legend_options=fontName:meiryo;fontAntiAliasing:true;forceLabels:on;";
        addSpecialLayer(3, tlayerName4, tUrl4);

        wmsLayerList.forEach((layer, index) => {
            const oneBasedIndex = index + 4;
            let layerName = layer.get("title") || "Layer " + (oneBasedIndex + 1);
            const getLegendGraphicUrl = function (resolution) {
                const source = layer.getSource();
                const params = source.getParams();

                const url = "/geoserver/wms";
                return (
                    url +
                    `?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetLegendGraphic&FORMAT=image/png&LAYER=${params.LAYERS}&STYLE=${params.STYLES}&legend_options=fontName:meiryo;fontAntiAliasing:true;forceLabels:on;`
                );
            };
            if (layerName == "順方向・逆方向合算") layerName = "運行頻度図（鉄道）・順方向逆方向合算";
            if (layerName == "順方向") layerName = "運行頻度図（鉄道）・順方向";
            if (layerName == "逆方向") layerName = "運行頻度図（鉄道）・逆方向";

            const accordionItem = document.createElement("div");
            accordionItem.classList.add("accordion-item");
            accordionItem.id = "wmsLegend" + oneBasedIndex;
            const accordionHeaderId = `heading${oneBasedIndex}`;
            const accordionCollapseId = `collapse${oneBasedIndex}`;

            accordionItem.innerHTML = `
                <h2 class="accordion-header" id="${accordionHeaderId}" style="--bs-accordion-btn-icon: －;">
                    <button class="accordion-button" type="button" data-bs-title=" " data-bs-toggle="collapse" data-bs-target="#${accordionCollapseId}" aria-expanded="true" aria-controls="${accordionCollapseId}">
                        ${layerName}
                    </button>
                </h2>
                <div id="${accordionCollapseId}" class="mb-2 accordion-collapse collapse show" aria-labelledby="${accordionHeaderId}">
                    <div class="accordion-body">
                        <img style="margin-left:4px;" src="${getLegendGraphicUrl()}" alt="${layerName} Legend">
                    </div>
                </div>
            `;

            layerAccordionMap.set(layer, accordionItem.id);
            legendAccordion.appendChild(accordionItem);
        });

        const tlayerNameH = "病院";
        const tUrlH = "/geoserver/wms?REQUEST=GetLegendGraphic&FORMAT=image/png&STRICT=false&STYLE=病院凡例&legend_options=fontName:meiryo;fontAntiAliasing:true;forceLabels:on;";
        addSpecialLayer(11, tlayerNameH, tUrlH);

        const tlayerNameS = "学校";
        const tUrlS = "/geoserver/wms?REQUEST=GetLegendGraphic&FORMAT=image/png&STRICT=false&STYLE=学校凡例&legend_options=fontName:meiryo;fontAntiAliasing:true;forceLabels:on;";
        addSpecialLayer(12, tlayerNameS, tUrlS);

        const tlayerName9 = "利用交通手段（総数）";
        const tUrl9 = "/geoserver/wms?REQUEST=GetLegendGraphic&STRICT=false&STYLE=利用交通手段総数";
        addSpecialLayer(13, tlayerName9, tUrl9);

        const tlayerName10 = "利用交通手段（総数以外共通）";
        const tUrl10 = "/geoserver/wms?REQUEST=GetLegendGraphic&STRICT=false&STYLE=利用交通手段総数以外共通";
        addSpecialLayer(14, tlayerName10, tUrl10);

        const tlayerName15 = "人口（５次メッシュ）（総数）";
        const tUrl15 = "/geoserver/wms?REQUEST=GetLegendGraphic&STRICT=false&STYLE=メッシュ人口総数";
        addSpecialLayer(15, tlayerName15, tUrl15);

        const tlayerName16 = "人口（５次メッシュ）（総数以外共通）";
        const tUrl16 = "/geoserver/wms?REQUEST=GetLegendGraphic&STRICT=false&STYLE=メッシュ人口総数以外共通";
        addSpecialLayer(16, tlayerName16, tUrl16);

        const tlayerName11 = "人口（３次メッシュ）（総数）";
        const tUrl11 = "/geoserver/wms?REQUEST=GetLegendGraphic&STRICT=false&STYLE=メッシュ人口総数";
        addSpecialLayer(17, tlayerName11, tUrl11);

        const tlayerName12 = "人口（３次メッシュ）（総数以外共通）";
        const tUrl12 = "/geoserver/wms?REQUEST=GetLegendGraphic&STRICT=false&STYLE=メッシュ人口総数以外共通";
        addSpecialLayer(18, tlayerName12, tUrl12);

        const tlayerName13 = "人口（小地域）（総数）";
        const tUrl13 = "/geoserver/wms?REQUEST=GetLegendGraphic&STRICT=false&STYLE=メッシュ人口総数";
        addSpecialLayer(19, tlayerName13, tUrl13);

        const tlayerName14 = "人口（小地域）（総数以外共通）";
        const tUrl14 = "/geoserver/wms?REQUEST=GetLegendGraphic&STRICT=false&STYLE=メッシュ人口総数以外共通";
        addSpecialLayer(20, tlayerName14, tUrl14);

        const tlayerName17 = "出発地点";
        const tUrl17 = "/geoserver/wms?REQUEST=GetLegendGraphic&FORMAT=image/png&STRICT=false&STYLE=出発地凡例&legend_options=fontAntiAliasing:true;forceLabels:on;";
        addSpecialLayer(21, tlayerName17, tUrl17);

        const tlayerName18 = "到達地点";
        const tUrl18 = "/geoserver/wms?REQUEST=GetLegendGraphic&FORMAT=image/png&STRICT=false&STYLE=到着地凡例&legend_options=fontAntiAliasing:true;forceLabels:on;";
        addSpecialLayer(22, tlayerName18, tUrl18);

        const accordion = new bootstrap.Collapse(document.querySelector(`#${legendDivId} .accordion-button`), { toggle: false });

        computeClickInfoHeight();
    };

    const accordion = document.getElementById("legend-accordion");
    accordion.addEventListener("show.bs.collapse", (event) => {
        event.target.previousElementSibling.style.setProperty("--bs-accordion-btn-icon", "－");
        $("#click_info").hide();
    });

    accordion.addEventListener("hide.bs.collapse", (event) => {
        event.target.previousElementSibling.style.removeProperty("--bs-accordion-btn-icon");
        $("#click_info").hide();
    });

    accordion.addEventListener("shown.bs.collapse", (event) => {
        computeClickInfoHeight();
        $("#click_info").show();
    });

    accordion.addEventListener("hidden.bs.collapse", (event) => {
        computeClickInfoHeight();
        $("#click_info").show();
    });

    const accordionButtons = accordion.querySelectorAll(".accordion-button");
    accordionButtons.forEach((button) => {
        button.style.setProperty("--bs-accordion-btn-icon", "＋");
    });

    wmsLayerList.push(layer_rail_運行本数合計);
    wmsLayerList.push(layer_rail_運行本数順方向);
    wmsLayerList.push(layer_rail_運行本数逆方向);
    wmsLayerList.push(layer_鉄道輸送密度B);
    wmsLayerList.push(layer_鉄道輸送密度A);
    wmsLayerList.push(layer_rail_stops);
    wmsLayerList.push(layer_rail_routes);

    updateLegend();
    updateLegend到達圏域();
    updateLegend運行頻度図();
    updateLegend鉄道輸送密度();
    updateLegend利用交通手段();
    updateLegend人口３次メッシュ();
    updateLegend人口５次メッシュ();
    updateLegend小地域年齢();
    updateLegend鉄道();
    updateLegend施設情報();
    updateLegend停留所標柱();
    updateLegend出発地();
    updateLegend到着地();
    $("#legendCtl").click(() => {
        $("#legend-accordion").toggleClass("d-none");
        let s = "";
        if ($("#legend-accordion").hasClass("d-none")) {
            s = "legend_expand.png";
        } else {
            s = "legend_fold.png";
        }
        $("#legend_ctl_img").attr("src", "/static/app/img/" + s);
        computeClickInfoHeight();
    });

    const mapPanel = document.getElementById("map_panel");
    const mapOvl = document.getElementById("map_overlay");
    const legendCtl = document.getElementById("legendCtl");
    let mapOverlayTooltip = null;
    let legendCtlTooltip = null;

    mapOvl.addEventListener("click", (event) => {
        const rect = mapPanel.getBoundingClientRect();
        if (event.clientX - rect.left < 15) {
            $("#left_panel").toggleClass("d-none");
            $("#map_panel").toggleClass("col-6 col-9");
            if ($("#left_panel").hasClass("d-none")) {
                $("#map_panel").width(window.innerWidth * 0.75);
            } else {
                $("#map_panel").width(window.innerWidth * 0.5);
            }
            computeBottomRowWidth();
            computeClickInfoHeight();
        }
    });

    mapOvl.addEventListener("mouseover", () => {
        let txt = "<";
        let tooltip = "レイヤコントロールを折り畳みます";

        if ($("#left_panel").hasClass("d-none")) {
            txt = ">";
            tooltip = "レイヤコントロールを表示します";
        }
        mapOvl.textContent = txt;
        $("#map_overlay").attr("data-bs-title", tooltip);
        if (mapOverlayTooltip) {
            mapOverlayTooltip.update();
        }
        mapOverlayTooltip = new bootstrap.Tooltip($("#map_overlay")[0]);
    });

    mapOvl.addEventListener("mouseout", () => {
        mapOvl.textContent = "";
        if (mapOverlayTooltip) {
            mapOverlayTooltip.hide();
        }
    });

    legendCtl.addEventListener("mouseover", () => {
        let tooltip = "凡例を折り畳みます";

        if ($("#legend-accordion").hasClass("d-none")) {
            tooltip = "凡例を表示します";
        }
        $("#legendCtl").attr("data-bs-title", tooltip);
        if (legendCtlTooltip) {
            legendCtlTooltip.update();
        }
        legendCtlTooltip = new bootstrap.Tooltip($("#legendCtl")[0]);
    });

    legendCtl.addEventListener("mouseout", () => {
        if (legendCtlTooltip) {
            legendCtlTooltip.hide();
        }
    });

    const initTooltip = () => {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl, tooltipOptions200);
        });
    };
    const printdTest = () => {
        const cssFiles = ["{% static 'node_modules/ol/ol.css' %}", "{% static 'node_modules/ol/dist/ol.js' %}"];

        Promise.all(cssFiles.map((file) => fetch(file).then((response) => response.text()))).then((cssArray) => {
            const pd = new window.printd.Printd();
            pd.print(document.getElementById("map"), [cssArray[0]], cssArray[1]);
        });
    };
    const tileOperation_start = () => {
        地理院Layer.setVisible(false);
        地理院Layer_PDF.setVisible(true);
    };
    const tileOperation_end = () => {
        地理院Layer.setVisible(true);
        地理院Layer_PDF.setVisible(false);
    };
    const callPDF = (argPaperSize) => {
        $("#load_overlay").show();
        var mapCanvas = document.createElement("canvas");
        var size = map.getSize();
        mapCanvas.width = size[0];
        mapCanvas.height = size[1];
        var mapContext = mapCanvas.getContext("2d");
        Array.prototype.forEach.call(document.querySelectorAll(".ol-layer canvas"), function (canvas) {
            if (canvas.width > 0) {
                var opacity = canvas.parentNode.style.opacity;
                mapContext.globalAlpha = opacity === "" ? 1 : Number(opacity);
                var transform = canvas.style.transform;
                var matrix = transform
                    .match(/^matrix\(([^\(]*)\)$/)[1]
                    .split(",")
                    .map(Number);
                CanvasRenderingContext2D.prototype.setTransform.apply(mapContext, matrix);
                mapContext.drawImage(canvas, 0, 0);
            }
        });
        var b64 = mapCanvas.toDataURL();

        const legend_info = getVisibleAccordionItemInfo();
        let graphtitle = "";
        let graphinfo1 = [];
        let graphinfo2 = [];

        let canvasData = [];
        let rgArea = $("#routes_graph");
        let a1Area = $("#advance1a_graph");
        let a1AreaB = $("#advance1b_graph_panel");

        if (rgArea && $("#cbグラフ出力").prop("checked")) {
            $("#dummy_graph_basic1 canvas.hidden-chart").each(function () {
                let canvas = $(this)[0];
                let dataURL = canvas.toDataURL();
                canvasData.push(dataURL);
            });
            $("#routes_graph canvas").each(function () {
                graphinfo1.push($("input[name='service_id']:checked").val());
                let adVal = $("input[name='allDay']:checked").val();
                let adStr = "全日";
                if (adVal != "0") {
                    adStr = "時間帯別（" + $("#timeSelect option:selected").text() + "）";
                }
                graphinfo2.push(adStr);

                graphtitle = "運行頻度図（バス）";
            });
        }
        if (a1Area && $("#cbグラフ出力").prop("checked")) {
            $("#dummy_graph_advance1a canvas.hidden-chart").each(function () {
                let canvas = $(this)[0];
                let dataURL = canvas.toDataURL();
                canvasData.push(dataURL);
                graphtitle = "停留所別乗降実績";
            });
            let cnt = 0;
            $("#advance1a_graph span").each(function () {
                let span = $(this).text();

                if (cnt % 2 == 0) {
                    graphinfo1.push(span);
                } else {
                    graphinfo2.push(span);
                }
                cnt += 1;
            });
        }
        if (a1AreaB && $("#cbグラフ出力").prop("checked")) {
            $("#dummy_graph_advance1b canvas.hidden-chart").each(function () {
                let canvas = $(this)[0];
                let dataURL = canvas.toDataURL();
                canvasData.push(dataURL);
                graphtitle = "時間帯別乗降実績";
            });
            $("#advance1b_graph_panel span").each(function () {
                let span = $(this).text();
                graphinfo1.push(span);
                graphinfo2.push("");
            });
        }
        let backdropsource = "";
        if (baseLayerGroup.getVisible()) {
            if (地理院Layer.getVisible() || 地理院白地図Layer.getVisible()) {
                backdropsource = "国土地理院";
            } else if (地理院ベクトル地図Layer.getVisible()) {
                backdropsource = "国土地理院ベクトルタイル提供実験";
            }
        }

        fetch("api/generate_pdf", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
            },
            body: JSON.stringify({
                paperSize: argPaperSize,
                pict: b64,
                legend: legend_info,
                graph: canvasData,
                graphtitle: graphtitle,
                graphinfo1: graphinfo1,
                graphinfo2: graphinfo2,
                backdropsource: backdropsource,
            }),
        })
            .then((response) => {
                if (response.ok) {
                    return response.blob();
                } else {
                    $("#load_overlay").hide();
                    console.error("PDF生成に失敗しました", response);
                    throw new Error("PDF生成に失敗しました");
                }
            })
            .then((blob) => {
                $("#load_overlay").hide();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "map.pdf";
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .then((response) => {
                if (response.ok) {
                    return response.blob();
                } else {
                    $("#load_overlay").hide();
                    console.error("PDF生成に失敗しました", response);
                    throw new Error("PDF生成に失敗しました");
                }
            })
            .then((blob) => {
                $("#load_overlay").hide();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "map.pdf";
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .then((response) => {
                if (response.ok) {
                    return response.blob();
                } else {
                    $("#load_overlay").hide();
                    console.error("PDF生成に失敗しました", response);
                    throw new Error("PDF生成に失敗しました");
                }
            })
            .then((blob) => {
                $("#load_overlay").hide();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "map.pdf";
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch((error) => {
                $("#load_overlay").hide();
                console.error(error);
            });
    };

    const getVisibleAccordionItemInfo = () => {
        const accordionItemInfo = [];

        $(".accordion-item:not(.d-none)").each(function () {
            const $item = $(this);
            const buttonText = $item.find(".accordion-button").text().trim();
            const imgSrc = $item.find("img").attr("src");
            const img = $item.find("img").get(0);

            const canvas = document.createElement("canvas");
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext("2d");

            ctx.drawImage(img, 0, 0);

            const base64Image = canvas.toDataURL("image/png");

            accordionItemInfo.push({
                id: $item.attr("id"),
                buttonText: buttonText,
                base64: base64Image,
            });
        });

        return accordionItemInfo;
    };

    const createZipinfo = () => {
        let s = "";
        s += "<h5>○GTFSデータ</h5>";
        s += "<h6>　&nbsp;" + selData.length + "個のデータが読み込まれています。</h6>";

        for (let i = 0; i < selData.length; i++) {
            s += "<table class='zipInfo'" + (i > 0 ? " style='margin-top:10px;'" : "") + ">";
            s += "<tr><th>フィード名：</th><td>" + selData[i]["feed"] + "</td></tr>";
            s += "<tr><th>対象期間：</th><td>" + selData[i]["from_date"] + " ～ " + selData[i]["to_date"] + "</td></tr>";
            s += "<tr><th>事業者名：</th><td>" + selData[i]["organization"] + "</td></tr>";
            s += "<tr><th>都道府県：</th><td>" + selData[i]["pref"] + "</td></tr>";
            s += "<tr><th>URL：</th><td>" + selData[i]["download-url"] + "</td></tr>";
            s += "</table>";
        }

        if (csvName_advance1 != "") {
            s += "<h5 class='h5-zipInfo'>○乗降実績データ<button id='csvClear_advance1' class='csvClearBtn' onclick='csvClear_advance1();'>読み込みデータクリア</button></h5>";
            s += "<table class='zipInfo'>";
            s += "<tr><th>ファイル名：</th><td>" + csvName_advance1 + "</td></tr>";
            s += "</table>";
        }

        if (csvName_advance2 != "") {
            s += "<h5 class='h5-zipInfo'>○ODデータ<button id='csvClear_advance2' class='csvClearBtn' onclick='csvClear_advance2();'>読み込みデータクリア</button></h5>";
            s += "<table class='zipInfo'>";
            s += "<tr><th>ファイル名：</th><td>" + csvName_advance2 + "</td></tr>";
            s += "</table>";
        }
        return s;
    };
    const csvClear_advance1 = async () => {
        routesLayerGroup.getLayers().forEach((l) => {
            l.getSource()
                .getFeatures()
                .forEach((f) => {
                    f.set("selected", false);
                    f.set("advance1a_mode", false);
                    f.set("advance1b_mode", false);
                });
        });
        layer_aggregator_stops
            .getSource()
            .getFeatures()
            .forEach((f) => {
                f.set("selected", false);
                f.set("advance1a_mode", false);
                f.set("advance1b_mode", false);
            });
        clear停留所別乗降実績();
        clear時間帯別乗降実績();
        if (csvLoaded_advance1 == true) {
            const response = await fetch(`/api/jisseki_csv_delete/${open_key}`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken"),
                },
                credentials: "include",
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();

            if (result.message != "OK") {
                alert(result.message);
            }
            csvName_advance1 = "";
            csvLoaded_advance1 = false;
        }
        setLayersToDefault();

        $("#click_info").html("");
        $("#mode_exit").addClass("d-none");

        $("#overlay_inner_button2").click();
    };
    const csvClear_advance2 = async () => {
        odLayerUpload.getSource().clear();
        odLayerUploadLine.getSource().clear();
        odLayerUpload.setVisible(false);

        if (csvLoaded_advance2 == true) {
            const response = await fetch(`/api/od_csv_delete/${open_key}`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken"),
                },
                credentials: "include",
            });


            const result = await response.json();

            csvName_advance2 = "";
            csvLoaded_advance2 = false;
        }
        setLayersToDefault();

        $("#click_info").html("");
        $("#mode_exit").addClass("d-none");

        $("#overlay_inner_button2").click();
    };
    const clear停留所別乗降実績 = () => {
        運行頻度図LayerGroup.setVisible(false);
        aggregator_routesLayerGroup.setVisible(false);
        routesLayerGroup.setVisible(false);

        const src = layer_stops.getSource();
        src.forEachFeature(function (feature) {
            feature.unset("j_count");
        });
        src.refresh();

        実績数表示Layer.getSource().clear();
        実績数表示Layer.setVisible(false);

        実績Icon表示Layer.getSource().clear();
        実績Icon表示Layer.setVisible(false);

        dgadvance1a.innerHTML = "";
    };
    const clear時間帯別乗降実績 = () => {
        dgadvance1b.innerHTML = "";
    };
    const setLayersToDefault = () => {
        運行頻度図LayerGroup.setVisible(false);
        railroadLayerGroup3.setVisible(false);
        odLayerGroup.setVisible(false);
        railroadLayerGroup.setVisible(false);
        facilityLayerGroup.setVisible(false);
        利用交通手段LayerGroup.setVisible(false);
        populatedLayerGroup.setVisible(false);
        populatedLayerGroup5.setVisible(false);
        小地域年齢LayerGroup.setVisible(false);

        実績数表示Layer.setVisible(false);
        aggregator_routesLayerLines.setVisible(false);
        aggregator_routesLayerTexts.setVisible(false);

        layer_aggregator_stops.setVisible(true);
        routesLayerGroup.setVisible(true);
        routesLayerGroup.getLayers().forEach(function (layer, i) {
            layer.setVisible(true);
        });
        busLayerGroup_setVisible(true);
        layer_stops.setVisible(false);

        baseLayerGroup.getLayers().forEach(function (layer, i) {
            layer.setVisible(false);
        });
        地理院Layer.setVisible(true);
        baseLayerGroup.setVisible(true);
    };
    $("#linklabel_about").click((e) => {
        if (!selData) return;
        if (selData.length == 0) return;

        const args = createZipinfo();
        setPanelInfo("読み込み済のデータ", "", args);

        $("#overlay_inner_button1").hide();
        return false;
    });

    const clearOnMenuClick = () => {
        $("#click_info").html("");

        routesLayerGroup.getLayers().forEach((l) => {
            l.getSource()
                .getFeatures()
                .forEach((f) => {
                    f.set("selected", false);
                    f.set("advance1a_mode", false);
                    f.set("advance1b_mode", false);
                });
        });
        const src = layer_stops.getSource();
        src.forEachFeature(function (feature) {
            feature.unset("j_count");
        });
        src.refresh();
        layer_aggregator_stops
            .getSource()
            .getFeatures()
            .forEach((f) => {
                f.set("selected", false);
                f.set("advance1a_mode", false);
                f.set("advance1b_mode", false);
            });

        実績数表示Layer.getSource().clear();
        実績数表示Layer.setVisible(false);

        odLayerUpload.getSource().clear();
        odLayerUploadLine.getSource().clear();
        odLayerUpload.setVisible(false);
        info.style.visibility = "hidden";
        currentFeature = undefined;

        markerLayer.setVisible(false);
        isochronemode = false;

        advance2_start_stopname = "\t";
        advance2_start_val = 0;
    };
    initTooltip();

    $("#load_overlay").click((e) => {
        setTimeout(() => {
            $("#load_overlay").hide();
        }, 300000);
    });

    const setDefaultPanel = () => {
        var panel_default =
            "<div style='height:100%;display:flex;align-items:center;justify-content:center;'><p style='padding:10px;'>停留所あるいは路線をクリックするとそれぞれの情報を確認できます</p></div>";
        $("#click_info").html(panel_default);
    };
    setDefaultPanel();

    const basic4a_allonoff = () => {
        $("#到達圏域分析（バッファ）_label_toggle").remove();
        $("label[title='到達圏域分析（バッファ）']").after(
            `<button id="到達圏域分析（バッファ）_label_toggle" class="btn btn-sm btn-outline-secondary ms-1 text-nowrap layer_min_btn">${到達圏域python.getVisible() ? "全解除" : "全選択"}</button>`
        );
        $("#到達圏域分析（バッファ）_label_toggle")
            .off("click")
            .on("click", (e) => {
                到達圏域python.setVisible(!到達圏域python.getVisible());
                到達圏域python
                    .getLayers()
                    .getArray()
                    .forEach((lyr) => {
                        lyr.setVisible(到達圏域python.getVisible());
                    });
                $("#到達圏域分析（バッファ）_label_toggle").text("change event");
            });
    };
    const basic4b_allonoff = () => {
        $("#到達圏域分析（道路ネットワーク解析）_label_toggle").remove();
        $("label[title='到達圏域分析（道路ネットワーク解析）']").after(
            `<button id="到達圏域分析（道路ネットワーク解析）_label_toggle" class="btn btn-sm btn-outline-secondary ms-1 text-nowrap layer_min_btn">${
                到達圏域otp.getVisible() ? "全解除" : "全選択"
            }</button>`
        );
        $("#到達圏域分析（道路ネットワーク解析）_label_toggle")
            .off("click")
            .on("click", (e) => {
                到達圏域otp.setVisible(!到達圏域otp.getVisible());
                到達圏域otp
                    .getLayers()
                    .getArray()
                    .forEach((lyr) => {
                        lyr.setVisible(到達圏域otp.getVisible());
                    });
                $("#到達圏域分析（道路ネットワーク解析）_label_toggle").text("change event");
            });
    };
    const initServiceId = () => {
        get_service_ids()
            .then((sdata) => {
                for (let service_id of sdata.service_ids) {
                    if (selected_service_id == "") {
                        selected_service_id = service_id;
                        initial_service_id = selected_service_id;
                        init_agg_route_source(initial_service_id);
                        break;
                    }
                }
            })
            .catch((error) => {
                console.error("エラーが発生しました:", error);
            });
    };
    initServiceId();

    const init_agg_route_source = async (service_id) => {
        let time = -1;
        aggregator_routesLayerLines.setSource(
            new ol.source.Vector({
                format: new ol.format.GeoJSON(),
                url: (extent) => {
                    let url =
                        "/geoserver/traffic_info/wfs?" +
                        "service=WFS&" +
                        "version=1.1.0&" +
                        "request=GetFeature&" +
                        "typename=traffic_info:app_aggregator_routes&" +
                        "outputFormat=application/json&" +
                        "srsname=EPSG:3857&" +
                        `CQL_FILTER=file_name='${open_key}' and hour='${time}'`;
                    if (service_id != undefined) url += ` and service_id='${service_id}'`;
                    return url;
                },
                strategy: ol.loadingstrategy.bbox,
            })
        );
        let CQL_FILTER = `file_name='${open_key}' and hour='${time}'`;
        if (service_id != undefined) CQL_FILTER += ` and service_id='${service_id}'`;
        aggregator_routesLayerTexts.setSource(
            new ol.source.TileWMS({
                url: "/geoserver/traffic_info/wms",
                cacheSize: 0,
                params: {
                    FORMAT: "image/png",
                    tiled: true,
                    STYLES: "バス路線集計Frequency",
                    LAYERS: "traffic_info:app_aggregator_routes",
                    exceptions: "application/vnd.ogc.se_blank",
                    CQL_FILTER: CQL_FILTER,
                    tilesOrigin: -180 + "," + -90,
                },
            })
        );

        aggregator_routesLayerLines.setVisible(true);
        aggregator_routesLayerTexts.setVisible(true);
    };

    $("#title_img").on("click", () => {
        window.open("https://www.mlit.go.jp/links/", "_links");
    });
    $("#linklabel_help").on("click", () => {
        window.open("/static/app/usage.pdf", "_usage");
    });
</script>
<style>
    body {
        margin: 0;
    }
    form {
        display: none;
    }
    code {
        font-family: monospace;
        color: #ff1493;
    }
    .ol-layerswitcher .panel li label {
        font-size: 0.75rem;
    }

    #legend_img {
        position: absolute;
        right: 5px;
        top: 50px;
        border: 1px solid #999;
    }
    #route_img_div {
        position: absolute;
        top: 50%;
        bottom: 5px;
        left: 5px;
        background-color: white;
        border: 1px solid #999;
        visibility: hidden;
    }
    .scroll-div {
        overflow: auto;
        padding: 0 8px;
        max-height: 100%;
        height: 212px;
    }
    .routes-table {
        width: 100%;
        white-space: nowrap;
        border-collapse: collapse;
    }
    .routes-table th {
        background-color: #f4f4f4;
        border: 1px solid #ddd;
        padding: 5px;
        text-align: left;
    }
    .routes-table td {
        border: 1px solid #ddd;
        padding: 3px;
        font-size: 0.75rem;
    }
    .routes-table tr:hover {
        background-color: #f08080;
    }

    .ol-panel {
        height: 24vh;
        font-size: 0.8rem;
        background-color: white;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        border: 1px solid #cccccc;
        padding: 8px;
        padding-right: 25px;
        top: 0px;
        bottom: 0px;
        left: auto;
        right: 0px;
        min-width: 250px;
        z-index: 999;
        display: none;
    }
    .info-closer {
        text-decoration: none;
        position: absolute;
        top: 2px;
        right: 8px;
    }
    .info-closer:after {
        content: "✖";
    }

    .ol-popup {
        position: absolute;
        background-color: white;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #cccccc;
        bottom: 12px;
        left: -50px;
        min-width: 300px;
        white-space: nowrap;
    }
    .ol-popup:after,
    .ol-popup:before {
        top: 100%;
        border: solid transparent;
        content: " ";
        height: 0;
        width: 0;
        position: absolute;
        pointer-events: none;
    }

    .ol-popup:after {
        border-top-color: white;
        border-width: 10px;
        left: 48px;
        margin-left: -10px;
    }

    .ol-popup:before {
        border-top-color: #cccccc;
        border-width: 11px;
        left: 48px;
        margin-left: -11px;
    }

    .ol-popup-closer {
        text-decoration: none;
        position: absolute;
        top: 2px;
        right: 8px;
    }

    .ol-popup-closer:after {
        content: "✖";
    }

    #gtfs-button {
        z-index: 999;
        cursor: pointer;
    }

    .gtfs-button-img {
        max-width: 36px;
    }

    .gtfs-panel {
        position: absolute;
        font-size: 0.8rem;
        background-color: white;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        border: 1px solid #cccccc;
        padding: 8px;
        padding-right: 25px;
        top: 30px;
        bottom: 30px;
        left: 30px;
        right: 30px;
        min-width: 250px;
        z-index: 1000;
        display: none;
    }

    .gtfs-closer {
        text-decoration: none;
        position: absolute;
        top: 2px;
        right: 8px;
    }

    .gtfs-closer:after {
        content: "✖";
    }
    #gtfs-date {
        padding: 6px 8px;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    #gtfs-table-wrapper {
        overflow-y: auto;
        margin-top: 10px;
        margin-bottom: 10px;
    }

    #gtfs-table {
        width: 100%;
        border-collapse: collapse;
    }

    #gtfs-table th,
    #gtfs-table td {
        border: 1px solid #ddd;
        padding: 3px;
        text-align: left;
    }

    #gtfs-table th {
        background-color: #f2f2f2;
    }

    #gtfs-table tbody tr:nth-child(even) {
        background-color: #f2f2f2;
    }

    #gtfs-table tbody tr:hover {
        background-color: #ddd;
    }

    #gtfs-repo-download,
    #gtfs-repo-upload {
        padding: 4px 16px;
        font-size: 16px;
        background-color: #007bff;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    #gtfs-repo-download:hover,
    #gtfs-repo-upload:hover {
        background-color: #0056b3;
    }

    #gtfs-table-buttons {
        display: flex;
        justify-content: space-between;
    }

    #gtfs-download {
        padding: 4px 16px;
        font-size: 16px;
        background-color: #28a745;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
        margin-right: 10px;
    }

    #gtfs-download:hover {
        background-color: #218838;
    }

    #gtfs-cancel {
        padding: 4px 16px;
        font-size: 16px;
        background-color: #dc3545;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    #gtfs-cancel:hover {
        background-color: #c82333;
    }

    #load_overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        display: none;
    }

    .loader {
        border: 8px solid #f3f3f3;
        border-radius: 50%;
        border-top: 8px solid #3498db;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        position: absolute;
        top: 50%;
        left: 50%;
        margin-top: -25px;
        margin-left: -25px;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }

    .ol-route-panel {
        height: 24vh;
        font-size: 0.8rem;
        background-color: white;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        border: 1px solid #cccccc;
        padding: 8px;
        padding-right: 25px;
        top: auto;
        bottom: 5px;
        left: 5px;
        right: 200px;
        z-index: 999;
        display: none;
    }
    .info-route-closer {
        text-decoration: none;
        position: absolute;
        top: 2px;
        right: 8px;
    }
    .info-route-closer:after {
        content: "✖";
    }
    #chart_div {
        height: 250px;
    }

    .ol-zoom {
        font-size: 24px;
        border-radius: 8px;
        display: inline-flex;
        flex-direction: column;
        align-items: flex-start;
        box-shadow: 0px 2px 16px 0px rgba(0, 0, 0, 0.12), 0px 1px 2px 0px rgba(0, 0, 0, 0.04);
        position: absolute;
        left: 8px;
        right: unset;
    }

    .ol-zoom-in {
        padding: 2px 10.5px;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
        border-bottom-left-radius: 0px;
        border-bottom-right-radius: 0px;
        background-color: white;
        width: 36px;
        border-bottom: 1px solid #bebebe;
    }

    .ol-zoom-out {
        padding: 2px 10px;
        border-top-left-radius: 0px;
        border-top-right-radius: 0px;
        border-bottom-left-radius: 8px;
        border-bottom-right-radius: 8px;
        background-color: white;
        width: 36px;
    }

    .ol-scale-line {
        left: auto;
        right: 170px;
        bottom: 8px;
    }

    .ol-scale-text {
        white-space: nowrap;
        font-size: 21px;
        width: 131px;
    }

    .overlay_panel {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(213, 213, 213, 0.8);
        display: none;
        z-index: 1000;
    }

    .overlay_panel .outer_div {
        padding: 7px;
        position: absolute;
        top: 4px;
        left: 4px;
        right: 4px;
        bottom: 4px;
        border: 1px solid black;
    }

    #inner_content {
        padding: 7px;
    }

    #inner_content ul {
        list-style: none;
    }

    #overlay_inner {
        background-color: rgba(213, 213, 213, 0.7);
        border: 1px solid #888888;
    }

    #map {
        height: 70vh;
    }

    #layer-switcher-div {
        overflow-y: auto;
        height: 70vh;
    }

    .row {
        margin: 0;
    }

    .ol-layerswitcher .panel li label {
        max-width: none;
    }

    fieldset.fs-border {
        border: 1px solid black;
        border-radius: 5px;
        padding: 0 1.4em 1.4em 1.4em;
        margin: 0 0 1.5em 0 !important;
        -webkit-box-shadow: 0px 0px 0px 0px #000;
        box-shadow: 0px 0px 0px 0px #000;
    }
    fieldset div {
        display: block;
        margin-top: 10px;
    }
    legend.fs-border {
        float: none;
        font-size: 1em;
        width: inherit;
        padding: 0 10px;
        border-bottom: none;
    }

    #service_ids {
        display: none;
        position: absolute;
        background-color: #f8f9fa;
        border: 1px solid black;
        border-radius: 5px;
        margin-top: 3px;
        margin-left: 3.5rem;
        padding: 0 0.5rem 0 0.5rem;
        -webkit-box-shadow: 0px 0px 0px 0px #000;
        box-shadow: 0px 0px 0px 0px #000;
        z-index: 999;
        font-size: small;
    }

    #toggle-btn {
        margin-left: 7px;
    }
    #layer-toggle-btn {
        user-select: none;
        cursor: pointer;
    }
    .cp_active2 {
        background-color: midnightblue;
        color: #ffffff !important;
    }
    .cp_disable2 {
        background-color: #6c757d;
        color: #ffffff !important;
    }

    .ol-layerswitcher .panel li label span {
        display: contents;
    }

    .aggr_stops_settings_panel {
        display: none;
        position: absolute;
        top: 200;
        left: 200;
        background-color: white;
        border: 1px solid black;
        border-radius: 5px;
        padding: 3px;
        font-size: 10px;
        z-index: 999;
    }
    .settings_btn {
        width: 12px;
        height: 12px;
        margin-left: 15px;
        margin-top: 3px;
        cursor: pointer;
    }

    .ol-layerswitcher .panel li > div,
    .ol-layerswitcher-buttons > div {
        display: flex;
        align-items: center;
    }
    .layer_settings_panel {
        position: absolute;
        display: none;
        background-color: white;
        border: 1px solid black;
        border-radius: 5px;
        padding: 3px;
        font-size: 0.7rem;
        z-index: 2;
    }
    .layer_settings_panel h6 {
        font-size: 0.75rem;
    }
    .layer_settings_panel p {
        margin-bottom: 0;
    }
    .direction_div {
        display: flex;
        justify-content: space-evenly;
        align-items: center;
        background-color: white;
        padding: 5px;
    }
    .direction_div td {
        white-space: nowrap;
    }
    .direction_div2 {
    }
    .operation_frequency_table td {
        font-size: 1rem !important;
        vertical-align: middle !important;
    }
    .table-striped > tbody > tr:nth-of-type(odd) > * {
        --bs-table-striped-bg: white;
    }
    .table-striped > tbody > tr:nth-of-type(even) > * {
        background-color: #70ad47;
    }
    #click_info td {
        vertical-align: top;
        font-size: 0.8rem;
    }
    .right_title {
        font-weight: bold;
        background-color: #1a9086;
        color: white;
        padding: 5px;
        text-align: center;
    }
    .advance1a_menu {
        font-size: 0.8rem;
    }
    .zipInfo {
        border: 1px solid black;
        padding: 7px;
        width: 100%;
    }
    .zipInfo td {
        padding: 3px;
        width: 100%;
    }
    .zipInfo th {
        width: 180px;
        padding-top: 3px;
        padding-bottom: 3px;
        padding-right: 3px;
        padding-left: 14px;
        white-space: nowrap;
        text-align: right;
    }
    .form-select-sm {
        padding-top: 0.15rem !important;
        padding-bottom: 0.15rem !important;
        font-size: 0.775rem !important;
    }
    .h5-zipInfo {
        margin-top: 10px;
        display: flex;
        align-items: center;
    }
    .csvClearBtn {
        font-size: 0.7em;
        background-color: #1a9086;
        color: #ffffff;
        border: none;
        user-select: none;
        margin-left: 10px;
        padding: 2px;
        width: 130px;
        height: 26px;
    }
    .gray-colour {
        filter: url(#grayscale-alpha);
    }

    .nav-link:hover {
        color: white;
        background-color: #1a9086;
    }
    .dropdown-item:hover {
        color: white;
        background-color: #13655e;
    }
    #middle_row {
        justify-content: space-evenly;
    }
    .layer_min_btn {
        height: 23px;
        font-size: 0.75em;
        padding: 0px 3px;
    }
    .offcanvas {
        --bs-offcanvas-width: 330px;
    }
    .offcanvas-backdrop.show {
        opacity: 0.2;
    }
    .layer_allonoff {
        width: 44px;
        height: 23px;
        font-size: 0.75em;
    }
    .stop-name {
        cursor: pointer;
    }
    .advance2_stop-name {
        cursor: pointer;
    }
    #info {
        position: absolute;
        display: inline-block;
        height: auto;
        width: auto;
        z-index: 100;
        background-color: #333;
        color: #fff;
        text-align: center;
        border-radius: 4px;
        padding: 5px;
        left: 50%;
        transform: translateX(3%);
        visibility: hidden;
        pointer-events: none;
    }
    #title_img {
        cursor: pointer;
        user-select: none;
    }
</style>
